const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/stdio-ZKXAJGR6-Dd4k1mfX.js","assets/index-B9xgKKTO.js","assets/index-Br5Lp-nB.css","assets/langfuse-U2OEF7K7-Bke0aacP.js","assets/index-DtYddBwZ.js","assets/index-D8-Z6Ssp.js","assets/embeddings-CxF6I3vU.js","assets/llms-DYitwP9m.js"])))=>i.map(i=>d[i]);
import{E as ye,t as c,F as Ce,H as xe,I as K,J as we,K as u,L as Se,u as W,M as Ee,N as Me,O as H,P as z}from"./index-B9xgKKTO.js";import{J as Te}from"./langfuse-U2OEF7K7-Bke0aacP.js";var S,Oe=(S=class extends ye{mcpClient;_tools;constructor(t){super(),this.mcpClient=t,this.connected=!0,this._tools=this._createToolsList()}async connect(){this.connected=!0}async disconnect(){this.connected=!1}get publicIdentifier(){return{name:"code_mode",version:"1.0.0"}}_createToolsList(){return[{name:"execute_code",description:"Execute JavaScript/TypeScript code with access to MCP tools. This is the PRIMARY way to interact with MCP servers in code mode. Write code that discovers tools using search_tools(), calls tools as async functions (e.g., await github.get_pull_request(...)), processes data efficiently, and returns results. Use 'await' for async operations and 'return' to return values. Available in code: search_tools(), __tool_namespaces, and server.tool_name() functions.",inputSchema:{type:"object",properties:{code:{type:"string",description:"JavaScript/TypeScript code to execute. Use 'await' for async operations. Use 'return' to return a value. Available: search_tools(), server.tool_name(), __tool_namespaces"},timeout:{type:"number",description:"Execution timeout in milliseconds",default:3e4}},required:["code"]}},{name:"search_tools",description:"Search and discover available MCP tools across all servers. Use this to find out what tools are available before writing code. Returns tool information including names, descriptions, and schemas. Can filter by query and control detail level.",inputSchema:{type:"object",properties:{query:{type:"string",description:"Search query to filter tools by name or description",default:""},detail_level:{type:"string",description:"Detail level: 'names', 'descriptions', or 'full'",enum:["names","descriptions","full"],default:"full"}}}}]}get tools(){return this._tools}async initialize(){return this.toolsCache=this._tools,{capabilities:{},version:"1.0.0"}}async callTool(t,e){if(t==="execute_code"){const o=e.code,n=e.timeout||3e4,s=await this.mcpClient.executeCode(o,n);return{content:[{type:"text",text:JSON.stringify(s)}]}}else if(t==="search_tools"){const o=e.query||"",n=e.detail_level,s=await this.mcpClient.searchTools(o,n&&n in["names","descriptions","full"]?n:"full");return{content:[{type:"text",text:JSON.stringify(s)}]}}throw new Error(`Unknown tool: ${t}`)}},c(S,"CodeModeConnector"),S);function Y(){throw new Error("fs.readFileSync is not available in browser environment")}function Z(){throw new Error("fs.writeFileSync is not available in browser environment")}function G(){return!1}function X(){throw new Error("fs.readFile is not available in browser environment")}function Q(){throw new Error("fs.writeFile is not available in browser environment")}function ee(){throw new Error("fs.mkdir is not available in browser environment")}function te(){throw new Error("fs.readdir is not available in browser environment")}function oe(){throw new Error("fs.stat is not available in browser environment")}function ne(){throw new Error("fs.unlink is not available in browser environment")}function se(){throw new Error("fs.rmdir is not available in browser environment")}const N={readFileSync:Y,writeFileSync:Z,existsSync:G,readFile:X,writeFile:Q,mkdir:ee,readdir:te,stat:oe,unlink:ne,rmdir:se},Le=Object.freeze(Object.defineProperty({__proto__:null,default:N,existsSync:G,mkdir:ee,readFile:X,readFileSync:Y,readdir:te,rmdir:se,stat:oe,unlink:ne,writeFile:Q,writeFileSync:Z},Symbol.toStringTag,{value:"Module"}));function F(...r){return r.filter(Boolean).join("/").replace(/\/+/g,"/").replace(/\/$/,"")}function re(...r){return F(...r)}function q(r){const t=r.split("/");return t.pop(),t.join("/")||"/"}function P(r,t){const e=r.split("/");let o=e[e.length-1]||"";return t&&o.endsWith(t)&&(o=o.slice(0,-t.length)),o}function D(r){const t=P(r),e=t.lastIndexOf(".");return e>0?t.slice(e):""}function ie(r){return r.replace(/\/+/g,"/")}function ae(r){return r.startsWith("/")}function ce(r){const t=r.startsWith("/")?"/":"",e=q(r),o=P(r),n=D(r),s=n?o.slice(0,-n.length):o;return{root:t,dir:e,base:o,ext:n,name:s}}const le="/",ue=":",de={join:F,resolve:re,dirname:q,basename:P,extname:D,normalize:ie,isAbsolute:ae,parse:ce,sep:le,delimiter:ue},je=Object.freeze(Object.defineProperty({__proto__:null,basename:P,default:de,delimiter:ue,dirname:q,extname:D,isAbsolute:ae,join:F,normalize:ie,parse:ce,resolve:re,sep:le},Symbol.toStringTag,{value:"Module"}));var ke={},E,A=(E=class{client;_connecting=!1;constructor(t){this.client=t}async ensureServersConnected(){const t=this.client.getServerNames(),e=Object.keys(this.client.getAllActiveSessions()),o=t.filter(n=>!e.includes(n));if(o.length>0&&!this._connecting){this._connecting=!0;try{u.debug(`Connecting to configured servers for code execution: ${o.join(", ")}`),await this.client.createAllSessions()}finally{this._connecting=!1}}else if(o.length>0&&this._connecting){u.debug("Waiting for ongoing server connection...");const n=Date.now();for(;this._connecting&&Date.now()-n<5e3;)await new Promise(s=>setTimeout(s,100))}}getToolNamespaces(){const t=[],e=this.client.getAllActiveSessions();for(const[o,n]of Object.entries(e))if(o!=="code_mode")try{const s=n.connector;let i;try{i=s.tools}catch(a){u.warn(`Tools not available for server ${o}: ${a}`);continue}if(!i||i.length===0)continue;t.push({serverName:o,tools:i,session:n})}catch(s){u.warn(`Failed to load tools for server ${o}: ${s}`)}return t}createSearchToolsFunction(){return async(t="",e="full")=>{const o=[],n=new Set,s=t.toLowerCase(),i=this.client.getAllActiveSessions();for(const[l,d]of Object.entries(i))if(l!=="code_mode")try{const m=d.connector.tools;m&&m.length>0&&n.add(l);for(const f of m)e==="names"?o.push({name:f.name,server:l}):e==="descriptions"?o.push({name:f.name,server:l,description:f.description}):o.push({name:f.name,server:l,description:f.description,input_schema:f.inputSchema})}catch(m){u.warn(`Failed to search tools in server ${l}: ${m}`)}let a=o;return t&&(a=o.filter(l=>{const d=l.name.toLowerCase().includes(s),m=l.description?.toLowerCase().includes(s),f=l.server.toLowerCase().includes(s);return d||m||f})),{meta:{total_tools:o.length,namespaces:Array.from(n).sort(),result_count:a.length},results:a}}}},c(E,"BaseCodeExecutor"),E),M,I=(M=class extends A{e2bApiKey;codeExecSandbox=null;SandboxClass=null;timeoutMs;constructor(t,e){super(t),this.e2bApiKey=e.apiKey,this.timeoutMs=e.timeoutMs??3e5}async ensureSandboxClass(){if(!this.SandboxClass)try{const t=await W(()=>import("@e2b/code-interpreter"),[]);this.SandboxClass=t.Sandbox}catch{throw new Error("@e2b/code-interpreter is not installed. The E2B code executor requires this optional dependency. Install it with: yarn add @e2b/code-interpreter")}}async getOrCreateCodeExecSandbox(){return this.codeExecSandbox?this.codeExecSandbox:(await this.ensureSandboxClass(),u.debug("Starting E2B sandbox for code execution..."),this.codeExecSandbox=await this.SandboxClass.create("base",{apiKey:this.e2bApiKey,timeoutMs:this.timeoutMs}),this.codeExecSandbox)}generateShim(t){let e=`
// MCP Bridge Shim
global.__callMcpTool = async (server, tool, args) => {
    const id = Math.random().toString(36).substring(7);
    console.log(JSON.stringify({
        type: '__MCP_TOOL_CALL__',
        id,
        server,
        tool,
        args
    }));
    
    const resultPath = \`/tmp/mcp_result_\${id}.json\`;
    const fs = require('fs');
    
    // Poll for result file
    let attempts = 0;
    while (attempts < 300) { // 30 seconds timeout
        if (fs.existsSync(resultPath)) {
            const content = fs.readFileSync(resultPath, 'utf8');
            const result = JSON.parse(content);
            fs.unlinkSync(resultPath); // Clean up
            
            if (result.error) {
                throw new Error(result.error);
            }
            return result.data;
        }
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }
    throw new Error('Tool execution timed out');
};

// Global search_tools helper
global.search_tools = async (query, detailLevel = 'full') => {
    const allTools = ${JSON.stringify(Object.entries(t).flatMap(([o,n])=>n.map(s=>({name:s.name,description:s.description,server:o,input_schema:s.inputSchema}))))};
    
    const filtered = allTools.filter(tool => {
        if (!query) return true;
        const q = query.toLowerCase();
        return tool.name.toLowerCase().includes(q) || 
               (tool.description && tool.description.toLowerCase().includes(q));
    });
    
    if (detailLevel === 'names') {
        return filtered.map(t => ({ name: t.name, server: t.server }));
    } else if (detailLevel === 'descriptions') {
        return filtered.map(t => ({ name: t.name, server: t.server, description: t.description }));
    }
    return filtered;
};
`;for(const[o,n]of Object.entries(t)){if(!n||n.length===0)continue;const s=o.replace(/[^a-zA-Z0-9_]/g,"_");e+=`
global['${o}'] = {`;for(const i of n)e+=`
    '${i.name}': async (args) => await global.__callMcpTool('${o}', '${i.name}', args),`;e+=`
};

// Also expose as safe name if different
if ('${s}' !== '${o}') {
    global['${s}'] = global['${o}'];
}
`}return e}buildToolCatalog(){const t={},e=this.getToolNamespaces();for(const{serverName:o,tools:n}of e)t[o]=n;return t}async execute(t,e=3e4){const o=Date.now();let n=null,s=null,i=[];try{await this.ensureServersConnected();const a=await this.getOrCreateCodeExecSandbox(),l=this.buildToolCatalog(),m=`
${this.generateShim(l)}

(async () => {
    try {
        const func = async () => {
            ${t}
        };
        const result = await func();
        console.log('__MCP_RESULT_START__');
        console.log(JSON.stringify(result));
        console.log('__MCP_RESULT_END__');
    } catch (e) {
        console.error(e);
        process.exit(1);
    }
})();
`,f=`exec_${Date.now()}.js`;await a.files.write(f,m);const g=await a.commands.run(`node ${f}`,{timeoutMs:e,onStdout:c(async _=>{try{const p=_.split(`
`);for(const O of p)if(O.trim().startsWith('{"type":"__MCP_TOOL_CALL__"')){const h=JSON.parse(O);if(h.type==="__MCP_TOOL_CALL__")try{u.debug(`[E2B Bridge] Calling tool ${h.server}.${h.tool}`);const x=this.client.getAllActiveSessions()[h.server];if(!x)throw new Error(`Server ${h.server} not found`);const w=await x.connector.callTool(h.tool,h.args);let b=w;if(w.content&&w.content.length>0){const k=w.content[0];if(k.type==="text")try{b=JSON.parse(k.text)}catch{b=k.text}else b=k}const $=`/tmp/mcp_result_${h.id}.json`;await a.files.write($,JSON.stringify({data:b}))}catch(C){u.error(`[E2B Bridge] Tool execution failed: ${C.message}`);const x=`/tmp/mcp_result_${h.id}.json`;await a.files.write(x,JSON.stringify({error:C.message||String(C)}))}}}catch{}},"onStdout")});if(i=[g.stdout,g.stderr].filter(Boolean),g.exitCode!==0)s=g.stderr||"Execution failed";else{const _=g.stdout,p="__MCP_RESULT_START__",O="__MCP_RESULT_END__",h=_.indexOf(p),C=_.indexOf(O);if(h!==-1&&C!==-1){const x=_.substring(h+p.length,C).trim();try{n=JSON.parse(x)}catch{n=x}i=i.map(w=>{let b=w.replace(new RegExp(p+"[\\s\\S]*?"+O),"[Result captured]");return b=b.split(`
`).filter($=>!$.includes("__MCP_TOOL_CALL__")).join(`
`),b})}}}catch(a){s=a.message||String(a),s&&(s.includes("timeout")||s.includes("timed out"))&&(s="Script execution timed out")}return{result:n,logs:i,error:s,execution_time:(Date.now()-o)/1e3}}async cleanup(){if(this.codeExecSandbox)try{await this.codeExecSandbox.kill(),this.codeExecSandbox=null,u.debug("E2B code execution sandbox stopped")}catch(t){u.error("Failed to stop E2B code execution sandbox:",t)}}},c(M,"E2BCodeExecutor"),M),v=null,R=!1;function J(){return["node","vm"].join(":")}c(J,"getVMModuleName");function L(){if(R)return v!==null;R=!0;try{const r=typeof z<"u"?z:null;if(r)return v=r(J()),!0}catch{u.debug("node:vm module not available via require")}return!1}c(L,"tryLoadVM");async function fe(){if(v!==null||!R&&L())return!0;try{return v=await import(J()),!0}catch{return u.debug("node:vm module not available in this environment (e.g., Deno)"),!1}}c(fe,"tryLoadVMAsync");function me(){return L(),v!==null}c(me,"isVMAvailable");var T,B=(T=class extends A{defaultTimeout;memoryLimitMb;constructor(t,e){super(t),this.defaultTimeout=e?.timeoutMs??3e4,this.memoryLimitMb=e?.memoryLimitMb,L()}async ensureVMLoaded(){if(v!==null)return;if(!await fe())throw new Error("node:vm module is not available in this environment. Please use E2B executor instead or run in a Node.js environment.")}async execute(t,e){const o=e??this.defaultTimeout;await this.ensureVMLoaded(),await this.ensureServersConnected();const n=[],s=Date.now();let i=null,a=null;try{const d=await this._buildContext(n),m=`
        (async () => {
          try {
            ${t}
          } catch (e) {
            throw e;
          }
        })()
      `;i=await new v.Script(m,{filename:"agent_code.js"}).runInNewContext(d,{timeout:o,displayErrors:!0})}catch(d){a=d.message||String(d),(d.code==="ERR_SCRIPT_EXECUTION_TIMEOUT"||d.message==="Script execution timed out."||typeof a=="string"&&(a.includes("timed out")||a.includes("timeout")))&&(a="Script execution timed out"),d.stack&&u.debug(`Code execution error stack: ${d.stack}`)}const l=(Date.now()-s)/1e3;return{result:i,logs:n,error:a,execution_time:l}}async _buildContext(t){const e=c((...i)=>{t.push(i.map(a=>typeof a=="object"?JSON.stringify(a,null,2):String(a)).join(" "))},"logHandler"),o={console:{log:e,error:c((...i)=>{e("[ERROR]",...i)},"error"),warn:c((...i)=>{e("[WARN]",...i)},"warn"),info:e,debug:e},Object,Array,String,Number,Boolean,Date,Math,JSON,RegExp,Map,Set,Promise,parseInt,parseFloat,isNaN,isFinite,encodeURI,decodeURI,encodeURIComponent,decodeURIComponent,setTimeout,clearTimeout,search_tools:this.createSearchToolsFunction(),__tool_namespaces:[]},n={},s=this.getToolNamespaces();for(const{serverName:i,tools:a,session:l}of s){const d={};for(const m of a){const f=m.name;d[f]=async g=>{const _=await l.connector.callTool(f,g||{});if(_.content&&_.content.length>0){const p=_.content[0];if(p.type==="text")try{return JSON.parse(p.text)}catch{return p.text}return p}return _}}o[i]=d,n[i]=!0}return o.__tool_namespaces=Object.keys(n),v.createContext(o)}async cleanup(){}},c(T,"VMCodeExecutor"),T);function V(r){return"requestedSchema"in r&&r.requestedSchema!=null}c(V,"hasRequestedSchema");function j(r){const t={};if(!V(r))return t;const o=r.requestedSchema.properties??{};for(const[n,s]of Object.entries(o)){const i=s;if("default"in i){const a=i.default;(typeof a=="string"||typeof a=="number"||typeof a=="boolean"||Array.isArray(a)&&a.every(l=>typeof l=="string"))&&(t[n]=a)}}return t}c(j,"getDefaults");function he(r,t){const e=j(r);return t==null?e:{...e,...t}}c(he,"applyDefaults");function pe(r){return{action:"accept",content:j(r)}}c(pe,"acceptWithDefaults");function _e(r){return{action:"accept",content:r}}c(_e,"accept");function U(r){return{action:"decline"}}c(U,"decline");function ge(){return{action:"cancel"}}c(ge,"cancel");function be(r){return U()}c(be,"reject");function ve(r,t){if(!V(r))return{valid:!0};try{const o=Te.convert(r.requestedSchema).safeParse(t);return o.success?{valid:!0}:{valid:!1,errors:o.error.issues.map(s=>s.path.length>0?`${s.path.join(".")}: ${s.message}`:s.message)}}catch{return{valid:!1,errors:["Unsupported or invalid schema"]}}}c(ve,"validate");var y,Ne=(y=class extends Ce{static getPackageVersion(){return xe()}codeMode=!1;_codeExecutor=null;_customCodeExecutor=null;_codeExecutorConfig="vm";_executorOptions;_globalCallbacks;constructor(t,e){t?typeof t=="string"?super(K(t)):super(t):super();let o=!1,n="vm",s;e?.codeMode&&(typeof e.codeMode=="boolean"?o=e.codeMode:(o=e.codeMode.enabled,n=e.codeMode.executor??"vm",s=e.codeMode.executorOptions)),this.codeMode=o,this._codeExecutorConfig=n,this._executorOptions=s;const i=this.config;this._globalCallbacks={onSampling:e?.onSampling??e?.samplingCallback??i?.onSampling??i?.samplingCallback,samplingCallback:e?.samplingCallback??i?.samplingCallback,onElicitation:e?.onElicitation??e?.elicitationCallback??i?.onElicitation??i?.elicitationCallback,elicitationCallback:e?.elicitationCallback??i?.elicitationCallback,onNotification:e?.onNotification??i?.onNotification},e?.samplingCallback&&!e?.onSampling&&console.warn('[MCPClient] The "samplingCallback" option is deprecated. Use "onSampling" instead.'),e?.elicitationCallback&&!e?.onElicitation&&console.warn('[MCPClient] The "elicitationCallback" option is deprecated. Use "onElicitation" instead.'),this.codeMode&&this._setupCodeModeConnector(),this._trackClientInit()}_trackClientInit(){const t=Object.keys(this.config.mcpServers??{}),e=!!(this._globalCallbacks.onSampling??this._globalCallbacks.samplingCallback),o=!!(this._globalCallbacks.onElicitation??this._globalCallbacks.elicitationCallback);we.getInstance().trackMCPClientInit({codeMode:this.codeMode,sandbox:!1,allCallbacks:e&&o,verify:!1,servers:t,numServers:t.length,isBrowser:!1}).catch(n=>u.debug(`Failed to track MCPClient init: ${n}`))}static fromDict(t,e){return new y(t,e)}static fromConfigFile(t,e){return new y(K(t),e)}saveConfig(t){const e=de.dirname(t);N.existsSync(e)||N.mkdirSync(e,{recursive:!0}),N.writeFileSync(t,JSON.stringify(this.config,null,2),"utf-8")}async createConnectorFromConfig(t){const e=Se(t,this._globalCallbacks),o={...t,clientInfo:t.clientInfo??this.config.clientInfo};if("command"in o&&"args"in o){const{StdioConnector:n}=await W(async()=>{const{StdioConnector:i}=await import("./stdio-ZKXAJGR6-Dd4k1mfX.js");return{StdioConnector:i}},__vite__mapDeps([0,1,2,3,4,5,6,7])),s=o;return new n({command:s.command,args:s.args,env:s.env,clientInfo:Ee(o.clientInfo),onSampling:e.onSampling,onElicitation:e.onElicitation,onNotification:e.onNotification})}return Me(o,{onSampling:e.onSampling,onElicitation:e.onElicitation,onNotification:e.onNotification})}_setupCodeModeConnector(){u.debug("Code mode connector initialized as internal meta server");const t=new Oe(this),e=new H(t);this.sessions.code_mode=e,this.activeSessions.push("code_mode")}_ensureCodeExecutor(){if(!this._codeExecutor){const t=this._codeExecutorConfig;if(t instanceof A)this._codeExecutor=t;else{if(typeof t=="function")throw this._customCodeExecutor=t,new Error("Custom executor function should be handled in executeCode");if(t==="e2b"){const e=this._executorOptions;if(e?.apiKey)this._codeExecutor=new I(this,e);else{u.warn("E2B executor requires apiKey. Falling back to VM.");try{this._codeExecutor=new B(this,this._executorOptions)}catch{throw new Error("VM executor is not available in this environment and E2B API key is not provided. Please provide an E2B API key or run in a Node.js environment.")}}}else try{this._codeExecutor=new B(this,this._executorOptions)}catch{const o=this._executorOptions,n=o?.apiKey||ke.E2B_API_KEY;if(n)u.info("VM executor not available in this environment. Falling back to E2B."),this._codeExecutor=new I(this,{...o,apiKey:n});else throw new Error("VM executor is not available in this environment. Please provide an E2B API key via executorOptions or E2B_API_KEY environment variable, or run in a Node.js environment.")}}}return this._codeExecutor}async executeCode(t,e){if(!this.codeMode)throw new Error("Code execution mode is not enabled");return this._customCodeExecutor?this._customCodeExecutor(t,e):this._ensureCodeExecutor().execute(t,e)}async searchTools(t="",e="full"){if(!this.codeMode)throw new Error("Code execution mode is not enabled");return this._ensureCodeExecutor().createSearchToolsFunction()(t,e)}getServerNames(){const t=this.codeMode;return super.getServerNames().filter(e=>!t||e!=="code_mode")}async close(){this._codeExecutor&&(await this._codeExecutor.cleanup(),this._codeExecutor=null),await this.closeAllSessions()}},c(y,"MCPClient"),y);const $e=Object.freeze(Object.defineProperty({__proto__:null,BaseCodeExecutor:A,E2BCodeExecutor:I,MCPClient:Ne,MCPSession:H,VMCodeExecutor:B,accept:_e,acceptWithDefaults:pe,applyDefaults:he,cancel:ge,decline:U,getDefaults:j,isVMAvailable:me,reject:be,validate:ve},Symbol.toStringTag,{value:"Module"}));export{$e as c,Le as f,je as p};
