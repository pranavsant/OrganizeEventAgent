import{X as Zs,be as Za,bf as x,bg as Ja,ad as Ha,ac as Va,Q as Me,bh as Xa,a1 as R,b as et,aw as Ga,aJ as Ya,a2 as Qa,Z as Js,$ as Hs,U as Ce,l as bt,bi as ei,W as vn,bj as rs,bk as ti,bl as ni,bm as si,a0 as as,bn as is,bo as ri,y as ai,V as sn,G as ii,b2 as Z,b8 as xn,ba as te,bc as Vs,bb as W,b3 as Mt,b9 as Q,bp as oi,p as ui,A as li,a as ci}from"./index-B9xgKKTO.js";import{c as pi,j as di,h as hi,f as Xs,S as os,J as us,R as ls,k as fi}from"./index-D8-Z6Ssp.js";import{J as cs,c as mi,p as Gs,m as lt,B as gi}from"./llms-DYitwP9m.js";import{c as rn,E as _i}from"./embeddings-CxF6I3vU.js";import{T as yi,t as zt,D as wi}from"./index-DtYddBwZ.js";function tt(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://docs.langchain.com/oss/javascript/langchain/errors/${t}/
`,e}function O(e,t,n,s,r){if(typeof t=="function"?e!==t||!0:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t.set(e,n),n}function p(e,t,n,s){if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?s:n==="a"?s.call(e):s?s.value:t.get(e)}let Ys=function(){const{crypto:e}=globalThis;if(e?.randomUUID)return Ys=e.randomUUID.bind(e),e.randomUUID();const t=new Uint8Array(1),n=e?()=>e.getRandomValues(t)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,s=>(+s^n()&15>>+s/4).toString(16))};function an(e){return typeof e=="object"&&e!==null&&("name"in e&&e.name==="AbortError"||"message"in e&&String(e.message).includes("FetchRequestCanceledException"))}const on=e=>{if(e instanceof Error)return e;if(typeof e=="object"&&e!==null){try{if(Object.prototype.toString.call(e)==="[object Error]"){const t=new Error(e.message,e.cause?{cause:e.cause}:{});return e.stack&&(t.stack=e.stack),e.cause&&!t.cause&&(t.cause=e.cause),e.name&&(t.name=e.name),t}}catch{}try{return new Error(JSON.stringify(e))}catch{}}return new Error(e)};class A extends Error{}class q extends A{constructor(t,n,s,r){super(`${q.makeMessage(t,n,s)}`),this.status=t,this.headers=r,this.requestID=r?.get("x-request-id"),this.error=n;const a=n;this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(t,n,s){const r=n?.message?typeof n.message=="string"?n.message:JSON.stringify(n.message):n?JSON.stringify(n):s;return t&&r?`${t} ${r}`:t?`${t} status code (no body)`:r||"(no status code or body)"}static generate(t,n,s,r){if(!t||!r)return new Ut({message:s,cause:on(n)});const a=n?.error;return t===400?new Qs(t,a,s,r):t===401?new er(t,a,s,r):t===403?new tr(t,a,s,r):t===404?new nr(t,a,s,r):t===409?new sr(t,a,s,r):t===422?new rr(t,a,s,r):t===429?new ar(t,a,s,r):t>=500?new ir(t,a,s,r):new q(t,a,s,r)}}class ee extends q{constructor({message:t}={}){super(void 0,void 0,t||"Request was aborted.",void 0)}}class Ut extends q{constructor({message:t,cause:n}){super(void 0,void 0,t||"Connection error.",void 0),n&&(this.cause=n)}}class Lt extends Ut{constructor({message:t}={}){super({message:t??"Request timed out."})}}class Qs extends q{}class er extends q{}class tr extends q{}class nr extends q{}class sr extends q{}class rr extends q{}class ar extends q{}class ir extends q{}class or extends A{constructor(){super("Could not parse response content as the length limit was reached")}}class ur extends A{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class ze extends Error{constructor(t){super(t)}}const bi=/^[a-z][a-z0-9+.-]*:/i,Ai=e=>bi.test(e);let V=e=>(V=Array.isArray,V(e)),ps=V;function lr(e){return typeof e!="object"?{}:e??{}}function Ii(e){if(!e)return!0;for(const t in e)return!1;return!0}function Oi(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function ct(e){return e!=null&&typeof e=="object"&&!Array.isArray(e)}const vi=(e,t)=>{if(typeof t!="number"||!Number.isInteger(t))throw new A(`${e} must be an integer`);if(t<0)throw new A(`${e} must be a positive integer`);return t},xi=e=>{try{return JSON.parse(e)}catch{return}},Ve=e=>new Promise(t=>setTimeout(t,e)),ve="6.17.0",ki=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function Ti(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const Ci=()=>{const e=Ti();if(e==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ve,"X-Stainless-OS":hs(Deno.build.os),"X-Stainless-Arch":ds(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ve,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(e==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ve,"X-Stainless-OS":hs(globalThis.process.platform??"unknown"),"X-Stainless-Arch":ds(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const t=Si();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ve,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":ve,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Si(){if(typeof navigator>"u"||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const s=n.exec(navigator.userAgent);if(s){const r=s[1]||0,a=s[2]||0,i=s[3]||0;return{browser:t,version:`${r}.${a}.${i}`}}}return null}const ds=e=>e==="x32"?"x32":e==="x86_64"||e==="x64"?"x64":e==="arm"?"arm":e==="aarch64"||e==="arm64"?"arm64":e?`other:${e}`:"unknown",hs=e=>(e=e.toLowerCase(),e.includes("ios")?"iOS":e==="android"?"Android":e==="darwin"?"MacOS":e==="win32"?"Windows":e==="freebsd"?"FreeBSD":e==="openbsd"?"OpenBSD":e==="linux"?"Linux":e?`Other:${e}`:"Unknown");let fs;const Pi=()=>fs??(fs=Ci());function Ri(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function cr(...e){const t=globalThis.ReadableStream;if(typeof t>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function pr(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return cr({start(){},async pull(n){const{done:s,value:r}=await t.next();s?n.close():n.enqueue(r)},async cancel(){await t.return?.()}})}function dr(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const n=await t.read();return n?.done&&t.releaseLock(),n}catch(n){throw t.releaseLock(),n}},async return(){const n=t.cancel();return t.releaseLock(),await n,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function Ei(e){if(e===null||typeof e!="object")return;if(e[Symbol.asyncIterator]){await e[Symbol.asyncIterator]().return?.();return}const t=e.getReader(),n=t.cancel();t.releaseLock(),await n}const $i=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)}),hr="RFC3986",fr=e=>String(e),ms={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:fr},Ni="RFC1738";let un=(e,t)=>(un=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),un(e,t));const ae=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),Vt=1024,Mi=(e,t,n,s,r)=>{if(e.length===0)return e;let a=e;if(typeof e=="symbol"?a=Symbol.prototype.toString.call(e):typeof e!="string"&&(a=String(e)),n==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let i="";for(let o=0;o<a.length;o+=Vt){const l=a.length>=Vt?a.slice(o,o+Vt):a,u=[];for(let m=0;m<l.length;++m){let d=l.charCodeAt(m);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||r===Ni&&(d===40||d===41)){u[u.length]=l.charAt(m);continue}if(d<128){u[u.length]=ae[d];continue}if(d<2048){u[u.length]=ae[192|d>>6]+ae[128|d&63];continue}if(d<55296||d>=57344){u[u.length]=ae[224|d>>12]+ae[128|d>>6&63]+ae[128|d&63];continue}m+=1,d=65536+((d&1023)<<10|l.charCodeAt(m)&1023),u[u.length]=ae[240|d>>18]+ae[128|d>>12&63]+ae[128|d>>6&63]+ae[128|d&63]}i+=u.join("")}return i};function zi(e){return!e||typeof e!="object"?!1:!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))}function gs(e,t){if(V(e)){const n=[];for(let s=0;s<e.length;s+=1)n.push(t(e[s]));return n}return t(e)}const mr={brackets(e){return String(e)+"[]"},comma:"comma",indices(e,t){return String(e)+"["+t+"]"},repeat(e){return String(e)}},gr=function(e,t){Array.prototype.push.apply(e,V(t)?t:[t])};let _s;const U={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:Mi,encodeValuesOnly:!1,format:hr,formatter:fr,indices:!1,serializeDate(e){return(_s??(_s=Function.prototype.call.bind(Date.prototype.toISOString)))(e)},skipNulls:!1,strictNullHandling:!1};function Ui(e){return typeof e=="string"||typeof e=="number"||typeof e=="boolean"||typeof e=="symbol"||typeof e=="bigint"}const Xt={};function _r(e,t,n,s,r,a,i,o,l,u,m,d,f,c,w,b,C,h){let g=e,k=h,S=0,J=!1;for(;(k=k.get(Xt))!==void 0&&!J;){const $=k.get(e);if(S+=1,typeof $<"u"){if($===S)throw new RangeError("Cyclic object value");J=!0}typeof k.get(Xt)>"u"&&(S=0)}if(typeof u=="function"?g=u(t,g):g instanceof Date?g=f?.(g):n==="comma"&&V(g)&&(g=gs(g,function($){return $ instanceof Date?f?.($):$})),g===null){if(a)return l&&!b?l(t,U.encoder,C,"key",c):t;g=""}if(Ui(g)||zi(g)){if(l){const $=b?t:l(t,U.encoder,C,"key",c);return[w?.($)+"="+w?.(l(g,U.encoder,C,"value",c))]}return[w?.(t)+"="+w?.(String(g))]}const L=[];if(typeof g>"u")return L;let E;if(n==="comma"&&V(g))b&&l&&(g=gs(g,l)),E=[{value:g.length>0?g.join(",")||null:void 0}];else if(V(u))E=u;else{const $=Object.keys(g);E=m?$.sort(m):$}const B=o?String(t).replace(/\./g,"%2E"):String(t),D=s&&V(g)&&g.length===1?B+"[]":B;if(r&&V(g)&&g.length===0)return D+"[]";for(let $=0;$<E.length;++$){const M=E[$],ns=typeof M=="object"&&typeof M.value<"u"?M.value:g[M];if(i&&ns===null)continue;const Ht=d&&o?M.replace(/\./g,"%2E"):M,Wa=V(g)?typeof n=="function"?n(D,Ht):D:D+(d?"."+Ht:"["+Ht+"]");h.set(e,S);const ss=new WeakMap;ss.set(Xt,h),gr(L,_r(ns,Wa,n,s,r,a,i,o,n==="comma"&&b&&V(g)?null:l,u,m,d,f,c,w,b,C,ss))}return L}function Li(e=U){if(typeof e.allowEmptyArrays<"u"&&typeof e.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof e.encodeDotInKeys<"u"&&typeof e.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(e.encoder!==null&&typeof e.encoder<"u"&&typeof e.encoder!="function")throw new TypeError("Encoder has to be a function.");const t=e.charset||U.charset;if(typeof e.charset<"u"&&e.charset!=="utf-8"&&e.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=hr;if(typeof e.format<"u"){if(!un(ms,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const s=ms[n];let r=U.filter;(typeof e.filter=="function"||V(e.filter))&&(r=e.filter);let a;if(e.arrayFormat&&e.arrayFormat in mr?a=e.arrayFormat:"indices"in e?a=e.indices?"indices":"repeat":a=U.arrayFormat,"commaRoundTrip"in e&&typeof e.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=typeof e.allowDots>"u"?e.encodeDotInKeys?!0:U.allowDots:!!e.allowDots;return{addQueryPrefix:typeof e.addQueryPrefix=="boolean"?e.addQueryPrefix:U.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof e.allowEmptyArrays=="boolean"?!!e.allowEmptyArrays:U.allowEmptyArrays,arrayFormat:a,charset:t,charsetSentinel:typeof e.charsetSentinel=="boolean"?e.charsetSentinel:U.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:typeof e.delimiter>"u"?U.delimiter:e.delimiter,encode:typeof e.encode=="boolean"?e.encode:U.encode,encodeDotInKeys:typeof e.encodeDotInKeys=="boolean"?e.encodeDotInKeys:U.encodeDotInKeys,encoder:typeof e.encoder=="function"?e.encoder:U.encoder,encodeValuesOnly:typeof e.encodeValuesOnly=="boolean"?e.encodeValuesOnly:U.encodeValuesOnly,filter:r,format:n,formatter:s,serializeDate:typeof e.serializeDate=="function"?e.serializeDate:U.serializeDate,skipNulls:typeof e.skipNulls=="boolean"?e.skipNulls:U.skipNulls,sort:typeof e.sort=="function"?e.sort:null,strictNullHandling:typeof e.strictNullHandling=="boolean"?e.strictNullHandling:U.strictNullHandling}}function Di(e,t={}){let n=e;const s=Li(t);let r,a;typeof s.filter=="function"?(a=s.filter,n=a("",n)):V(s.filter)&&(a=s.filter,r=a);const i=[];if(typeof n!="object"||n===null)return"";const o=mr[s.arrayFormat],l=o==="comma"&&s.commaRoundTrip;r||(r=Object.keys(n)),s.sort&&r.sort(s.sort);const u=new WeakMap;for(let f=0;f<r.length;++f){const c=r[f];s.skipNulls&&n[c]===null||gr(i,_r(n[c],c,o,l,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,u))}const m=i.join(s.delimiter);let d=s.addQueryPrefix===!0?"?":"";return s.charsetSentinel&&(s.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),m.length>0?d+m:""}function ji(e){let t=0;for(const r of e)t+=r.length;const n=new Uint8Array(t);let s=0;for(const r of e)n.set(r,s),s+=r.length;return n}let ys;function kn(e){let t;return(ys??(t=new globalThis.TextEncoder,ys=t.encode.bind(t)))(e)}let ws;function bs(e){let t;return(ws??(t=new globalThis.TextDecoder,ws=t.decode.bind(t)))(e)}var X,G;class Dt{constructor(){X.set(this,void 0),G.set(this,void 0),O(this,X,new Uint8Array),O(this,G,null)}decode(t){if(t==null)return[];const n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?kn(t):t;O(this,X,ji([p(this,X,"f"),n]));const s=[];let r;for(;(r=Bi(p(this,X,"f"),p(this,G,"f")))!=null;){if(r.carriage&&p(this,G,"f")==null){O(this,G,r.index);continue}if(p(this,G,"f")!=null&&(r.index!==p(this,G,"f")+1||r.carriage)){s.push(bs(p(this,X,"f").subarray(0,p(this,G,"f")-1))),O(this,X,p(this,X,"f").subarray(p(this,G,"f"))),O(this,G,null);continue}const a=p(this,G,"f")!==null?r.preceding-1:r.preceding,i=bs(p(this,X,"f").subarray(0,a));s.push(i),O(this,X,p(this,X,"f").subarray(r.index)),O(this,G,null)}return s}flush(){return p(this,X,"f").length?this.decode(`
`):[]}}X=new WeakMap,G=new WeakMap;Dt.NEWLINE_CHARS=new Set([`
`,"\r"]);Dt.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Bi(e,t){for(let r=t??0;r<e.length;r++){if(e[r]===10)return{preceding:r,index:r+1,carriage:!1};if(e[r]===13)return{preceding:r,index:r+1,carriage:!0}}return null}function Fi(e){for(let s=0;s<e.length-1;s++){if(e[s]===10&&e[s+1]===10||e[s]===13&&e[s+1]===13)return s+2;if(e[s]===13&&e[s+1]===10&&s+3<e.length&&e[s+2]===13&&e[s+3]===10)return s+4}return-1}const At={off:0,error:200,warn:300,info:400,debug:500},As=(e,t,n)=>{if(e){if(Oi(At,e))return e;F(n).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(At))}`)}};function Ue(){}function nt(e,t,n){return!t||At[e]>At[n]?Ue:t[e].bind(t)}const Ki={error:Ue,warn:Ue,info:Ue,debug:Ue};let Is=new WeakMap;function F(e){const t=e.logger,n=e.logLevel??"off";if(!t)return Ki;const s=Is.get(t);if(s&&s[0]===n)return s[1];const r={error:nt("error",t,n),warn:nt("warn",t,n),info:nt("info",t,n),debug:nt("debug",t,n)};return Is.set(t,[n,r]),r}const me=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([t,n])=>[t,t.toLowerCase()==="authorization"||t.toLowerCase()==="cookie"||t.toLowerCase()==="set-cookie"?"***":n]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);var Ne;class oe{constructor(t,n,s){this.iterator=t,Ne.set(this,void 0),this.controller=n,O(this,Ne,s)}static fromSSEResponse(t,n,s){let r=!1;const a=s?F(s):console;async function*i(){if(r)throw new A("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const l of qi(t,n))if(!o){if(l.data.startsWith("[DONE]")){o=!0;continue}if(l.event===null||!l.event.startsWith("thread.")){let u;try{u=JSON.parse(l.data)}catch(m){throw a.error("Could not parse message into JSON:",l.data),a.error("From chunk:",l.raw),m}if(u&&u.error)throw new q(void 0,u.error,void 0,t.headers);yield u}else{let u;try{u=JSON.parse(l.data)}catch(m){throw console.error("Could not parse message into JSON:",l.data),console.error("From chunk:",l.raw),m}if(l.event=="error")throw new q(void 0,u.error,u.message,void 0);yield{event:l.event,data:u}}}o=!0}catch(l){if(an(l))return;throw l}finally{o||n.abort()}}return new oe(i,n,s)}static fromReadableStream(t,n,s){let r=!1;async function*a(){const o=new Dt,l=dr(t);for await(const u of l)for(const m of o.decode(u))yield m;for(const u of o.flush())yield u}async function*i(){if(r)throw new A("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const l of a())o||l&&(yield JSON.parse(l));o=!0}catch(l){if(an(l))return;throw l}finally{o||n.abort()}}return new oe(i,n,s)}[(Ne=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const t=[],n=[],s=this.iterator(),r=a=>({next:()=>{if(a.length===0){const i=s.next();t.push(i),n.push(i)}return a.shift()}});return[new oe(()=>r(t),this.controller,p(this,Ne,"f")),new oe(()=>r(n),this.controller,p(this,Ne,"f"))]}toReadableStream(){const t=this;let n;return cr({async start(){n=t[Symbol.asyncIterator]()},async pull(s){try{const{value:r,done:a}=await n.next();if(a)return s.close();const i=kn(JSON.stringify(r)+`
`);s.enqueue(i)}catch(r){s.error(r)}},async cancel(){await n.return?.()}})}}async function*qi(e,t){if(!e.body)throw t.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new A("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new A("Attempted to iterate over a response with no body");const n=new Zi,s=new Dt,r=dr(e.body);for await(const a of Wi(r))for(const i of s.decode(a)){const o=n.decode(i);o&&(yield o)}for(const a of s.flush()){const i=n.decode(a);i&&(yield i)}}async function*Wi(e){let t=new Uint8Array;for await(const n of e){if(n==null)continue;const s=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?kn(n):n;let r=new Uint8Array(t.length+s.length);r.set(t),r.set(s,t.length),t=r;let a;for(;(a=Fi(t))!==-1;)yield t.slice(0,a),t=t.slice(a)}t.length>0&&(yield t)}class Zi{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(t){if(t.endsWith("\r")&&(t=t.substring(0,t.length-1)),!t){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(t),t.startsWith(":"))return null;let[n,s,r]=Ji(t,":");return r.startsWith(" ")&&(r=r.substring(1)),n==="event"?this.event=r:n==="data"&&this.data.push(r),null}}function Ji(e,t){const n=e.indexOf(t);return n!==-1?[e.substring(0,n),t,e.substring(n+t.length)]:[e,"",""]}async function yr(e,t){const{response:n,requestLogID:s,retryOfRequestLogID:r,startTime:a}=t,i=await(async()=>{if(t.options.stream)return F(e).debug("response",n.status,n.url,n.headers,n.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(n,t.controller,e):oe.fromSSEResponse(n,t.controller,e);if(n.status===204)return null;if(t.options.__binaryResponse)return n;const l=n.headers.get("content-type")?.split(";")[0]?.trim();if(l?.includes("application/json")||l?.endsWith("+json")){const d=await n.json();return wr(d,n)}return await n.text()})();return F(e).debug(`[${s}] response parsed`,me({retryOfRequestLogID:r,url:n.url,status:n.status,body:i,durationMs:Date.now()-a})),i}function wr(e,t){return!e||typeof e!="object"||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}var Le;class jt extends Promise{constructor(t,n,s=yr){super(r=>{r(null)}),this.responsePromise=n,this.parseResponse=s,Le.set(this,void 0),O(this,Le,t)}_thenUnwrap(t){return new jt(p(this,Le,"f"),this.responsePromise,async(n,s)=>wr(t(await this.parseResponse(n,s),s),s.response))}asResponse(){return this.responsePromise.then(t=>t.response)}async withResponse(){const[t,n]=await Promise.all([this.parse(),this.asResponse()]);return{data:t,response:n,request_id:n.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(t=>this.parseResponse(p(this,Le,"f"),t))),this.parsedPromise}then(t,n){return this.parse().then(t,n)}catch(t){return this.parse().catch(t)}finally(t){return this.parse().finally(t)}}Le=new WeakMap;var st;class Tn{constructor(t,n,s,r){st.set(this,void 0),O(this,st,t),this.options=r,this.response=n,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){const t=this.nextPageRequestOptions();if(!t)throw new A("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await p(this,st,"f").requestAPIList(this.constructor,t)}async*iterPages(){let t=this;for(yield t;t.hasNextPage();)t=await t.getNextPage(),yield t}async*[(st=new WeakMap,Symbol.asyncIterator)](){for await(const t of this.iterPages())for(const n of t.getPaginatedItems())yield n}}class Hi extends jt{constructor(t,n,s){super(t,n,async(r,a)=>new s(r,a.response,await yr(r,a),a.options))}async*[Symbol.asyncIterator](){const t=await this;for await(const n of t)yield n}}class Bt extends Tn{constructor(t,n,s,r){super(t,n,s,r),this.data=s.data||[],this.object=s.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class N extends Tn{constructor(t,n,s,r){super(t,n,s,r),this.data=s.data||[],this.has_more=s.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){const t=this.getPaginatedItems(),n=t[t.length-1]?.id;return n?{...this.options,query:{...lr(this.options.query),after:n}}:null}}class It extends Tn{constructor(t,n,s,r){super(t,n,s,r),this.data=s.data||[],this.has_more=s.has_more||!1,this.last_id=s.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){const t=this.last_id;return t?{...this.options,query:{...lr(this.options.query),after:t}}:null}}const br=()=>{if(typeof File>"u"){const{process:e}=globalThis,t=typeof e?.versions?.node=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function We(e,t,n){return br(),new File(e,t??"unknown_file",n)}function pt(e){return(typeof e=="object"&&e!==null&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}const Cn=e=>e!=null&&typeof e=="object"&&typeof e[Symbol.asyncIterator]=="function",Os=async(e,t)=>ln(e.body)?{...e,body:await Ar(e.body,t)}:e,Ae=async(e,t)=>({...e,body:await Ar(e.body,t)}),vs=new WeakMap;function Vi(e){const t=typeof e=="function"?e:e.fetch,n=vs.get(t);if(n)return n;const s=(async()=>{try{const r="Response"in t?t.Response:(await t("data:,")).constructor,a=new FormData;return a.toString()!==await new r(a).text()}catch{return!0}})();return vs.set(t,s),s}const Ar=async(e,t)=>{if(!await Vi(t))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const n=new FormData;return await Promise.all(Object.entries(e||{}).map(([s,r])=>cn(n,s,r))),n},Ir=e=>e instanceof Blob&&"name"in e,Xi=e=>typeof e=="object"&&e!==null&&(e instanceof Response||Cn(e)||Ir(e)),ln=e=>{if(Xi(e))return!0;if(Array.isArray(e))return e.some(ln);if(e&&typeof e=="object"){for(const t in e)if(ln(e[t]))return!0}return!1},cn=async(e,t,n)=>{if(n!==void 0){if(n==null)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")e.append(t,String(n));else if(n instanceof Response)e.append(t,We([await n.blob()],pt(n)));else if(Cn(n))e.append(t,We([await new Response(pr(n)).blob()],pt(n)));else if(Ir(n))e.append(t,n,pt(n));else if(Array.isArray(n))await Promise.all(n.map(s=>cn(e,t+"[]",s)));else if(typeof n=="object")await Promise.all(Object.entries(n).map(([s,r])=>cn(e,`${t}[${s}]`,r)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`)}},Or=e=>e!=null&&typeof e=="object"&&typeof e.size=="number"&&typeof e.type=="string"&&typeof e.text=="function"&&typeof e.slice=="function"&&typeof e.arrayBuffer=="function",Gi=e=>e!=null&&typeof e=="object"&&typeof e.name=="string"&&typeof e.lastModified=="number"&&Or(e),Yi=e=>e!=null&&typeof e=="object"&&typeof e.url=="string"&&typeof e.blob=="function";async function Qi(e,t,n){if(br(),e=await e,Gi(e))return e instanceof File?e:We([await e.arrayBuffer()],e.name);if(Yi(e)){const r=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),We(await pn(r),t,n)}const s=await pn(e);if(t||(t=pt(e)),!n?.type){const r=s.find(a=>typeof a=="object"&&"type"in a&&a.type);typeof r=="string"&&(n={...n,type:r})}return We(s,t,n)}async function pn(e){let t=[];if(typeof e=="string"||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(Or(e))t.push(e instanceof Blob?e:await e.arrayBuffer());else if(Cn(e))for await(const n of e)t.push(...await pn(n));else{const n=e?.constructor?.name;throw new Error(`Unexpected data type: ${typeof e}${n?`; constructor: ${n}`:""}${eo(e)}`)}return t}function eo(e){return typeof e!="object"||e===null?"":`; props: [${Object.getOwnPropertyNames(e).map(n=>`"${n}"`).join(", ")}]`}class I{constructor(t){this._client=t}}function vr(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const xs=Object.freeze(Object.create(null)),to=(e=vr)=>function(n,...s){if(n.length===1)return n[0];let r=!1;const a=[],i=n.reduce((m,d,f)=>{/[?#]/.test(d)&&(r=!0);const c=s[f];let w=(r?encodeURIComponent:e)(""+c);return f!==s.length&&(c==null||typeof c=="object"&&c.toString===Object.getPrototypeOf(Object.getPrototypeOf(c.hasOwnProperty??xs)??xs)?.toString)&&(w=c+"",a.push({start:m.length+d.length,length:w.length,error:`Value of type ${Object.prototype.toString.call(c).slice(8,-1)} is not a valid path parameter`})),m+d+(f===s.length?"":w)},""),o=i.split(/[?#]/,1)[0],l=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let u;for(;(u=l.exec(o))!==null;)a.push({start:u.index,length:u[0].length,error:`Value "${u[0]}" can't be safely passed as a path parameter`});if(a.sort((m,d)=>m.start-d.start),a.length>0){let m=0;const d=a.reduce((f,c)=>{const w=" ".repeat(c.start-m),b="^".repeat(c.length);return m=c.start+c.length,f+w+b},"");throw new A(`Path parameters result in path with invalid segments:
${a.map(f=>f.error).join(`
`)}
${i}
${d}`)}return i},_=to(vr);let xr=class extends I{list(t,n={},s){return this._client.getAPIList(_`/chat/completions/${t}/messages`,N,{query:n,...s})}};function Ot(e){return e!==void 0&&"function"in e&&e.function!==void 0}function no(e,t){const n={...e};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t,enumerable:!1}}),n}function Sn(e){return e?.$brand==="auto-parseable-response-format"}function Xe(e){return e?.$brand==="auto-parseable-tool"}function so(e,t){return!t||!kr(t)?{...e,choices:e.choices.map(n=>(Tr(n.message.tool_calls),{...n,message:{...n.message,parsed:null,...n.message.tool_calls?{tool_calls:n.message.tool_calls}:void 0}}))}:Pn(e,t)}function Pn(e,t){const n=e.choices.map(s=>{if(s.finish_reason==="length")throw new or;if(s.finish_reason==="content_filter")throw new ur;return Tr(s.message.tool_calls),{...s,message:{...s.message,...s.message.tool_calls?{tool_calls:s.message.tool_calls?.map(r=>ao(t,r))??void 0}:void 0,parsed:s.message.content&&!s.message.refusal?ro(t,s.message.content):null}}});return{...e,choices:n}}function ro(e,t){return e.response_format?.type!=="json_schema"?null:e.response_format?.type==="json_schema"?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function ao(e,t){const n=e.tools?.find(s=>Ot(s)&&s.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:Xe(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}function io(e,t){if(!e||!("tools"in e)||!e.tools)return!1;const n=e.tools?.find(s=>Ot(s)&&s.function?.name===t.function.name);return Ot(n)&&(Xe(n)||n?.function.strict||!1)}function kr(e){return Sn(e.response_format)?!0:e.tools?.some(t=>Xe(t)||t.type==="function"&&t.function.strict===!0)??!1}function Tr(e){for(const t of e||[])if(t.type!=="function")throw new A(`Currently only \`function\` tool calls are supported; Received \`${t.type}\``)}function oo(e){for(const t of e??[]){if(t.type!=="function")throw new A(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(t.function.strict!==!0)throw new A(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}const vt=e=>e?.role==="assistant",Cr=e=>e?.role==="tool";var dn,dt,ht,De,je,ft,Be,le,Fe,xt,kt,xe,Sr;class Rn{constructor(){dn.add(this),this.controller=new AbortController,dt.set(this,void 0),ht.set(this,()=>{}),De.set(this,()=>{}),je.set(this,void 0),ft.set(this,()=>{}),Be.set(this,()=>{}),le.set(this,{}),Fe.set(this,!1),xt.set(this,!1),kt.set(this,!1),xe.set(this,!1),O(this,dt,new Promise((t,n)=>{O(this,ht,t,"f"),O(this,De,n,"f")})),O(this,je,new Promise((t,n)=>{O(this,ft,t,"f"),O(this,Be,n,"f")})),p(this,dt,"f").catch(()=>{}),p(this,je,"f").catch(()=>{})}_run(t){setTimeout(()=>{t().then(()=>{this._emitFinal(),this._emit("end")},p(this,dn,"m",Sr).bind(this))},0)}_connected(){this.ended||(p(this,ht,"f").call(this),this._emit("connect"))}get ended(){return p(this,Fe,"f")}get errored(){return p(this,xt,"f")}get aborted(){return p(this,kt,"f")}abort(){this.controller.abort()}on(t,n){return(p(this,le,"f")[t]||(p(this,le,"f")[t]=[])).push({listener:n}),this}off(t,n){const s=p(this,le,"f")[t];if(!s)return this;const r=s.findIndex(a=>a.listener===n);return r>=0&&s.splice(r,1),this}once(t,n){return(p(this,le,"f")[t]||(p(this,le,"f")[t]=[])).push({listener:n,once:!0}),this}emitted(t){return new Promise((n,s)=>{O(this,xe,!0),t!=="error"&&this.once("error",s),this.once(t,n)})}async done(){O(this,xe,!0),await p(this,je,"f")}_emit(t,...n){if(p(this,Fe,"f"))return;t==="end"&&(O(this,Fe,!0),p(this,ft,"f").call(this));const s=p(this,le,"f")[t];if(s&&(p(this,le,"f")[t]=s.filter(r=>!r.once),s.forEach(({listener:r})=>r(...n))),t==="abort"){const r=n[0];!p(this,xe,"f")&&!s?.length&&Promise.reject(r),p(this,De,"f").call(this,r),p(this,Be,"f").call(this,r),this._emit("end");return}if(t==="error"){const r=n[0];!p(this,xe,"f")&&!s?.length&&Promise.reject(r),p(this,De,"f").call(this,r),p(this,Be,"f").call(this,r),this._emit("end")}}_emitFinal(){}}dt=new WeakMap,ht=new WeakMap,De=new WeakMap,je=new WeakMap,ft=new WeakMap,Be=new WeakMap,le=new WeakMap,Fe=new WeakMap,xt=new WeakMap,kt=new WeakMap,xe=new WeakMap,dn=new WeakSet,Sr=function(t){if(O(this,xt,!0),t instanceof Error&&t.name==="AbortError"&&(t=new ee),t instanceof ee)return O(this,kt,!0),this._emit("abort",t);if(t instanceof A)return this._emit("error",t);if(t instanceof Error){const n=new A(t.message);return n.cause=t,this._emit("error",n)}return this._emit("error",new A(String(t)))};function uo(e){return typeof e.parse=="function"}var H,hn,Tt,fn,mn,gn,Pr,Rr;const lo=10;class Er extends Rn{constructor(){super(...arguments),H.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(t){this._chatCompletions.push(t),this._emit("chatCompletion",t);const n=t.choices[0]?.message;return n&&this._addMessage(n),t}_addMessage(t,n=!0){if("content"in t||(t.content=null),this.messages.push(t),n){if(this._emit("message",t),Cr(t)&&t.content)this._emit("functionToolCallResult",t.content);else if(vt(t)&&t.tool_calls)for(const s of t.tool_calls)s.type==="function"&&this._emit("functionToolCall",s.function)}}async finalChatCompletion(){await this.done();const t=this._chatCompletions[this._chatCompletions.length-1];if(!t)throw new A("stream ended without producing a ChatCompletion");return t}async finalContent(){return await this.done(),p(this,H,"m",hn).call(this)}async finalMessage(){return await this.done(),p(this,H,"m",Tt).call(this)}async finalFunctionToolCall(){return await this.done(),p(this,H,"m",fn).call(this)}async finalFunctionToolCallResult(){return await this.done(),p(this,H,"m",mn).call(this)}async totalUsage(){return await this.done(),p(this,H,"m",gn).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const t=this._chatCompletions[this._chatCompletions.length-1];t&&this._emit("finalChatCompletion",t);const n=p(this,H,"m",Tt).call(this);n&&this._emit("finalMessage",n);const s=p(this,H,"m",hn).call(this);s&&this._emit("finalContent",s);const r=p(this,H,"m",fn).call(this);r&&this._emit("finalFunctionToolCall",r);const a=p(this,H,"m",mn).call(this);a!=null&&this._emit("finalFunctionToolCallResult",a),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",p(this,H,"m",gn).call(this))}async _createChatCompletion(t,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),p(this,H,"m",Pr).call(this,n);const a=await t.chat.completions.create({...n,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Pn(a,n))}async _runChatCompletion(t,n,s){for(const r of n.messages)this._addMessage(r,!1);return await this._createChatCompletion(t,n,s)}async _runTools(t,n,s){const r="tool",{tool_choice:a="auto",stream:i,...o}=n,l=typeof a!="string"&&a.type==="function"&&a?.function?.name,{maxChatCompletions:u=lo}=s||{},m=n.tools.map(c=>{if(Xe(c)){if(!c.$callback)throw new A("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:c.$callback,name:c.function.name,description:c.function.description||"",parameters:c.function.parameters,parse:c.$parseRaw,strict:!0}}}return c}),d={};for(const c of m)c.type==="function"&&(d[c.function.name||c.function.function.name]=c.function);const f="tools"in n?m.map(c=>c.type==="function"?{type:"function",function:{name:c.function.name||c.function.function.name,parameters:c.function.parameters,description:c.function.description,strict:c.function.strict}}:c):void 0;for(const c of n.messages)this._addMessage(c,!1);for(let c=0;c<u;++c){const b=(await this._createChatCompletion(t,{...o,tool_choice:a,tools:f,messages:[...this.messages]},s)).choices[0]?.message;if(!b)throw new A("missing message in ChatCompletion response");if(!b.tool_calls?.length)return;for(const C of b.tool_calls){if(C.type!=="function")continue;const h=C.id,{name:g,arguments:k}=C.function,S=d[g];if(S){if(l&&l!==g){const B=`Invalid tool_call: ${JSON.stringify(g)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:r,tool_call_id:h,content:B});continue}}else{const B=`Invalid tool_call: ${JSON.stringify(g)}. Available options are: ${Object.keys(d).map(D=>JSON.stringify(D)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:h,content:B});continue}let J;try{J=uo(S)?await S.parse(k):k}catch(B){const D=B instanceof Error?B.message:String(B);this._addMessage({role:r,tool_call_id:h,content:D});continue}const L=await S.function(J,this),E=p(this,H,"m",Rr).call(this,L);if(this._addMessage({role:r,tool_call_id:h,content:E}),l)return}}}}H=new WeakSet,hn=function(){return p(this,H,"m",Tt).call(this).content??null},Tt=function(){let t=this.messages.length;for(;t-- >0;){const n=this.messages[t];if(vt(n))return{...n,content:n.content??null,refusal:n.refusal??null}}throw new A("stream ended without producing a ChatCompletionMessage with role=assistant")},fn=function(){for(let t=this.messages.length-1;t>=0;t--){const n=this.messages[t];if(vt(n)&&n?.tool_calls?.length)return n.tool_calls.filter(s=>s.type==="function").at(-1)?.function}},mn=function(){for(let t=this.messages.length-1;t>=0;t--){const n=this.messages[t];if(Cr(n)&&n.content!=null&&typeof n.content=="string"&&this.messages.some(s=>s.role==="assistant"&&s.tool_calls?.some(r=>r.type==="function"&&r.id===n.tool_call_id)))return n.content}},gn=function(){const t={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:n}of this._chatCompletions)n&&(t.completion_tokens+=n.completion_tokens,t.prompt_tokens+=n.prompt_tokens,t.total_tokens+=n.total_tokens);return t},Pr=function(t){if(t.n!=null&&t.n>1)throw new A("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Rr=function(t){return typeof t=="string"?t:t===void 0?"undefined":JSON.stringify(t)};class En extends Er{static runTools(t,n,s){const r=new En,a={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(t,n,a)),r}_addMessage(t,n=!0){super._addMessage(t,n),vt(t)&&t.content&&this._emit("content",t.content)}}const $r=1,Nr=2,Mr=4,zr=8,Ur=16,Lr=32,Dr=64,jr=128,Br=256,Fr=jr|Br,Kr=Ur|Lr|Fr|Dr,qr=$r|Nr|Kr,Wr=Mr|zr,co=qr|Wr,j={STR:$r,NUM:Nr,ARR:Mr,OBJ:zr,NULL:Ur,BOOL:Lr,NAN:Dr,INFINITY:jr,MINUS_INFINITY:Br,INF:Fr,SPECIAL:Kr,ATOM:qr,COLLECTION:Wr,ALL:co};class po extends Error{}class ho extends Error{}function fo(e,t=j.ALL){if(typeof e!="string")throw new TypeError(`expecting str, got ${typeof e}`);if(!e.trim())throw new Error(`${e} is empty`);return mo(e.trim(),t)}const mo=(e,t)=>{const n=e.length;let s=0;const r=f=>{throw new po(`${f} at position ${s}`)},a=f=>{throw new ho(`${f} at position ${s}`)},i=()=>(d(),s>=n&&r("Unexpected end of input"),e[s]==='"'?o():e[s]==="{"?l():e[s]==="["?u():e.substring(s,s+4)==="null"||j.NULL&t&&n-s<4&&"null".startsWith(e.substring(s))?(s+=4,null):e.substring(s,s+4)==="true"||j.BOOL&t&&n-s<4&&"true".startsWith(e.substring(s))?(s+=4,!0):e.substring(s,s+5)==="false"||j.BOOL&t&&n-s<5&&"false".startsWith(e.substring(s))?(s+=5,!1):e.substring(s,s+8)==="Infinity"||j.INFINITY&t&&n-s<8&&"Infinity".startsWith(e.substring(s))?(s+=8,1/0):e.substring(s,s+9)==="-Infinity"||j.MINUS_INFINITY&t&&1<n-s&&n-s<9&&"-Infinity".startsWith(e.substring(s))?(s+=9,-1/0):e.substring(s,s+3)==="NaN"||j.NAN&t&&n-s<3&&"NaN".startsWith(e.substring(s))?(s+=3,NaN):m()),o=()=>{const f=s;let c=!1;for(s++;s<n&&(e[s]!=='"'||c&&e[s-1]==="\\");)c=e[s]==="\\"?!c:!1,s++;if(e.charAt(s)=='"')try{return JSON.parse(e.substring(f,++s-Number(c)))}catch(w){a(String(w))}else if(j.STR&t)try{return JSON.parse(e.substring(f,s-Number(c))+'"')}catch{return JSON.parse(e.substring(f,e.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},l=()=>{s++,d();const f={};try{for(;e[s]!=="}";){if(d(),s>=n&&j.OBJ&t)return f;const c=o();d(),s++;try{const w=i();Object.defineProperty(f,c,{value:w,writable:!0,enumerable:!0,configurable:!0})}catch(w){if(j.OBJ&t)return f;throw w}d(),e[s]===","&&s++}}catch{if(j.OBJ&t)return f;r("Expected '}' at end of object")}return s++,f},u=()=>{s++;const f=[];try{for(;e[s]!=="]";)f.push(i()),d(),e[s]===","&&s++}catch{if(j.ARR&t)return f;r("Expected ']' at end of array")}return s++,f},m=()=>{if(s===0){e==="-"&&j.NUM&t&&r("Not sure what '-' is");try{return JSON.parse(e)}catch(c){if(j.NUM&t)try{return e[e.length-1]==="."?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch{}a(String(c))}}const f=s;for(e[s]==="-"&&s++;e[s]&&!",]}".includes(e[s]);)s++;s==n&&!(j.NUM&t)&&r("Unterminated number literal");try{return JSON.parse(e.substring(f,s))}catch{e.substring(f,s)==="-"&&j.NUM&t&&r("Not sure what '-' is");try{return JSON.parse(e.substring(f,e.lastIndexOf("e")))}catch(w){a(String(w))}}},d=()=>{for(;s<n&&` 
\r	`.includes(e[s]);)s++};return i()},ks=e=>fo(e,j.ALL^j.NUM);var z,ue,Ie,de,Gt,rt,Yt,Qt,en,at,tn,Ts;class He extends Er{constructor(t){super(),z.add(this),ue.set(this,void 0),Ie.set(this,void 0),de.set(this,void 0),O(this,ue,t),O(this,Ie,[])}get currentChatCompletionSnapshot(){return p(this,de,"f")}static fromReadableStream(t){const n=new He(null);return n._run(()=>n._fromReadableStream(t)),n}static createChatCompletion(t,n,s){const r=new He(n);return r._run(()=>r._runChatCompletion(t,{...n,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createChatCompletion(t,n,s){super._createChatCompletion;const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),p(this,z,"m",Gt).call(this);const a=await t.chat.completions.create({...n,stream:!0},{...s,signal:this.controller.signal});this._connected();for await(const i of a)p(this,z,"m",Yt).call(this,i);if(a.controller.signal?.aborted)throw new ee;return this._addChatCompletion(p(this,z,"m",at).call(this))}async _fromReadableStream(t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),p(this,z,"m",Gt).call(this),this._connected();const r=oe.fromReadableStream(t,this.controller);let a;for await(const i of r)a&&a!==i.id&&this._addChatCompletion(p(this,z,"m",at).call(this)),p(this,z,"m",Yt).call(this,i),a=i.id;if(r.controller.signal?.aborted)throw new ee;return this._addChatCompletion(p(this,z,"m",at).call(this))}[(ue=new WeakMap,Ie=new WeakMap,de=new WeakMap,z=new WeakSet,Gt=function(){this.ended||O(this,de,void 0)},rt=function(n){let s=p(this,Ie,"f")[n.index];return s||(s={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},p(this,Ie,"f")[n.index]=s,s)},Yt=function(n){if(this.ended)return;const s=p(this,z,"m",Ts).call(this,n);this._emit("chunk",n,s);for(const r of n.choices){const a=s.choices[r.index];r.delta.content!=null&&a.message?.role==="assistant"&&a.message?.content&&(this._emit("content",r.delta.content,a.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:a.message.content,parsed:a.message.parsed})),r.delta.refusal!=null&&a.message?.role==="assistant"&&a.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:a.message.refusal}),r.logprobs?.content!=null&&a.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:a.logprobs?.content??[]}),r.logprobs?.refusal!=null&&a.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:a.logprobs?.refusal??[]});const i=p(this,z,"m",rt).call(this,a);a.finish_reason&&(p(this,z,"m",en).call(this,a),i.current_tool_call_index!=null&&p(this,z,"m",Qt).call(this,a,i.current_tool_call_index));for(const o of r.delta.tool_calls??[])i.current_tool_call_index!==o.index&&(p(this,z,"m",en).call(this,a),i.current_tool_call_index!=null&&p(this,z,"m",Qt).call(this,a,i.current_tool_call_index)),i.current_tool_call_index=o.index;for(const o of r.delta.tool_calls??[]){const l=a.message.tool_calls?.[o.index];l?.type&&(l?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:l.function?.name,index:o.index,arguments:l.function.arguments,parsed_arguments:l.function.parsed_arguments,arguments_delta:o.function?.arguments??""}):(l?.type,void 0))}}},Qt=function(n,s){if(p(this,z,"m",rt).call(this,n).done_tool_calls.has(s))return;const a=n.message.tool_calls?.[s];if(!a)throw new Error("no tool call snapshot");if(!a.type)throw new Error("tool call snapshot missing `type`");if(a.type==="function"){const i=p(this,ue,"f")?.tools?.find(o=>Ot(o)&&o.function.name===a.function.name);this._emit("tool_calls.function.arguments.done",{name:a.function.name,index:s,arguments:a.function.arguments,parsed_arguments:Xe(i)?i.$parseRaw(a.function.arguments):i?.function.strict?JSON.parse(a.function.arguments):null})}else a.type},en=function(n){const s=p(this,z,"m",rt).call(this,n);if(n.message.content&&!s.content_done){s.content_done=!0;const r=p(this,z,"m",tn).call(this);this._emit("content.done",{content:n.message.content,parsed:r?r.$parseRaw(n.message.content):null})}n.message.refusal&&!s.refusal_done&&(s.refusal_done=!0,this._emit("refusal.done",{refusal:n.message.refusal})),n.logprobs?.content&&!s.logprobs_content_done&&(s.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:n.logprobs.content})),n.logprobs?.refusal&&!s.logprobs_refusal_done&&(s.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:n.logprobs.refusal}))},at=function(){if(this.ended)throw new A("stream has ended, this shouldn't happen");const n=p(this,de,"f");if(!n)throw new A("request ended without sending any chunks");return O(this,de,void 0),O(this,Ie,[]),go(n,p(this,ue,"f"))},tn=function(){const n=p(this,ue,"f")?.response_format;return Sn(n)?n:null},Ts=function(n){var s,r,a,i;let o=p(this,de,"f");const{choices:l,...u}=n;o?Object.assign(o,u):o=O(this,de,{...u,choices:[]});for(const{delta:m,finish_reason:d,index:f,logprobs:c=null,...w}of n.choices){let b=o.choices[f];if(b||(b=o.choices[f]={finish_reason:d,index:f,message:{},logprobs:c,...w}),c)if(!b.logprobs)b.logprobs=Object.assign({},c);else{const{content:L,refusal:E,...B}=c;Object.assign(b.logprobs,B),L&&((s=b.logprobs).content??(s.content=[]),b.logprobs.content.push(...L)),E&&((r=b.logprobs).refusal??(r.refusal=[]),b.logprobs.refusal.push(...E))}if(d&&(b.finish_reason=d,p(this,ue,"f")&&kr(p(this,ue,"f")))){if(d==="length")throw new or;if(d==="content_filter")throw new ur}if(Object.assign(b,w),!m)continue;const{content:C,refusal:h,function_call:g,role:k,tool_calls:S,...J}=m;if(Object.assign(b.message,J),h&&(b.message.refusal=(b.message.refusal||"")+h),k&&(b.message.role=k),g&&(b.message.function_call?(g.name&&(b.message.function_call.name=g.name),g.arguments&&((a=b.message.function_call).arguments??(a.arguments=""),b.message.function_call.arguments+=g.arguments)):b.message.function_call=g),C&&(b.message.content=(b.message.content||"")+C,!b.message.refusal&&p(this,z,"m",tn).call(this)&&(b.message.parsed=ks(b.message.content))),S){b.message.tool_calls||(b.message.tool_calls=[]);for(const{index:L,id:E,type:B,function:D,...$}of S){const M=(i=b.message.tool_calls)[L]??(i[L]={});Object.assign(M,$),E&&(M.id=E),B&&(M.type=B),D&&(M.function??(M.function={name:D.name??"",arguments:""})),D?.name&&(M.function.name=D.name),D?.arguments&&(M.function.arguments+=D.arguments,io(p(this,ue,"f"),M)&&(M.function.parsed_arguments=ks(M.function.arguments)))}}}return o},Symbol.asyncIterator)](){const t=[],n=[];let s=!1;return this.on("chunk",r=>{const a=n.shift();a?a.resolve(r):t.push(r)}),this.on("end",()=>{s=!0;for(const r of n)r.resolve(void 0);n.length=0}),this.on("abort",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),this.on("error",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),{next:async()=>t.length?{value:t.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new oe(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function go(e,t){const{id:n,choices:s,created:r,model:a,system_fingerprint:i,...o}=e,l={...o,id:n,choices:s.map(({message:u,finish_reason:m,index:d,logprobs:f,...c})=>{if(!m)throw new A(`missing finish_reason for choice ${d}`);const{content:w=null,function_call:b,tool_calls:C,...h}=u,g=u.role;if(!g)throw new A(`missing role for choice ${d}`);if(b){const{arguments:k,name:S}=b;if(k==null)throw new A(`missing function_call.arguments for choice ${d}`);if(!S)throw new A(`missing function_call.name for choice ${d}`);return{...c,message:{content:w,function_call:{arguments:k,name:S},role:g,refusal:u.refusal??null},finish_reason:m,index:d,logprobs:f}}return C?{...c,index:d,finish_reason:m,logprobs:f,message:{...h,role:g,content:w,refusal:u.refusal??null,tool_calls:C.map((k,S)=>{const{function:J,type:L,id:E,...B}=k,{arguments:D,name:$,...M}=J||{};if(E==null)throw new A(`missing choices[${d}].tool_calls[${S}].id
${it(e)}`);if(L==null)throw new A(`missing choices[${d}].tool_calls[${S}].type
${it(e)}`);if($==null)throw new A(`missing choices[${d}].tool_calls[${S}].function.name
${it(e)}`);if(D==null)throw new A(`missing choices[${d}].tool_calls[${S}].function.arguments
${it(e)}`);return{...B,id:E,type:L,function:{...M,name:$,arguments:D}}})}}:{...c,message:{...h,content:w,role:g,refusal:u.refusal??null},finish_reason:m,index:d,logprobs:f}}),created:r,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return so(l,t)}function it(e){return JSON.stringify(e)}class Ct extends He{static fromReadableStream(t){const n=new Ct(null);return n._run(()=>n._fromReadableStream(t)),n}static runTools(t,n,s){const r=new Ct(n),a={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(t,n,a)),r}}let $n=class extends I{constructor(){super(...arguments),this.messages=new xr(this._client)}create(t,n){return this._client.post("/chat/completions",{body:t,...n,stream:t.stream??!1})}retrieve(t,n){return this._client.get(_`/chat/completions/${t}`,n)}update(t,n,s){return this._client.post(_`/chat/completions/${t}`,{body:n,...s})}list(t={},n){return this._client.getAPIList("/chat/completions",N,{query:t,...n})}delete(t,n){return this._client.delete(_`/chat/completions/${t}`,n)}parse(t,n){return oo(t.tools),this._client.chat.completions.create(t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(s=>Pn(s,t))}runTools(t,n){return t.stream?Ct.runTools(this._client,t,n):En.runTools(this._client,t,n)}stream(t,n){return He.createChatCompletion(this._client,t,n)}};$n.Messages=xr;class Nn extends I{constructor(){super(...arguments),this.completions=new $n(this._client)}}Nn.Completions=$n;const Zr=Symbol("brand.privateNullableHeaders");function*_o(e){if(!e)return;if(Zr in e){const{values:s,nulls:r}=e;yield*s.entries();for(const a of r)yield[a,null];return}let t=!1,n;e instanceof Headers?n=e.entries():ps(e)?n=e:(t=!0,n=Object.entries(e??{}));for(let s of n){const r=s[0];if(typeof r!="string")throw new TypeError("expected header name to be a string");const a=ps(s[1])?s[1]:[s[1]];let i=!1;for(const o of a)o!==void 0&&(t&&!i&&(i=!0,yield[r,null]),yield[r,o])}}const y=e=>{const t=new Headers,n=new Set;for(const s of e){const r=new Set;for(const[a,i]of _o(s)){const o=a.toLowerCase();r.has(o)||(t.delete(a),r.add(o)),i===null?(t.delete(a),n.add(o)):(t.append(a,i),n.delete(o))}}return{[Zr]:!0,values:t,nulls:n}};class Jr extends I{create(t,n){return this._client.post("/audio/speech",{body:t,...n,headers:y([{Accept:"application/octet-stream"},n?.headers]),__binaryResponse:!0})}}class Hr extends I{create(t,n){return this._client.post("/audio/transcriptions",Ae({body:t,...n,stream:t.stream??!1,__metadata:{model:t.model}},this._client))}}class Vr extends I{create(t,n){return this._client.post("/audio/translations",Ae({body:t,...n,__metadata:{model:t.model}},this._client))}}class Ge extends I{constructor(){super(...arguments),this.transcriptions=new Hr(this._client),this.translations=new Vr(this._client),this.speech=new Jr(this._client)}}Ge.Transcriptions=Hr;Ge.Translations=Vr;Ge.Speech=Jr;class Xr extends I{create(t,n){return this._client.post("/batches",{body:t,...n})}retrieve(t,n){return this._client.get(_`/batches/${t}`,n)}list(t={},n){return this._client.getAPIList("/batches",N,{query:t,...n})}cancel(t,n){return this._client.post(_`/batches/${t}/cancel`,n)}}class Gr extends I{create(t,n){return this._client.post("/assistants",{body:t,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(t,n){return this._client.get(_`/assistants/${t}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(t,n,s){return this._client.post(_`/assistants/${t}`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(t={},n){return this._client.getAPIList("/assistants",N,{query:t,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(t,n){return this._client.delete(_`/assistants/${t}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}let Yr=class extends I{create(t,n){return this._client.post("/realtime/sessions",{body:t,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}};class Qr extends I{create(t,n){return this._client.post("/realtime/transcription_sessions",{body:t,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}let Ft=class extends I{constructor(){super(...arguments),this.sessions=new Yr(this._client),this.transcriptionSessions=new Qr(this._client)}};Ft.Sessions=Yr;Ft.TranscriptionSessions=Qr;class ea extends I{create(t,n){return this._client.post("/chatkit/sessions",{body:t,...n,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},n?.headers])})}cancel(t,n){return this._client.post(_`/chatkit/sessions/${t}/cancel`,{...n,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},n?.headers])})}}let ta=class extends I{retrieve(t,n){return this._client.get(_`/chatkit/threads/${t}`,{...n,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},n?.headers])})}list(t={},n){return this._client.getAPIList("/chatkit/threads",It,{query:t,...n,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},n?.headers])})}delete(t,n){return this._client.delete(_`/chatkit/threads/${t}`,{...n,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},n?.headers])})}listItems(t,n={},s){return this._client.getAPIList(_`/chatkit/threads/${t}/items`,It,{query:n,...s,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},s?.headers])})}};class Kt extends I{constructor(){super(...arguments),this.sessions=new ea(this._client),this.threads=new ta(this._client)}}Kt.Sessions=ea;Kt.Threads=ta;class na extends I{create(t,n,s){return this._client.post(_`/threads/${t}/messages`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(t,n,s){const{thread_id:r}=n;return this._client.get(_`/threads/${r}/messages/${t}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(t,n,s){const{thread_id:r,...a}=n;return this._client.post(_`/threads/${r}/messages/${t}`,{body:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(t,n={},s){return this._client.getAPIList(_`/threads/${t}/messages`,N,{query:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(t,n,s){const{thread_id:r}=n;return this._client.delete(_`/threads/${r}/messages/${t}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class sa extends I{retrieve(t,n,s){const{thread_id:r,run_id:a,...i}=n;return this._client.get(_`/threads/${r}/runs/${a}/steps/${t}`,{query:i,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(t,n,s){const{thread_id:r,...a}=n;return this._client.getAPIList(_`/threads/${r}/runs/${t}/steps`,N,{query:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}const yo=e=>{if(typeof Buffer<"u"){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}else{const t=atob(e),n=t.length,s=new Uint8Array(n);for(let r=0;r<n;r++)s[r]=t.charCodeAt(r);return Array.from(new Float32Array(s.buffer))}};var wo={};const pe=e=>{if(typeof globalThis.process<"u")return wo?.[e]?.trim()??void 0;if(typeof globalThis.Deno<"u")return globalThis.Deno.env?.get?.(e)?.trim()};var K,ye,_n,ie,mt,re,we,Te,_e,St,Y,gt,_t,Ze,Ke,qe,Cs,Ss,Ps,Rs,Es,$s,Ns;class Je extends Rn{constructor(){super(...arguments),K.add(this),_n.set(this,[]),ie.set(this,{}),mt.set(this,{}),re.set(this,void 0),we.set(this,void 0),Te.set(this,void 0),_e.set(this,void 0),St.set(this,void 0),Y.set(this,void 0),gt.set(this,void 0),_t.set(this,void 0),Ze.set(this,void 0)}[(_n=new WeakMap,ie=new WeakMap,mt=new WeakMap,re=new WeakMap,we=new WeakMap,Te=new WeakMap,_e=new WeakMap,St=new WeakMap,Y=new WeakMap,gt=new WeakMap,_t=new WeakMap,Ze=new WeakMap,K=new WeakSet,Symbol.asyncIterator)](){const t=[],n=[];let s=!1;return this.on("event",r=>{const a=n.shift();a?a.resolve(r):t.push(r)}),this.on("end",()=>{s=!0;for(const r of n)r.resolve(void 0);n.length=0}),this.on("abort",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),this.on("error",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),{next:async()=>t.length?{value:t.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(t){const n=new ye;return n._run(()=>n._fromReadableStream(t)),n}async _fromReadableStream(t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),this._connected();const r=oe.fromReadableStream(t,this.controller);for await(const a of r)p(this,K,"m",Ke).call(this,a);if(r.controller.signal?.aborted)throw new ee;return this._addRun(p(this,K,"m",qe).call(this))}toReadableStream(){return new oe(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(t,n,s,r){const a=new ye;return a._run(()=>a._runToolAssistantStream(t,n,s,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(t,n,s,r){const a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...s,stream:!0},o=await t.submitToolOutputs(n,i,{...r,signal:this.controller.signal});this._connected();for await(const l of o)p(this,K,"m",Ke).call(this,l);if(o.controller.signal?.aborted)throw new ee;return this._addRun(p(this,K,"m",qe).call(this))}static createThreadAssistantStream(t,n,s){const r=new ye;return r._run(()=>r._threadAssistantStream(t,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}static createAssistantStream(t,n,s,r){const a=new ye;return a._run(()=>a._runAssistantStream(t,n,s,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return p(this,gt,"f")}currentRun(){return p(this,_t,"f")}currentMessageSnapshot(){return p(this,re,"f")}currentRunStepSnapshot(){return p(this,Ze,"f")}async finalRunSteps(){return await this.done(),Object.values(p(this,ie,"f"))}async finalMessages(){return await this.done(),Object.values(p(this,mt,"f"))}async finalRun(){if(await this.done(),!p(this,we,"f"))throw Error("Final run was not received.");return p(this,we,"f")}async _createThreadAssistantStream(t,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},i=await t.createAndRun(a,{...s,signal:this.controller.signal});this._connected();for await(const o of i)p(this,K,"m",Ke).call(this,o);if(i.controller.signal?.aborted)throw new ee;return this._addRun(p(this,K,"m",qe).call(this))}async _createAssistantStream(t,n,s,r){const a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...s,stream:!0},o=await t.create(n,i,{...r,signal:this.controller.signal});this._connected();for await(const l of o)p(this,K,"m",Ke).call(this,l);if(o.controller.signal?.aborted)throw new ee;return this._addRun(p(this,K,"m",qe).call(this))}static accumulateDelta(t,n){for(const[s,r]of Object.entries(n)){if(!t.hasOwnProperty(s)){t[s]=r;continue}let a=t[s];if(a==null){t[s]=r;continue}if(s==="index"||s==="type"){t[s]=r;continue}if(typeof a=="string"&&typeof r=="string")a+=r;else if(typeof a=="number"&&typeof r=="number")a+=r;else if(ct(a)&&ct(r))a=this.accumulateDelta(a,r);else if(Array.isArray(a)&&Array.isArray(r)){if(a.every(i=>typeof i=="string"||typeof i=="number")){a.push(...r);continue}for(const i of r){if(!ct(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);const o=i.index;if(o==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const l=a[o];l==null?a.push(i):a[o]=this.accumulateDelta(l,i)}continue}else throw Error(`Unhandled record type: ${s}, deltaValue: ${r}, accValue: ${a}`);t[s]=a}return t}_addRun(t){return t}async _threadAssistantStream(t,n,s){return await this._createThreadAssistantStream(n,t,s)}async _runAssistantStream(t,n,s,r){return await this._createAssistantStream(n,t,s,r)}async _runToolAssistantStream(t,n,s,r){return await this._createToolAssistantStream(n,t,s,r)}}ye=Je,Ke=function(t){if(!this.ended)switch(O(this,gt,t),p(this,K,"m",Ps).call(this,t),t.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":p(this,K,"m",Ns).call(this,t);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":p(this,K,"m",Ss).call(this,t);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":p(this,K,"m",Cs).call(this,t);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},qe=function(){if(this.ended)throw new A("stream has ended, this shouldn't happen");if(!p(this,we,"f"))throw Error("Final run has not been received");return p(this,we,"f")},Cs=function(t){const[n,s]=p(this,K,"m",Es).call(this,t,p(this,re,"f"));O(this,re,n),p(this,mt,"f")[n.id]=n;for(const r of s){const a=n.content[r.index];a?.type=="text"&&this._emit("textCreated",a.text)}switch(t.event){case"thread.message.created":this._emit("messageCreated",t.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",t.data.delta,n),t.data.delta.content)for(const r of t.data.delta.content){if(r.type=="text"&&r.text){let a=r.text,i=n.content[r.index];if(i&&i.type=="text")this._emit("textDelta",a,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=p(this,Te,"f")){if(p(this,_e,"f"))switch(p(this,_e,"f").type){case"text":this._emit("textDone",p(this,_e,"f").text,p(this,re,"f"));break;case"image_file":this._emit("imageFileDone",p(this,_e,"f").image_file,p(this,re,"f"));break}O(this,Te,r.index)}O(this,_e,n.content[r.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(p(this,Te,"f")!==void 0){const r=t.data.content[p(this,Te,"f")];if(r)switch(r.type){case"image_file":this._emit("imageFileDone",r.image_file,p(this,re,"f"));break;case"text":this._emit("textDone",r.text,p(this,re,"f"));break}}p(this,re,"f")&&this._emit("messageDone",t.data),O(this,re,void 0)}},Ss=function(t){const n=p(this,K,"m",Rs).call(this,t);switch(O(this,Ze,n),t.event){case"thread.run.step.created":this._emit("runStepCreated",t.data);break;case"thread.run.step.delta":const s=t.data.delta;if(s.step_details&&s.step_details.type=="tool_calls"&&s.step_details.tool_calls&&n.step_details.type=="tool_calls")for(const a of s.step_details.tool_calls)a.index==p(this,St,"f")?this._emit("toolCallDelta",a,n.step_details.tool_calls[a.index]):(p(this,Y,"f")&&this._emit("toolCallDone",p(this,Y,"f")),O(this,St,a.index),O(this,Y,n.step_details.tool_calls[a.index]),p(this,Y,"f")&&this._emit("toolCallCreated",p(this,Y,"f")));this._emit("runStepDelta",t.data.delta,n);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":O(this,Ze,void 0),t.data.step_details.type=="tool_calls"&&p(this,Y,"f")&&(this._emit("toolCallDone",p(this,Y,"f")),O(this,Y,void 0)),this._emit("runStepDone",t.data,n);break}},Ps=function(t){p(this,_n,"f").push(t),this._emit("event",t)},Rs=function(t){switch(t.event){case"thread.run.step.created":return p(this,ie,"f")[t.data.id]=t.data,t.data;case"thread.run.step.delta":let n=p(this,ie,"f")[t.data.id];if(!n)throw Error("Received a RunStepDelta before creation of a snapshot");let s=t.data;if(s.delta){const r=ye.accumulateDelta(n,s.delta);p(this,ie,"f")[t.data.id]=r}return p(this,ie,"f")[t.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":p(this,ie,"f")[t.data.id]=t.data;break}if(p(this,ie,"f")[t.data.id])return p(this,ie,"f")[t.data.id];throw new Error("No snapshot available")},Es=function(t,n){let s=[];switch(t.event){case"thread.message.created":return[t.data,s];case"thread.message.delta":if(!n)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=t.data;if(r.delta.content)for(const a of r.delta.content)if(a.index in n.content){let i=n.content[a.index];n.content[a.index]=p(this,K,"m",$s).call(this,a,i)}else n.content[a.index]=a,s.push(a);return[n,s];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(n)return[n,s];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},$s=function(t,n){return ye.accumulateDelta(n,t)},Ns=function(t){switch(O(this,_t,t.data),t.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":O(this,we,t.data),p(this,Y,"f")&&(this._emit("toolCallDone",p(this,Y,"f")),O(this,Y,void 0));break}};let Mn=class extends I{constructor(){super(...arguments),this.steps=new sa(this._client)}create(t,n,s){const{include:r,...a}=n;return this._client.post(_`/threads/${t}/runs`,{query:{include:r},body:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:n.stream??!1})}retrieve(t,n,s){const{thread_id:r}=n;return this._client.get(_`/threads/${r}/runs/${t}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(t,n,s){const{thread_id:r,...a}=n;return this._client.post(_`/threads/${r}/runs/${t}`,{body:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(t,n={},s){return this._client.getAPIList(_`/threads/${t}/runs`,N,{query:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(t,n,s){const{thread_id:r}=n;return this._client.post(_`/threads/${r}/runs/${t}/cancel`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(t,n,s){const r=await this.create(t,n,s);return await this.poll(r.id,{thread_id:t},s)}createAndStream(t,n,s){return Je.createAssistantStream(t,this._client.beta.threads.runs,n,s)}async poll(t,n,s){const r=y([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:a,response:i}=await this.retrieve(t,n,{...s,headers:{...s?.headers,...r}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const l=i.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(o=u)}}await Ve(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(t,n,s){return Je.createAssistantStream(t,this._client.beta.threads.runs,n,s)}submitToolOutputs(t,n,s){const{thread_id:r,...a}=n;return this._client.post(_`/threads/${r}/runs/${t}/submit_tool_outputs`,{body:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:n.stream??!1})}async submitToolOutputsAndPoll(t,n,s){const r=await this.submitToolOutputs(t,n,s);return await this.poll(r.id,n,s)}submitToolOutputsStream(t,n,s){return Je.createToolAssistantStream(t,this._client.beta.threads.runs,n,s)}};Mn.Steps=sa;class qt extends I{constructor(){super(...arguments),this.runs=new Mn(this._client),this.messages=new na(this._client)}create(t={},n){return this._client.post("/threads",{body:t,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(t,n){return this._client.get(_`/threads/${t}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(t,n,s){return this._client.post(_`/threads/${t}`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(t,n){return this._client.delete(_`/threads/${t}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}createAndRun(t,n){return this._client.post("/threads/runs",{body:t,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers]),stream:t.stream??!1})}async createAndRunPoll(t,n){const s=await this.createAndRun(t,n);return await this.runs.poll(s.id,{thread_id:s.thread_id},n)}createAndRunStream(t,n){return Je.createThreadAssistantStream(t,this._client.beta.threads,n)}}qt.Runs=Mn;qt.Messages=na;class Se extends I{constructor(){super(...arguments),this.realtime=new Ft(this._client),this.chatkit=new Kt(this._client),this.assistants=new Gr(this._client),this.threads=new qt(this._client)}}Se.Realtime=Ft;Se.ChatKit=Kt;Se.Assistants=Gr;Se.Threads=qt;class ra extends I{create(t,n){return this._client.post("/completions",{body:t,...n,stream:t.stream??!1})}}class aa extends I{retrieve(t,n,s){const{container_id:r}=n;return this._client.get(_`/containers/${r}/files/${t}/content`,{...s,headers:y([{Accept:"application/binary"},s?.headers]),__binaryResponse:!0})}}let zn=class extends I{constructor(){super(...arguments),this.content=new aa(this._client)}create(t,n,s){return this._client.post(_`/containers/${t}/files`,Ae({body:n,...s},this._client))}retrieve(t,n,s){const{container_id:r}=n;return this._client.get(_`/containers/${r}/files/${t}`,s)}list(t,n={},s){return this._client.getAPIList(_`/containers/${t}/files`,N,{query:n,...s})}delete(t,n,s){const{container_id:r}=n;return this._client.delete(_`/containers/${r}/files/${t}`,{...s,headers:y([{Accept:"*/*"},s?.headers])})}};zn.Content=aa;class Un extends I{constructor(){super(...arguments),this.files=new zn(this._client)}create(t,n){return this._client.post("/containers",{body:t,...n})}retrieve(t,n){return this._client.get(_`/containers/${t}`,n)}list(t={},n){return this._client.getAPIList("/containers",N,{query:t,...n})}delete(t,n){return this._client.delete(_`/containers/${t}`,{...n,headers:y([{Accept:"*/*"},n?.headers])})}}Un.Files=zn;class ia extends I{create(t,n,s){const{include:r,...a}=n;return this._client.post(_`/conversations/${t}/items`,{query:{include:r},body:a,...s})}retrieve(t,n,s){const{conversation_id:r,...a}=n;return this._client.get(_`/conversations/${r}/items/${t}`,{query:a,...s})}list(t,n={},s){return this._client.getAPIList(_`/conversations/${t}/items`,It,{query:n,...s})}delete(t,n,s){const{conversation_id:r}=n;return this._client.delete(_`/conversations/${r}/items/${t}`,s)}}class Ln extends I{constructor(){super(...arguments),this.items=new ia(this._client)}create(t={},n){return this._client.post("/conversations",{body:t,...n})}retrieve(t,n){return this._client.get(_`/conversations/${t}`,n)}update(t,n,s){return this._client.post(_`/conversations/${t}`,{body:n,...s})}delete(t,n){return this._client.delete(_`/conversations/${t}`,n)}}Ln.Items=ia;class oa extends I{create(t,n){const s=!!t.encoding_format;let r=s?t.encoding_format:"base64";s&&F(this._client).debug("embeddings/user defined encoding_format:",t.encoding_format);const a=this._client.post("/embeddings",{body:{...t,encoding_format:r},...n});return s?a:(F(this._client).debug("embeddings/decoding base64 embeddings from base64"),a._thenUnwrap(i=>(i&&i.data&&i.data.forEach(o=>{const l=o.embedding;o.embedding=yo(l)}),i)))}}class ua extends I{retrieve(t,n,s){const{eval_id:r,run_id:a}=n;return this._client.get(_`/evals/${r}/runs/${a}/output_items/${t}`,s)}list(t,n,s){const{eval_id:r,...a}=n;return this._client.getAPIList(_`/evals/${r}/runs/${t}/output_items`,N,{query:a,...s})}}class Dn extends I{constructor(){super(...arguments),this.outputItems=new ua(this._client)}create(t,n,s){return this._client.post(_`/evals/${t}/runs`,{body:n,...s})}retrieve(t,n,s){const{eval_id:r}=n;return this._client.get(_`/evals/${r}/runs/${t}`,s)}list(t,n={},s){return this._client.getAPIList(_`/evals/${t}/runs`,N,{query:n,...s})}delete(t,n,s){const{eval_id:r}=n;return this._client.delete(_`/evals/${r}/runs/${t}`,s)}cancel(t,n,s){const{eval_id:r}=n;return this._client.post(_`/evals/${r}/runs/${t}`,s)}}Dn.OutputItems=ua;class jn extends I{constructor(){super(...arguments),this.runs=new Dn(this._client)}create(t,n){return this._client.post("/evals",{body:t,...n})}retrieve(t,n){return this._client.get(_`/evals/${t}`,n)}update(t,n,s){return this._client.post(_`/evals/${t}`,{body:n,...s})}list(t={},n){return this._client.getAPIList("/evals",N,{query:t,...n})}delete(t,n){return this._client.delete(_`/evals/${t}`,n)}}jn.Runs=Dn;let la=class extends I{create(t,n){return this._client.post("/files",Ae({body:t,...n},this._client))}retrieve(t,n){return this._client.get(_`/files/${t}`,n)}list(t={},n){return this._client.getAPIList("/files",N,{query:t,...n})}delete(t,n){return this._client.delete(_`/files/${t}`,n)}content(t,n){return this._client.get(_`/files/${t}/content`,{...n,headers:y([{Accept:"application/binary"},n?.headers]),__binaryResponse:!0})}async waitForProcessing(t,{pollInterval:n=5e3,maxWait:s=1800*1e3}={}){const r=new Set(["processed","error","deleted"]),a=Date.now();let i=await this.retrieve(t);for(;!i.status||!r.has(i.status);)if(await Ve(n),i=await this.retrieve(t),Date.now()-a>s)throw new Lt({message:`Giving up on waiting for file ${t} to finish processing after ${s} milliseconds.`});return i}};class ca extends I{}let pa=class extends I{run(t,n){return this._client.post("/fine_tuning/alpha/graders/run",{body:t,...n})}validate(t,n){return this._client.post("/fine_tuning/alpha/graders/validate",{body:t,...n})}};class Bn extends I{constructor(){super(...arguments),this.graders=new pa(this._client)}}Bn.Graders=pa;class da extends I{create(t,n,s){return this._client.getAPIList(_`/fine_tuning/checkpoints/${t}/permissions`,Bt,{body:n,method:"post",...s})}retrieve(t,n={},s){return this._client.get(_`/fine_tuning/checkpoints/${t}/permissions`,{query:n,...s})}delete(t,n,s){const{fine_tuned_model_checkpoint:r}=n;return this._client.delete(_`/fine_tuning/checkpoints/${r}/permissions/${t}`,s)}}let Fn=class extends I{constructor(){super(...arguments),this.permissions=new da(this._client)}};Fn.Permissions=da;class ha extends I{list(t,n={},s){return this._client.getAPIList(_`/fine_tuning/jobs/${t}/checkpoints`,N,{query:n,...s})}}class Kn extends I{constructor(){super(...arguments),this.checkpoints=new ha(this._client)}create(t,n){return this._client.post("/fine_tuning/jobs",{body:t,...n})}retrieve(t,n){return this._client.get(_`/fine_tuning/jobs/${t}`,n)}list(t={},n){return this._client.getAPIList("/fine_tuning/jobs",N,{query:t,...n})}cancel(t,n){return this._client.post(_`/fine_tuning/jobs/${t}/cancel`,n)}listEvents(t,n={},s){return this._client.getAPIList(_`/fine_tuning/jobs/${t}/events`,N,{query:n,...s})}pause(t,n){return this._client.post(_`/fine_tuning/jobs/${t}/pause`,n)}resume(t,n){return this._client.post(_`/fine_tuning/jobs/${t}/resume`,n)}}Kn.Checkpoints=ha;class Pe extends I{constructor(){super(...arguments),this.methods=new ca(this._client),this.jobs=new Kn(this._client),this.checkpoints=new Fn(this._client),this.alpha=new Bn(this._client)}}Pe.Methods=ca;Pe.Jobs=Kn;Pe.Checkpoints=Fn;Pe.Alpha=Bn;class fa extends I{}class qn extends I{constructor(){super(...arguments),this.graderModels=new fa(this._client)}}qn.GraderModels=fa;class ma extends I{createVariation(t,n){return this._client.post("/images/variations",Ae({body:t,...n},this._client))}edit(t,n){return this._client.post("/images/edits",Ae({body:t,...n,stream:t.stream??!1},this._client))}generate(t,n){return this._client.post("/images/generations",{body:t,...n,stream:t.stream??!1})}}class ga extends I{retrieve(t,n){return this._client.get(_`/models/${t}`,n)}list(t){return this._client.getAPIList("/models",Bt,t)}delete(t,n){return this._client.delete(_`/models/${t}`,n)}}class _a extends I{create(t,n){return this._client.post("/moderations",{body:t,...n})}}class ya extends I{accept(t,n,s){return this._client.post(_`/realtime/calls/${t}/accept`,{body:n,...s,headers:y([{Accept:"*/*"},s?.headers])})}hangup(t,n){return this._client.post(_`/realtime/calls/${t}/hangup`,{...n,headers:y([{Accept:"*/*"},n?.headers])})}refer(t,n,s){return this._client.post(_`/realtime/calls/${t}/refer`,{body:n,...s,headers:y([{Accept:"*/*"},s?.headers])})}reject(t,n={},s){return this._client.post(_`/realtime/calls/${t}/reject`,{body:n,...s,headers:y([{Accept:"*/*"},s?.headers])})}}class wa extends I{create(t,n){return this._client.post("/realtime/client_secrets",{body:t,...n})}}class Wt extends I{constructor(){super(...arguments),this.clientSecrets=new wa(this._client),this.calls=new ya(this._client)}}Wt.ClientSecrets=wa;Wt.Calls=ya;function bo(e,t){return!t||!Io(t)?{...e,output_parsed:null,output:e.output.map(n=>n.type==="function_call"?{...n,parsed_arguments:null}:n.type==="message"?{...n,content:n.content.map(s=>({...s,parsed:null}))}:n)}:ba(e,t)}function ba(e,t){const n=e.output.map(r=>{if(r.type==="function_call")return{...r,parsed_arguments:xo(t,r)};if(r.type==="message"){const a=r.content.map(i=>i.type==="output_text"?{...i,parsed:Ao(t,i.text)}:i);return{...r,content:a}}return r}),s=Object.assign({},e,{output:n});return Object.getOwnPropertyDescriptor(e,"output_text")||yn(s),Object.defineProperty(s,"output_parsed",{enumerable:!0,get(){for(const r of s.output)if(r.type==="message"){for(const a of r.content)if(a.type==="output_text"&&a.parsed!==null)return a.parsed}return null}}),s}function Ao(e,t){return e.text?.format?.type!=="json_schema"?null:"$parseRaw"in e.text?.format?(e.text?.format).$parseRaw(t):JSON.parse(t)}function Io(e){return!!Sn(e.text?.format)}function Oo(e){return e?.$brand==="auto-parseable-tool"}function vo(e,t){return e.find(n=>n.type==="function"&&n.name===t)}function xo(e,t){const n=vo(e.tools??[],t.name);return{...t,...t,parsed_arguments:Oo(n)?n.$parseRaw(t.arguments):n?.strict?JSON.parse(t.arguments):null}}function yn(e){const t=[];for(const n of e.output)if(n.type==="message")for(const s of n.content)s.type==="output_text"&&t.push(s.text);e.output_text=t.join("")}var Oe,ot,he,ut,Ms,zs,Us,Ls;class Wn extends Rn{constructor(t){super(),Oe.add(this),ot.set(this,void 0),he.set(this,void 0),ut.set(this,void 0),O(this,ot,t)}static createResponse(t,n,s){const r=new Wn(n);return r._run(()=>r._createOrRetrieveResponse(t,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createOrRetrieveResponse(t,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),p(this,Oe,"m",Ms).call(this);let a,i=null;"response_id"in n?(a=await t.responses.retrieve(n.response_id,{stream:!0},{...s,signal:this.controller.signal,stream:!0}),i=n.starting_after??null):a=await t.responses.create({...n,stream:!0},{...s,signal:this.controller.signal}),this._connected();for await(const o of a)p(this,Oe,"m",zs).call(this,o,i);if(a.controller.signal?.aborted)throw new ee;return p(this,Oe,"m",Us).call(this)}[(ot=new WeakMap,he=new WeakMap,ut=new WeakMap,Oe=new WeakSet,Ms=function(){this.ended||O(this,he,void 0)},zs=function(n,s){if(this.ended)return;const r=(i,o)=>{(s==null||o.sequence_number>s)&&this._emit(i,o)},a=p(this,Oe,"m",Ls).call(this,n);switch(r("event",n),n.type){case"response.output_text.delta":{const i=a.output[n.output_index];if(!i)throw new A(`missing output at index ${n.output_index}`);if(i.type==="message"){const o=i.content[n.content_index];if(!o)throw new A(`missing content at index ${n.content_index}`);if(o.type!=="output_text")throw new A(`expected content to be 'output_text', got ${o.type}`);r("response.output_text.delta",{...n,snapshot:o.text})}break}case"response.function_call_arguments.delta":{const i=a.output[n.output_index];if(!i)throw new A(`missing output at index ${n.output_index}`);i.type==="function_call"&&r("response.function_call_arguments.delta",{...n,snapshot:i.arguments});break}default:r(n.type,n);break}},Us=function(){if(this.ended)throw new A("stream has ended, this shouldn't happen");const n=p(this,he,"f");if(!n)throw new A("request ended without sending any events");O(this,he,void 0);const s=ko(n,p(this,ot,"f"));return O(this,ut,s),s},Ls=function(n){let s=p(this,he,"f");if(!s){if(n.type!=="response.created")throw new A(`When snapshot hasn't been set yet, expected 'response.created' event, got ${n.type}`);return s=O(this,he,n.response),s}switch(n.type){case"response.output_item.added":{s.output.push(n.item);break}case"response.content_part.added":{const r=s.output[n.output_index];if(!r)throw new A(`missing output at index ${n.output_index}`);const a=r.type,i=n.part;a==="message"&&i.type!=="reasoning_text"?r.content.push(i):a==="reasoning"&&i.type==="reasoning_text"&&(r.content||(r.content=[]),r.content.push(i));break}case"response.output_text.delta":{const r=s.output[n.output_index];if(!r)throw new A(`missing output at index ${n.output_index}`);if(r.type==="message"){const a=r.content[n.content_index];if(!a)throw new A(`missing content at index ${n.content_index}`);if(a.type!=="output_text")throw new A(`expected content to be 'output_text', got ${a.type}`);a.text+=n.delta}break}case"response.function_call_arguments.delta":{const r=s.output[n.output_index];if(!r)throw new A(`missing output at index ${n.output_index}`);r.type==="function_call"&&(r.arguments+=n.delta);break}case"response.reasoning_text.delta":{const r=s.output[n.output_index];if(!r)throw new A(`missing output at index ${n.output_index}`);if(r.type==="reasoning"){const a=r.content?.[n.content_index];if(!a)throw new A(`missing content at index ${n.content_index}`);if(a.type!=="reasoning_text")throw new A(`expected content to be 'reasoning_text', got ${a.type}`);a.text+=n.delta}break}case"response.completed":{O(this,he,n.response);break}}return s},Symbol.asyncIterator)](){const t=[],n=[];let s=!1;return this.on("event",r=>{const a=n.shift();a?a.resolve(r):t.push(r)}),this.on("end",()=>{s=!0;for(const r of n)r.resolve(void 0);n.length=0}),this.on("abort",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),this.on("error",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),{next:async()=>t.length?{value:t.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const t=p(this,ut,"f");if(!t)throw new A("stream ended without producing a ChatCompletion");return t}}function ko(e,t){return bo(e,t)}class Aa extends I{list(t,n={},s){return this._client.getAPIList(_`/responses/${t}/input_items`,N,{query:n,...s})}}class Ia extends I{count(t={},n){return this._client.post("/responses/input_tokens",{body:t,...n})}}class Zt extends I{constructor(){super(...arguments),this.inputItems=new Aa(this._client),this.inputTokens=new Ia(this._client)}create(t,n){return this._client.post("/responses",{body:t,...n,stream:t.stream??!1})._thenUnwrap(s=>("object"in s&&s.object==="response"&&yn(s),s))}retrieve(t,n={},s){return this._client.get(_`/responses/${t}`,{query:n,...s,stream:n?.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&yn(r),r))}delete(t,n){return this._client.delete(_`/responses/${t}`,{...n,headers:y([{Accept:"*/*"},n?.headers])})}parse(t,n){return this._client.responses.create(t,n)._thenUnwrap(s=>ba(s,t))}stream(t,n){return Wn.createResponse(this._client,t,n)}cancel(t,n){return this._client.post(_`/responses/${t}/cancel`,n)}compact(t,n){return this._client.post("/responses/compact",{body:t,...n})}}Zt.InputItems=Aa;Zt.InputTokens=Ia;class Oa extends I{create(t,n,s){return this._client.post(_`/uploads/${t}/parts`,Ae({body:n,...s},this._client))}}class Zn extends I{constructor(){super(...arguments),this.parts=new Oa(this._client)}create(t,n){return this._client.post("/uploads",{body:t,...n})}cancel(t,n){return this._client.post(_`/uploads/${t}/cancel`,n)}complete(t,n,s){return this._client.post(_`/uploads/${t}/complete`,{body:n,...s})}}Zn.Parts=Oa;const To=async e=>{const t=await Promise.allSettled(e),n=t.filter(r=>r.status==="rejected");if(n.length){for(const r of n)console.error(r.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const s=[];for(const r of t)r.status==="fulfilled"&&s.push(r.value);return s};class va extends I{create(t,n,s){return this._client.post(_`/vector_stores/${t}/file_batches`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(t,n,s){const{vector_store_id:r}=n;return this._client.get(_`/vector_stores/${r}/file_batches/${t}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(t,n,s){const{vector_store_id:r}=n;return this._client.post(_`/vector_stores/${r}/file_batches/${t}/cancel`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(t,n,s){const r=await this.create(t,n);return await this.poll(t,r.id,s)}listFiles(t,n,s){const{vector_store_id:r,...a}=n;return this._client.getAPIList(_`/vector_stores/${r}/file_batches/${t}/files`,N,{query:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async poll(t,n,s){const r=y([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:a,response:i}=await this.retrieve(n,{vector_store_id:t},{...s,headers:r}).withResponse();switch(a.status){case"in_progress":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const l=i.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(o=u)}}await Ve(o);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(t,{files:n,fileIds:s=[]},r){if(n==null||n.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=r?.maxConcurrency??5,i=Math.min(a,n.length),o=this._client,l=n.values(),u=[...s];async function m(f){for(let c of f){const w=await o.files.create({file:c,purpose:"assistants"},r);u.push(w.id)}}const d=Array(i).fill(l).map(m);return await To(d),await this.createAndPoll(t,{file_ids:u})}}class xa extends I{create(t,n,s){return this._client.post(_`/vector_stores/${t}/files`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(t,n,s){const{vector_store_id:r}=n;return this._client.get(_`/vector_stores/${r}/files/${t}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(t,n,s){const{vector_store_id:r,...a}=n;return this._client.post(_`/vector_stores/${r}/files/${t}`,{body:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(t,n={},s){return this._client.getAPIList(_`/vector_stores/${t}/files`,N,{query:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(t,n,s){const{vector_store_id:r}=n;return this._client.delete(_`/vector_stores/${r}/files/${t}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(t,n,s){const r=await this.create(t,n,s);return await this.poll(t,r.id,s)}async poll(t,n,s){const r=y([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const a=await this.retrieve(n,{vector_store_id:t},{...s,headers:r}).withResponse(),i=a.data;switch(i.status){case"in_progress":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const l=a.response.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(o=u)}}await Ve(o);break;case"failed":case"completed":return i}}}async upload(t,n,s){const r=await this._client.files.create({file:n,purpose:"assistants"},s);return this.create(t,{file_id:r.id},s)}async uploadAndPoll(t,n,s){const r=await this.upload(t,n,s);return await this.poll(t,r.id,s)}content(t,n,s){const{vector_store_id:r}=n;return this._client.getAPIList(_`/vector_stores/${r}/files/${t}/content`,Bt,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class Jt extends I{constructor(){super(...arguments),this.files=new xa(this._client),this.fileBatches=new va(this._client)}create(t,n){return this._client.post("/vector_stores",{body:t,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(t,n){return this._client.get(_`/vector_stores/${t}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(t,n,s){return this._client.post(_`/vector_stores/${t}`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(t={},n){return this._client.getAPIList("/vector_stores",N,{query:t,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(t,n){return this._client.delete(_`/vector_stores/${t}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}search(t,n,s){return this._client.getAPIList(_`/vector_stores/${t}/search`,Bt,{body:n,method:"post",...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}Jt.Files=xa;Jt.FileBatches=va;class ka extends I{create(t,n){return this._client.post("/videos",Os({body:t,...n},this._client))}retrieve(t,n){return this._client.get(_`/videos/${t}`,n)}list(t={},n){return this._client.getAPIList("/videos",It,{query:t,...n})}delete(t,n){return this._client.delete(_`/videos/${t}`,n)}downloadContent(t,n={},s){return this._client.get(_`/videos/${t}/content`,{query:n,...s,headers:y([{Accept:"application/binary"},s?.headers]),__binaryResponse:!0})}remix(t,n,s){return this._client.post(_`/videos/${t}/remix`,Os({body:n,...s},this._client))}}var ke,Ta,yt;class Ca extends I{constructor(){super(...arguments),ke.add(this)}async unwrap(t,n,s=this._client.webhookSecret,r=300){return await this.verifySignature(t,n,s,r),JSON.parse(t)}async verifySignature(t,n,s=this._client.webhookSecret,r=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");p(this,ke,"m",Ta).call(this,s);const a=y([n]).values,i=p(this,ke,"m",yt).call(this,a,"webhook-signature"),o=p(this,ke,"m",yt).call(this,a,"webhook-timestamp"),l=p(this,ke,"m",yt).call(this,a,"webhook-id"),u=parseInt(o,10);if(isNaN(u))throw new ze("Invalid webhook timestamp format");const m=Math.floor(Date.now()/1e3);if(m-u>r)throw new ze("Webhook timestamp is too old");if(u>m+r)throw new ze("Webhook timestamp is too new");const d=i.split(" ").map(b=>b.startsWith("v1,")?b.substring(3):b),f=s.startsWith("whsec_")?Buffer.from(s.replace("whsec_",""),"base64"):Buffer.from(s,"utf-8"),c=l?`${l}.${o}.${t}`:`${o}.${t}`,w=await crypto.subtle.importKey("raw",f,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const b of d)try{const C=Buffer.from(b,"base64");if(await crypto.subtle.verify("HMAC",w,C,new TextEncoder().encode(c)))return}catch{continue}throw new ze("The given webhook signature does not match the expected signature")}}ke=new WeakSet,Ta=function(t){if(typeof t!="string"||t.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},yt=function(t,n){if(!t)throw new Error("Headers are required");const s=t.get(n);if(s==null)throw new Error(`Missing required header: ${n}`);return s};var wn,Jn,wt,Sa;class v{constructor({baseURL:t=pe("OPENAI_BASE_URL"),apiKey:n=pe("OPENAI_API_KEY"),organization:s=pe("OPENAI_ORG_ID")??null,project:r=pe("OPENAI_PROJECT_ID")??null,webhookSecret:a=pe("OPENAI_WEBHOOK_SECRET")??null,...i}={}){if(wn.add(this),wt.set(this,void 0),this.completions=new ra(this),this.chat=new Nn(this),this.embeddings=new oa(this),this.files=new la(this),this.images=new ma(this),this.audio=new Ge(this),this.moderations=new _a(this),this.models=new ga(this),this.fineTuning=new Pe(this),this.graders=new qn(this),this.vectorStores=new Jt(this),this.webhooks=new Ca(this),this.beta=new Se(this),this.batches=new Xr(this),this.uploads=new Zn(this),this.responses=new Zt(this),this.realtime=new Wt(this),this.conversations=new Ln(this),this.evals=new jn(this),this.containers=new Un(this),this.videos=new ka(this),n===void 0)throw new A("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");const o={apiKey:n,organization:s,project:r,webhookSecret:a,...i,baseURL:t||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&ki())throw new A(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=o.baseURL,this.timeout=o.timeout??Jn.DEFAULT_TIMEOUT,this.logger=o.logger??console;const l="warn";this.logLevel=l,this.logLevel=As(o.logLevel,"ClientOptions.logLevel",this)??As(pe("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??l,this.fetchOptions=o.fetchOptions,this.maxRetries=o.maxRetries??2,this.fetch=o.fetch??Ri(),O(this,wt,$i),this._options=o,this.apiKey=typeof n=="string"?n:"Missing Key",this.organization=s,this.project=r,this.webhookSecret=a}withOptions(t){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...t})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:t,nulls:n}){}async authHeaders(t){return y([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(t){return Di(t,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${ve}`}defaultIdempotencyKey(){return`stainless-node-retry-${Ys()}`}makeStatusError(t,n,s,r){return q.generate(t,n,s,r)}async _callApiKey(){const t=this._options.apiKey;if(typeof t!="function")return!1;let n;try{n=await t()}catch(s){throw s instanceof A?s:new A(`Failed to get token from 'apiKey' function: ${s.message}`,{cause:s})}if(typeof n!="string"||!n)throw new A(`Expected 'apiKey' function argument to return a string but it returned ${n}`);return this.apiKey=n,!0}buildURL(t,n,s){const r=!p(this,wn,"m",Sa).call(this)&&s||this.baseURL,a=Ai(t)?new URL(t):new URL(r+(r.endsWith("/")&&t.startsWith("/")?t.slice(1):t)),i=this.defaultQuery();return Ii(i)||(n={...i,...n}),typeof n=="object"&&n&&!Array.isArray(n)&&(a.search=this.stringifyQuery(n)),a.toString()}async prepareOptions(t){await this._callApiKey()}async prepareRequest(t,{url:n,options:s}){}get(t,n){return this.methodRequest("get",t,n)}post(t,n){return this.methodRequest("post",t,n)}patch(t,n){return this.methodRequest("patch",t,n)}put(t,n){return this.methodRequest("put",t,n)}delete(t,n){return this.methodRequest("delete",t,n)}methodRequest(t,n,s){return this.request(Promise.resolve(s).then(r=>({method:t,path:n,...r})))}request(t,n=null){return new jt(this,this.makeRequest(t,n,void 0))}async makeRequest(t,n,s){const r=await t,a=r.maxRetries??this.maxRetries;n==null&&(n=a),await this.prepareOptions(r);const{req:i,url:o,timeout:l}=await this.buildRequest(r,{retryCount:a-n});await this.prepareRequest(i,{url:o,options:r});const u="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),m=s===void 0?"":`, retryOf: ${s}`,d=Date.now();if(F(this).debug(`[${u}] sending request`,me({retryOfRequestLogID:s,method:r.method,url:o,options:r,headers:i.headers})),r.signal?.aborted)throw new ee;const f=new AbortController,c=await this.fetchWithTimeout(o,i,l,f).catch(on),w=Date.now();if(c instanceof globalThis.Error){const h=`retrying, ${n} attempts remaining`;if(r.signal?.aborted)throw new ee;const g=an(c)||/timed? ?out/i.test(String(c)+("cause"in c?String(c.cause):""));if(n)return F(this).info(`[${u}] connection ${g?"timed out":"failed"} - ${h}`),F(this).debug(`[${u}] connection ${g?"timed out":"failed"} (${h})`,me({retryOfRequestLogID:s,url:o,durationMs:w-d,message:c.message})),this.retryRequest(r,n,s??u);throw F(this).info(`[${u}] connection ${g?"timed out":"failed"} - error; no more retries left`),F(this).debug(`[${u}] connection ${g?"timed out":"failed"} (error; no more retries left)`,me({retryOfRequestLogID:s,url:o,durationMs:w-d,message:c.message})),g?new Lt:new Ut({cause:c})}const b=[...c.headers.entries()].filter(([h])=>h==="x-request-id").map(([h,g])=>", "+h+": "+JSON.stringify(g)).join(""),C=`[${u}${m}${b}] ${i.method} ${o} ${c.ok?"succeeded":"failed"} with status ${c.status} in ${w-d}ms`;if(!c.ok){const h=await this.shouldRetry(c);if(n&&h){const E=`retrying, ${n} attempts remaining`;return await Ei(c.body),F(this).info(`${C} - ${E}`),F(this).debug(`[${u}] response error (${E})`,me({retryOfRequestLogID:s,url:c.url,status:c.status,headers:c.headers,durationMs:w-d})),this.retryRequest(r,n,s??u,c.headers)}const g=h?"error; no more retries left":"error; not retryable";F(this).info(`${C} - ${g}`);const k=await c.text().catch(E=>on(E).message),S=xi(k),J=S?void 0:k;throw F(this).debug(`[${u}] response error (${g})`,me({retryOfRequestLogID:s,url:c.url,status:c.status,headers:c.headers,message:J,durationMs:Date.now()-d})),this.makeStatusError(c.status,S,J,c.headers)}return F(this).info(C),F(this).debug(`[${u}] response start`,me({retryOfRequestLogID:s,url:c.url,status:c.status,headers:c.headers,durationMs:w-d})),{response:c,options:r,controller:f,requestLogID:u,retryOfRequestLogID:s,startTime:d}}getAPIList(t,n,s){return this.requestAPIList(n,{method:"get",path:t,...s})}requestAPIList(t,n){const s=this.makeRequest(n,null,void 0);return new Hi(this,s,t)}async fetchWithTimeout(t,n,s,r){const{signal:a,method:i,...o}=n||{};a&&a.addEventListener("abort",()=>r.abort());const l=setTimeout(()=>r.abort(),s),u=globalThis.ReadableStream&&o.body instanceof globalThis.ReadableStream||typeof o.body=="object"&&o.body!==null&&Symbol.asyncIterator in o.body,m={signal:r.signal,...u?{duplex:"half"}:{},method:"GET",...o};i&&(m.method=i.toUpperCase());try{return await this.fetch.call(void 0,t,m)}finally{clearTimeout(l)}}async shouldRetry(t){const n=t.headers.get("x-should-retry");return n==="true"?!0:n==="false"?!1:t.status===408||t.status===409||t.status===429||t.status>=500}async retryRequest(t,n,s,r){let a;const i=r?.get("retry-after-ms");if(i){const l=parseFloat(i);Number.isNaN(l)||(a=l)}const o=r?.get("retry-after");if(o&&!a){const l=parseFloat(o);Number.isNaN(l)?a=Date.parse(o)-Date.now():a=l*1e3}if(!(a&&0<=a&&a<60*1e3)){const l=t.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(n,l)}return await Ve(a),this.makeRequest(t,n-1,s)}calculateDefaultRetryTimeoutMillis(t,n){const a=n-t,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}async buildRequest(t,{retryCount:n=0}={}){const s={...t},{method:r,path:a,query:i,defaultBaseURL:o}=s,l=this.buildURL(a,i,o);"timeout"in s&&vi("timeout",s.timeout),s.timeout=s.timeout??this.timeout;const{bodyHeaders:u,body:m}=this.buildBody({options:s}),d=await this.buildHeaders({options:t,method:r,bodyHeaders:u,retryCount:n});return{req:{method:r,headers:d,...s.signal&&{signal:s.signal},...globalThis.ReadableStream&&m instanceof globalThis.ReadableStream&&{duplex:"half"},...m&&{body:m},...this.fetchOptions??{},...s.fetchOptions??{}},url:l,timeout:s.timeout}}async buildHeaders({options:t,method:n,bodyHeaders:s,retryCount:r}){let a={};this.idempotencyHeader&&n!=="get"&&(t.idempotencyKey||(t.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=t.idempotencyKey);const i=y([a,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r),...t.timeout?{"X-Stainless-Timeout":String(Math.trunc(t.timeout/1e3))}:{},...Pi(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(t),this._options.defaultHeaders,s,t.headers]);return this.validateHeaders(i),i.values}buildBody({options:{body:t,headers:n}}){if(!t)return{bodyHeaders:void 0,body:void 0};const s=y([n]);return ArrayBuffer.isView(t)||t instanceof ArrayBuffer||t instanceof DataView||typeof t=="string"&&s.values.has("content-type")||globalThis.Blob&&t instanceof globalThis.Blob||t instanceof FormData||t instanceof URLSearchParams||globalThis.ReadableStream&&t instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:t}:typeof t=="object"&&(Symbol.asyncIterator in t||Symbol.iterator in t&&"next"in t&&typeof t.next=="function")?{bodyHeaders:void 0,body:pr(t)}:p(this,wt,"f").call(this,{body:t,headers:s})}}Jn=v,wt=new WeakMap,wn=new WeakSet,Sa=function(){return this.baseURL!=="https://api.openai.com/v1"};v.OpenAI=Jn;v.DEFAULT_TIMEOUT=6e5;v.OpenAIError=A;v.APIError=q;v.APIConnectionError=Ut;v.APIConnectionTimeoutError=Lt;v.APIUserAbortError=ee;v.NotFoundError=nr;v.ConflictError=sr;v.RateLimitError=ar;v.BadRequestError=Qs;v.AuthenticationError=er;v.InternalServerError=ir;v.PermissionDeniedError=tr;v.UnprocessableEntityError=rr;v.InvalidWebhookSignatureError=ze;v.toFile=Qi;v.Completions=ra;v.Chat=Nn;v.Embeddings=oa;v.Files=la;v.Images=ma;v.Audio=Ge;v.Moderations=_a;v.Models=ga;v.FineTuning=Pe;v.Graders=qn;v.VectorStores=Jt;v.Webhooks=Ca;v.Beta=Se;v.Batches=Xr;v.Uploads=Zn;v.Responses=Zt;v.Realtime=Wt;v.Conversations=Ln;v.Evals=jn;v.Containers=Un;v.Videos=ka;var Co={};class Hn extends v{constructor({baseURL:t=pe("OPENAI_BASE_URL"),apiKey:n=pe("AZURE_OPENAI_API_KEY"),apiVersion:s=pe("OPENAI_API_VERSION"),endpoint:r,deployment:a,azureADTokenProvider:i,dangerouslyAllowBrowser:o,...l}={}){if(!s)throw new A("The OPENAI_API_VERSION environment variable is missing or empty; either provide it, or instantiate the AzureOpenAI client with an apiVersion option, like new AzureOpenAI({ apiVersion: 'My API Version' }).");if(typeof i=="function"&&(o=!0),!i&&!n)throw new A("Missing credentials. Please pass one of `apiKey` and `azureADTokenProvider`, or set the `AZURE_OPENAI_API_KEY` environment variable.");if(i&&n)throw new A("The `apiKey` and `azureADTokenProvider` arguments are mutually exclusive; only one can be passed at a time.");if(l.defaultQuery={...l.defaultQuery,"api-version":s},t){if(r)throw new A("baseURL and endpoint are mutually exclusive")}else{if(r||(r=Co.AZURE_OPENAI_ENDPOINT),!r)throw new A("Must provide one of the `baseURL` or `endpoint` arguments, or the `AZURE_OPENAI_ENDPOINT` environment variable");t=`${r}/openai`}super({apiKey:i??n,baseURL:t,...l,...o!==void 0?{dangerouslyAllowBrowser:o}:{}}),this.apiVersion="",this.apiVersion=s,this.deploymentName=a}async buildRequest(t,n={}){if(So.has(t.path)&&t.method==="post"&&t.body!==void 0){if(!ct(t.body))throw new Error("Expected request body to be an object");const s=this.deploymentName||t.body.model||t.__metadata?.model;s!==void 0&&!this.baseURL.includes("/deployments")&&(t.path=`/deployments/${s}${t.path}`)}return super.buildRequest(t,n)}async authHeaders(t){return typeof this._options.apiKey=="string"?y([{"api-key":this.apiKey}]):super.authHeaders(t)}}const So=new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations","/batches","/images/edits"]);function Re(e){if(!e||typeof e!="object")return e;let t;return e.constructor.name===Lt.name&&"message"in e&&typeof e.message=="string"?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===ee.name&&"message"in e&&typeof e.message=="string"?(t=new Error(e.message),t.name="AbortError"):"status"in e&&e.status===400&&"message"in e&&typeof e.message=="string"&&e.message.includes("tool_calls")?t=tt(e,"INVALID_TOOL_RESULTS"):"status"in e&&e.status===401?t=tt(e,"MODEL_AUTHENTICATION"):"status"in e&&e.status===429?t=tt(e,"MODEL_RATE_LIMIT"):"status"in e&&e.status===404?t=tt(e,"MODEL_NOT_FOUND"):t=e,t}const be=e=>e();function Ye(e){return e?!!(/^o\d/.test(e??"")||e.startsWith("gpt-5")&&!e.startsWith("gpt-5-chat")):!1}function Po(e){return e.role!=="system"&&e.role!=="developer"&&e.role!=="assistant"&&e.role!=="user"&&e.role!=="function"&&e.role!=="tool"&&console.warn(`Unknown message role: ${e.role}`),e.role}function Ds(e){return e.metadata?.filename??e.metadata?.name??e.metadata?.title}function Pt(e){const t=e.metadata?.filename??e.metadata?.name??e.metadata?.title;if(!t)throw new Error("a filename or name or title is needed via meta-data for OpenAI when working with multimodal blocks");return t}function Qe(e){const t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!Zs.isInstance(e))throw new Error("Invalid generic chat message");return Po(e);default:throw new Error(`Unknown message type: ${t}`)}}function Ro(e){return e.includes("gpt-5.2-pro")}function Ee(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:s,azureOpenAIBasePath:r,baseURL:a,azureADTokenProvider:i,azureOpenAIEndpoint:o}=e;if((s||i)&&r&&t)return`${r}/${t}`;if((s||i)&&o&&t)return`${o}/openai/deployments/${t}`;if(s||i){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${t}`}return a}function js(e){return typeof Headers<"u"&&e!==null&&typeof e=="object"&&Object.prototype.toString.call(e)==="[object Headers]"}function Eo(e){const t=be(()=>{if(js(e))return e;if(Array.isArray(e))return new Headers(e);if(typeof e=="object"&&e!==null&&"values"in e&&js(e.values))return e.values;if(typeof e=="object"&&e!==null){const n=Object.entries(e).filter(([,s])=>typeof s=="string").map(([s,r])=>[s,r]);return new Headers(n)}return new Headers});return Object.fromEntries(t.entries())}function $o(){let e=Za();return(e==="node"||e==="deno")&&(e=`(${e}/${process.version}; browser; ${process.arch})`),e}function $e(e,t=!1,n="1.0.0"){const s=Eo(e),r=$o(),a=`langchainjs${t?"-azure":""}-openai`;return{...s,"User-Agent":s["User-Agent"]?`${a}/${n} (${r})${s["User-Agent"]}`:`${a}/${n} (${r})`}}function No(e,t){let n;return pi(e)?n=di(e):n=e,t?.strict!==void 0&&(n.function.strict=t.strict),n}function Mo(e){return e.anyOf!==void 0&&Array.isArray(e.anyOf)}function zo(e){const t=["namespace functions {",""];for(const n of e)n.description&&t.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(t.push(`type ${n.name} = (_: {`),t.push(Pa(n.parameters,0)),t.push("}) => any;")):t.push(`type ${n.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join(`
`)}function Pa(e,t){const n=[];for(const[s,r]of Object.entries(e.properties??{}))r.description&&t<2&&n.push(`// ${r.description}`),e.required?.includes(s)?n.push(`${s}: ${Rt(r,t)},`):n.push(`${s}?: ${Rt(r,t)},`);return n.map(s=>" ".repeat(t)+s).join(`
`)}function Rt(e,t){if(Mo(e))return e.anyOf.map(n=>Rt(n,t)).join(" | ");switch(e.type){case"string":return e.enum?e.enum.map(n=>`"${n}"`).join(" | "):"string";case"number":return e.enum?e.enum.map(n=>`${n}`).join(" | "):"number";case"integer":return e.enum?e.enum.map(n=>`${n}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Pa(e,t+2),"}"].join(`
`);case"array":return e.items?`${Rt(e.items,t)}[]`:"any[]";default:return""}}function Ra(e){if(e)return e==="any"||e==="required"?"required":e==="auto"?"auto":e==="none"?"none":typeof e=="string"?{type:"function",function:{name:e}}:e}function Vn(e){return"type"in e&&e.type!=="function"}function Uo(e){return typeof e=="object"&&e!==null&&"extras"in e&&typeof e.extras=="object"&&e.extras!==null&&"providerToolDefinition"in e.extras&&typeof e.extras.providerToolDefinition=="object"&&e.extras.providerToolDefinition!==null}function Lo(e){return e!=null&&typeof e=="object"&&"type"in e&&e.type!=="function"}function Et(e){return typeof e=="object"&&e!==null&&"metadata"in e&&typeof e.metadata=="object"&&e.metadata!==null&&"customTool"in e.metadata&&typeof e.metadata.customTool=="object"&&e.metadata.customTool!==null}function Ea(e){return"type"in e&&e.type==="custom"&&"custom"in e&&typeof e.custom=="object"&&e.custom!==null}function Do(e){if(e.type==="custom_tool_call")return{...e,type:"tool_call",call_id:e.id,id:e.call_id,name:e.name,isCustomTool:!0,args:{input:e.input}}}function jo(e){if(e.type==="computer_call")return{...e,type:"tool_call",call_id:e.id,id:e.call_id,name:"computer_use",isComputerTool:!0,args:{action:e.action}}}function Bo(e){return typeof e=="object"&&e!==null&&"type"in e&&e.type==="tool_call"&&"isComputerTool"in e&&e.isComputerTool===!0}function Fo(e){return typeof e=="object"&&e!==null&&"type"in e&&e.type==="tool_call"&&"isCustomTool"in e&&e.isCustomTool===!0}function Ko(e){const t=()=>{if(e.custom.format){if(e.custom.format.type==="grammar")return{type:"grammar",definition:e.custom.format.grammar.definition,syntax:e.custom.format.grammar.syntax};if(e.custom.format.type==="text")return{type:"text"}}};return{type:"custom",name:e.custom.name,description:e.custom.description,format:t()}}function qo(e){const t=()=>{if(e.format){if(e.format.type==="grammar")return{type:"grammar",grammar:{definition:e.format.definition,syntax:e.format.syntax}};if(e.format.type==="text")return{type:"text"}}};return{type:"custom",custom:{name:e.name,description:e.description,format:t()}}}const Wo=Symbol("Let zodToJsonSchema decide on which parser to use"),Bs={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Zo=e=>typeof e=="string"?{...Bs,basePath:["#"],definitions:{},name:e}:{...Bs,basePath:["#"],definitions:{},...e},bn=e=>"_def"in e?e._def:e;function Jo(e){if(!e)return!0;for(const t in e)return!1;return!0}const Ho=e=>{const t=Zo(e),n=t.name!==void 0?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([s,r])=>[bn(r),{def:bn(r),path:[...t.basePath,t.definitionPath,s],jsonSchema:void 0}]))}};function $a(e,t,n,s){s?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function P(e,t,n,s,r){e[t]=n,$a(e,t,s,r)}function Vo(){return{}}function Xo(e,t){const n={type:"array"};return e.type?._def?.typeName!==x.ZodAny&&(n.items=T(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&P(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&P(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(P(n,"minItems",e.exactLength.value,e.exactLength.message,t),P(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}function Go(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const s of e.checks)switch(s.kind){case"min":t.target==="jsonSchema7"?s.inclusive?P(n,"minimum",s.value,s.message,t):P(n,"exclusiveMinimum",s.value,s.message,t):(s.inclusive||(n.exclusiveMinimum=!0),P(n,"minimum",s.value,s.message,t));break;case"max":t.target==="jsonSchema7"?s.inclusive?P(n,"maximum",s.value,s.message,t):P(n,"exclusiveMaximum",s.value,s.message,t):(s.inclusive||(n.exclusiveMaximum=!0),P(n,"maximum",s.value,s.message,t));break;case"multipleOf":P(n,"multipleOf",s.value,s.message,t);break}return n}function Yo(){return{type:"boolean"}}function Qo(e,t){return T(e.type._def,t)}const eu=(e,t)=>T(e.innerType._def,t);function Na(e,t,n){const s=n??t.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((r,a)=>Na(e,t,r))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return tu(e,t)}}const tu=(e,t)=>{const n={type:"integer",format:"unix-time"};if(t.target==="openApi3")return n;for(const s of e.checks)switch(s.kind){case"min":P(n,"minimum",s.value,s.message,t);break;case"max":P(n,"maximum",s.value,s.message,t);break}return n};function nu(e,t){return{...T(e.innerType._def,t),default:e.defaultValue()}}function su(e,t,n){return t.effectStrategy==="input"?T(e.schema._def,t,n):{}}function ru(e){return{type:"string",enum:[...e.values]}}const au=e=>"type"in e&&e.type==="string"?!1:"allOf"in e;function iu(e,t){const n=[T(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),T(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(a=>!!a);let s=t.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const r=[];return n.forEach(a=>{if(au(a))r.push(...a.allOf),a.unevaluatedProperties===void 0&&(s=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...l}=a;i=l}else s=void 0;r.push(i)}}),r.length?{allOf:r,...s}:void 0}function ou(e,t){const n=typeof e.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(e.value)?"array":"object"}:t.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[e.value]}:{type:n==="bigint"?"integer":n,const:e.value}}let nn;const fe={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(nn===void 0&&(nn=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),nn),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function Ma(e,t){const n={type:"string"};function s(r){return t.patternStrategy==="escape"?uu(r):r}if(e.checks)for(const r of e.checks)switch(r.kind){case"min":P(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,t);break;case"max":P(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"email":switch(t.emailStrategy){case"format:email":ne(n,"email",r.message,t);break;case"format:idn-email":ne(n,"idn-email",r.message,t);break;case"pattern:zod":se(n,fe.email,r.message,t);break}break;case"url":ne(n,"uri",r.message,t);break;case"uuid":ne(n,"uuid",r.message,t);break;case"regex":se(n,r.regex,r.message,t);break;case"cuid":se(n,fe.cuid,r.message,t);break;case"cuid2":se(n,fe.cuid2,r.message,t);break;case"startsWith":se(n,RegExp(`^${s(r.value)}`),r.message,t);break;case"endsWith":se(n,RegExp(`${s(r.value)}$`),r.message,t);break;case"datetime":ne(n,"date-time",r.message,t);break;case"date":ne(n,"date",r.message,t);break;case"time":ne(n,"time",r.message,t);break;case"duration":ne(n,"duration",r.message,t);break;case"length":P(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,t),P(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"includes":{se(n,RegExp(s(r.value)),r.message,t);break}case"ip":{r.version!=="v6"&&ne(n,"ipv4",r.message,t),r.version!=="v4"&&ne(n,"ipv6",r.message,t);break}case"emoji":se(n,fe.emoji,r.message,t);break;case"ulid":{se(n,fe.ulid,r.message,t);break}case"base64":{switch(t.base64Strategy){case"format:binary":{ne(n,"binary",r.message,t);break}case"contentEncoding:base64":{P(n,"contentEncoding","base64",r.message,t);break}case"pattern:zod":{se(n,fe.base64,r.message,t);break}}break}case"nanoid":se(n,fe.nanoid,r.message,t)}return n}const uu=e=>Array.from(e).map(t=>/[a-zA-Z0-9]/.test(t)?t:`\\${t}`).join(""),ne=(e,t,n,s)=>{e.format||e.anyOf?.some(r=>r.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&s.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&s.errorMessages&&{errorMessage:{format:n}}})):P(e,"format",t,n,s)},se=(e,t,n,s)=>{e.pattern||e.allOf?.some(r=>r.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&s.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.allOf.push({pattern:Fs(t,s),...n&&s.errorMessages&&{errorMessage:{pattern:n}}})):P(e,"pattern",Fs(t,s),n,s)},Fs=(e,t)=>{const n=typeof e=="function"?e():e;if(!t.applyRegexFlags||!n.flags)return n.source;const s={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},r=s.i?n.source.toLowerCase():n.source;let a="",i=!1,o=!1,l=!1;for(let u=0;u<r.length;u++){if(i){a+=r[u],i=!1;continue}if(s.i){if(o){if(r[u].match(/[a-z]/)){l?(a+=r[u],a+=`${r[u-2]}-${r[u]}`.toUpperCase(),l=!1):r[u+1]==="-"&&r[u+2]?.match(/[a-z]/)?(a+=r[u],l=!0):a+=`${r[u]}${r[u].toUpperCase()}`;continue}}else if(r[u].match(/[a-z]/)){a+=`[${r[u]}${r[u].toUpperCase()}]`;continue}}if(s.m){if(r[u]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(r[u]==="$"){a+=`($|(?=[\r
]))`;continue}}if(s.s&&r[u]==="."){a+=o?`${r[u]}\r
`:`[${r[u]}\r
]`;continue}a+=r[u],r[u]==="\\"?i=!0:o&&r[u]==="]"?o=!1:!o&&r[u]==="["&&(o=!0)}try{const u=new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a};function za(e,t){if(t.target==="openApi3"&&e.keyType?._def.typeName===x.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((s,r)=>({...s,[r]:T(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:T(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if(t.target==="openApi3")return n;if(e.keyType?._def.typeName===x.ZodString&&e.keyType._def.checks?.length){const s=Object.entries(Ma(e.keyType._def,t)).reduce((r,[a,i])=>a==="type"?r:{...r,[a]:i},{});return{...n,propertyNames:s}}else if(e.keyType?._def.typeName===x.ZodEnum)return{...n,propertyNames:{enum:e.keyType._def.values}};return n}function lu(e,t){if(t.mapStrategy==="record")return za(e,t);const n=T(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},s=T(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[n,s],minItems:2,maxItems:2}}}function cu(e){const t=e.values,s=Object.keys(e.values).filter(a=>typeof t[t[a]]!="number").map(a=>t[a]),r=Array.from(new Set(s.map(a=>typeof a)));return{type:r.length===1?r[0]==="string"?"string":"number":["string","number"],enum:s}}function pu(){return{not:{}}}function du(e){return e.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const $t={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function hu(e,t){if(t.target==="openApi3")return Ks(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every(s=>s._def.typeName in $t&&(!s._def.checks||!s._def.checks.length))){const s=n.reduce((r,a)=>{const i=$t[a._def.typeName];return i&&!r.includes(i)?[...r,i]:r},[]);return{type:s.length>1?s:s[0]}}else if(n.every(s=>s._def.typeName==="ZodLiteral"&&!s.description)){const s=n.reduce((r,a)=>{const i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...r,i];case"bigint":return[...r,"integer"];case"object":if(a._def.value===null)return[...r,"null"];case"symbol":case"undefined":case"function":default:return r}},[]);if(s.length===n.length){const r=s.filter((a,i,o)=>o.indexOf(a)===i);return{type:r.length>1?r:r[0],enum:n.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(n.every(s=>s._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((s,r)=>[...s,...r._def.values.filter(a=>!s.includes(a))],[])};return Ks(e,t)}const Ks=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((s,r)=>T(s._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(s=>!!s&&(!t.strictUnions||typeof s=="object"&&Object.keys(s).length>0));return n.length?{anyOf:n}:void 0};function fu(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return t.target==="openApi3"||t.nullableStrategy==="property"?{type:$t[e.innerType._def.typeName],nullable:!0}:{type:[$t[e.innerType._def.typeName],"null"]};if(t.target==="openApi3"){const s=T(e.innerType._def,{...t,currentPath:[...t.currentPath]});return s&&"$ref"in s?{allOf:[s],nullable:!0}:s&&{...s,nullable:!0}}const n=T(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function mu(e,t){const n={type:"number"};if(!e.checks)return n;for(const s of e.checks)switch(s.kind){case"int":n.type="integer",$a(n,"type",s.message,t);break;case"min":t.target==="jsonSchema7"?s.inclusive?P(n,"minimum",s.value,s.message,t):P(n,"exclusiveMinimum",s.value,s.message,t):(s.inclusive||(n.exclusiveMinimum=!0),P(n,"minimum",s.value,s.message,t));break;case"max":t.target==="jsonSchema7"?s.inclusive?P(n,"maximum",s.value,s.message,t):P(n,"exclusiveMaximum",s.value,s.message,t):(s.inclusive||(n.exclusiveMaximum=!0),P(n,"maximum",s.value,s.message,t));break;case"multipleOf":P(n,"multipleOf",s.value,s.message,t);break}return n}function gu(e,t){return t.removeAdditionalStrategy==="strict"?e.catchall._def.typeName==="ZodNever"?e.unknownKeys!=="strict":T(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:e.catchall._def.typeName==="ZodNever"?e.unknownKeys==="passthrough":T(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function _u(e,t){const n={type:"object",...Object.entries(e.shape()).reduce((s,[r,a])=>{if(a===void 0||a._def===void 0)return s;const i=[...t.currentPath,"properties",r],o=T(a._def,{...t,currentPath:i,propertyPath:i});if(o===void 0)return s;if(t.openaiStrictMode&&a.isOptional()&&!a.isNullable()&&typeof a._def?.defaultValue>"u")throw new Error(`Zod field at \`${i.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...s.properties,[r]:o},required:a.isOptional()&&!t.openaiStrictMode?s.required:[...s.required,r]}},{properties:{},required:[]}),additionalProperties:gu(e,t)};return n.required.length||delete n.required,n}const yu=(e,t)=>{if(t.propertyPath&&t.currentPath.slice(0,t.propertyPath.length).toString()===t.propertyPath.toString())return T(e.innerType._def,{...t,currentPath:t.currentPath});const n=T(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}},wu=(e,t)=>{if(t.pipeStrategy==="input")return T(e.in._def,t);if(t.pipeStrategy==="output")return T(e.out._def,t);const n=T(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),s=T(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,s].filter(r=>r!==void 0)}};function bu(e,t){return T(e.type._def,t)}function Au(e,t){const s={type:"array",uniqueItems:!0,items:T(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&P(s,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&P(s,"maxItems",e.maxSize.value,e.maxSize.message,t),s}function Iu(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((n,s)=>T(n._def,{...t,currentPath:[...t.currentPath,"items",`${s}`]})).reduce((n,s)=>s===void 0?n:[...n,s],[]),additionalItems:T(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((n,s)=>T(n._def,{...t,currentPath:[...t.currentPath,"items",`${s}`]})).reduce((n,s)=>s===void 0?n:[...n,s],[])}}function Ou(){return{not:{}}}function vu(){return{}}const xu=(e,t)=>T(e.innerType._def,t);function T(e,t,n=!1){const s=t.seen.get(e);if(t.override){const i=t.override?.(e,t,s,n);if(i!==Wo)return i}if(s&&!n){const i=ku(s,t);if(i!==void 0)return"$ref"in i&&t.seenRefs.add(i.$ref),i}const r={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,r);const a=Cu(e,e.typeName,t,n);return a&&Su(e,t,a),r.jsonSchema=a,a}const ku=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":const n=e.path.slice(t.basePath.length+1).join("_");return n!==t.name&&t.nameStrategy==="duplicate-ref"&&(t.definitions[n]=e.def),{$ref:[...t.basePath,t.definitionPath,n].join("/")};case"relative":return{$ref:Tu(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((s,r)=>t.currentPath[r]===s)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):t.$refStrategy==="seen"?{}:void 0}},Tu=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},Cu=(e,t,n,s)=>{switch(t){case x.ZodString:return Ma(e,n);case x.ZodNumber:return mu(e,n);case x.ZodObject:return _u(e,n);case x.ZodBigInt:return Go(e,n);case x.ZodBoolean:return Yo();case x.ZodDate:return Na(e,n);case x.ZodUndefined:return Ou();case x.ZodNull:return du(n);case x.ZodArray:return Xo(e,n);case x.ZodUnion:case x.ZodDiscriminatedUnion:return hu(e,n);case x.ZodIntersection:return iu(e,n);case x.ZodTuple:return Iu(e,n);case x.ZodRecord:return za(e,n);case x.ZodLiteral:return ou(e,n);case x.ZodEnum:return ru(e);case x.ZodNativeEnum:return cu(e);case x.ZodNullable:return fu(e,n);case x.ZodOptional:return yu(e,n);case x.ZodMap:return lu(e,n);case x.ZodSet:return Au(e,n);case x.ZodLazy:return T(e.getter()._def,n);case x.ZodPromise:return bu(e,n);case x.ZodNaN:case x.ZodNever:return pu();case x.ZodEffects:return su(e,n,s);case x.ZodAny:return Vo();case x.ZodUnknown:return vu();case x.ZodDefault:return nu(e,n);case x.ZodBranded:return Qo(e,n);case x.ZodReadonly:return xu(e,n);case x.ZodCatch:return eu(e,n);case x.ZodPipeline:return wu(e,n);case x.ZodFunction:case x.ZodVoid:case x.ZodSymbol:return;default:return(r=>{})()}},Su=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),Pu=(e,t)=>{const n=Ho(t),s=typeof t=="string"?t:t?.nameStrategy==="title"?void 0:t?.name,r=T(e._def,s===void 0?n:{...n,currentPath:[...n.basePath,n.definitionPath,s]},!1)??{},a=typeof t=="object"&&t.name!==void 0&&t.nameStrategy==="title"?t.name:void 0;a!==void 0&&(r.title=a);const i=(()=>{if(Jo(n.definitions))return;const l={},u=new Set;for(let m=0;m<500;m++){const d=Object.entries(n.definitions).filter(([f])=>!u.has(f));if(d.length===0)break;for(const[f,c]of d)l[f]=T(bn(c),{...n,currentPath:[...n.basePath,n.definitionPath,f]},!0)??{},u.add(f)}return l})(),o=s===void 0?i?{...r,[n.definitionPath]:i}:r:n.nameStrategy==="duplicate-ref"?{...r,...i||n.seenRefs.size?{[n.definitionPath]:{...i,...n.seenRefs.size?{[s]:r}:void 0}}:void 0}:{$ref:[...n.$refStrategy==="relative"?[]:n.basePath,n.definitionPath,s].join("/"),[n.definitionPath]:{...i,[s]:r}};return n.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":n.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function Ru(e){if(e.type!=="object")throw new Error(`Root schema must have type: 'object' but got type: ${e.type?`'${e.type}'`:"undefined"}`);const t=structuredClone(e);return ce(t,[],t)}function An(e){if(typeof e=="boolean")return!1;if(e.type==="null")return!0;for(const t of e.oneOf??[])if(An(t))return!0;for(const t of e.anyOf??[])if(An(t))return!0;return!1}function ce(e,t,n){if(typeof e=="boolean")throw new TypeError(`Expected object schema but got boolean; path=${t.join("/")}`);if(!ge(e))throw new TypeError(`Expected ${JSON.stringify(e)} to be an object; path=${t.join("/")}`);const s=e.$defs;if(ge(s))for(const[f,c]of Object.entries(s))ce(c,[...t,"$defs",f],n);const r=e.definitions;if(ge(r))for(const[f,c]of Object.entries(r))ce(c,[...t,"definitions",f],n);e.type==="object"&&!("additionalProperties"in e)&&(e.additionalProperties=!1);const i=e.required??[],o=e.properties;if(ge(o)){for(const[f,c]of Object.entries(o))if(!An(c)&&!i.includes(f))throw new Error(`Zod field at \`${[...t,"properties",f].join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);e.required=Object.keys(o),e.properties=Object.fromEntries(Object.entries(o).map(([f,c])=>[f,ce(c,[...t,"properties",f],n)]))}const l=e.items;ge(l)&&(e.items=ce(l,[...t,"items"],n));const u=e.anyOf;Array.isArray(u)&&(e.anyOf=u.map((f,c)=>ce(f,[...t,"anyOf",String(c)],n)));const m=e.allOf;if(Array.isArray(m))if(m.length===1){const f=ce(m[0],[...t,"allOf","0"],n);Object.assign(e,f),delete e.allOf}else e.allOf=m.map((f,c)=>ce(f,[...t,"allOf",String(c)],n));e.default===null&&delete e.default;const d=e.$ref;if(d&&$u(e,1)){if(typeof d!="string")throw new TypeError(`Received non-string $ref - ${d}; path=${t.join("/")}`);const f=Eu(n,d);if(typeof f=="boolean")throw new Error(`Expected \`$ref: ${d}\` to resolve to an object schema but got boolean`);if(!ge(f))throw new Error(`Expected \`$ref: ${d}\` to resolve to an object but got ${JSON.stringify(f)}`);return Object.assign(e,{...f,...e}),delete e.$ref,ce(e,t,n)}return e}function Eu(e,t){if(!t.startsWith("#/"))throw new Error(`Unexpected $ref format ${JSON.stringify(t)}; Does not start with #/`);const n=t.slice(2).split("/");let s=e;for(const r of n){if(!ge(s))throw new Error(`encountered non-object entry while resolving ${t} - ${JSON.stringify(s)}`);const a=s[r];if(a===void 0)throw new Error(`Key ${r} not found while resolving ${t}`);s=a}return s}function ge(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}function $u(e,t){let n=0;for(const s in e)if(n++,n>t)return!0;return!1}function Nu(e,t){return Pu(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Mu(e){return Ru(Ja(e,{target:"draft-7"}))}function zu(e){return"_zod"in e}function Uu(e,t,n){return no({type:"json_schema",json_schema:{...n,name:t,strict:!0,schema:zu(e)?Mu(e):Nu(e,{name:t})}},s=>e.parse(JSON.parse(s)))}const qs=["jsonSchema","functionCalling","jsonMode"];function Lu(e,t){if(typeof t<"u"&&!qs.includes(t))throw new Error(`Invalid method: ${t}. Supported methods are: ${qs.join(", ")}`);const n=!e.startsWith("gpt-3")&&!e.startsWith("gpt-4-")&&e!=="gpt-4";if(n&&!t)return"jsonSchema";if(!n&&t==="jsonSchema")throw new Error(`JSON Schema is not supported for model "${e}". Please use a different method, e.g. "functionCalling" or "jsonMode".`);return t??"functionCalling"}function Du(e,t){const n={...e};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t,enumerable:!1}}),n}function ju(e,t,n){if(Ha(e))return Uu(e,t,n);if(Va(e))return Du({type:"json_schema",json_schema:{...n,name:t,strict:!0,schema:Me(e,{cycles:"ref",reused:"ref",override(s){s.jsonSchema.title=t}})}},s=>Xa(e,JSON.parse(s)));throw new Error("Unsupported schema response format")}function Bu(e,t){if(t&&typeof t=="object"&&"images"in t&&Array.isArray(t.images)){const n=t.images.filter(s=>typeof s?.image_url?.url=="string").map(s=>({type:"image",url:s.image_url.url}));return[{type:"text",text:e},...n]}return e}const Fu={"gpt-4.1-nano":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"text-embedding-3-small":{maxInputTokens:8191,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1536,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-pro":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-05-13":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-08-06":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4.1-mini":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-deep-research":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-3.5-turbo":{maxInputTokens:16385,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!1,imageUrlInputs:!1,pdfToolMessage:!1,imageToolMessage:!1,toolChoice:!0},"text-embedding-3-large":{maxInputTokens:8191,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:3072,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4-turbo":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-preview":{maxInputTokens:128e3,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-mini":{maxInputTokens:2e5,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"codex-mini-latest":{maxInputTokens:2e5,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-nano":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-codex":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4.1":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o4-mini":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},o1:{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-mini":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-mini":{maxInputTokens:128e3,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:65536,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"text-embedding-ada-002":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1536,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-pro":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-11-20":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},o3:{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o4-mini-deep-research":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-chat-latest":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-mini":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-pro":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:272e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0}};var Ku=Fu,Xn=class extends hi{temperature;topP;frequencyPenalty;presencePenalty;n;logitBias;model="gpt-3.5-turbo";modelKwargs;stop;stopSequences;user;timeout;streaming=!1;streamUsage=!0;maxTokens;logprobs;topLogprobs;apiKey;organization;__includeRawResponse;client;clientConfig;supportsStrictToolCalling;audio;modalities;reasoning;zdrEnabled;service_tier;promptCacheKey;promptCacheRetention;verbosity;defaultOptions;_llmType(){return"openai"}static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning","reasoning_effort","service_tier"]}lc_serializable=!0;get lc_secrets(){return{apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{apiKey:"openai_api_key",modelName:"model"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","model","modelName","modelKwargs","stop","stopSequences","timeout","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","zdrEnabled","reasoning","promptCacheKey","promptCacheRetention","verbosity"]}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}constructor(e){super(e??{});const t=typeof e?.configuration?.apiKey=="string"||typeof e?.configuration?.apiKey=="function"?e?.configuration?.apiKey:void 0;this.apiKey=e?.apiKey??t??R("OPENAI_API_KEY"),this.organization=e?.configuration?.organization??R("OPENAI_ORGANIZATION"),this.model=e?.model??e?.modelName??this.model,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoning=e?.reasoning,this.maxTokens=e?.maxCompletionTokens??e?.maxTokens,this.promptCacheKey=e?.promptCacheKey??this.promptCacheKey,this.promptCacheRetention=e?.promptCacheRetention??this.promptCacheRetention,this.verbosity=e?.verbosity??this.verbosity,this.disableStreaming=e?.disableStreaming===!0,this.streaming=e?.streaming===!0,this.disableStreaming&&(this.streaming=!1),e?.streaming===!1&&(this.disableStreaming=!0),this.streamUsage=e?.streamUsage??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e?.configuration},e?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling),e?.service_tier!==void 0&&(this.service_tier=e.service_tier),this.zdrEnabled=e?.zdrEnabled??!1}_getReasoningParams(e){if(!Ye(this.model))return;let t;return this.reasoning!==void 0&&(t={...t,...this.reasoning}),e?.reasoning!==void 0&&(t={...t,...e.reasoning}),e?.reasoningEffort!==void 0&&t?.effort===void 0&&(t={...t,effort:e.reasoningEffort}),t}_getResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&et(e.json_schema.schema)?ju(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}_combineCallOptions(e){return{...this.defaultOptions,...e??{}}}_getClientOptions(e){if(!this.client){const n={baseURL:this.clientConfig.baseURL},s=Ee(n),r={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};r.baseURL||delete r.baseURL,r.defaultHeaders=$e(r.defaultHeaders),this.client=new v(r)}return{...this.clientConfig,...e}}_convertChatOpenAIToolToCompletionsTool(e,t){return Et(e)?qo(e.metadata.customTool):Xs(e)?t?.strict!==void 0?{...e,function:{...e.function,strict:t.strict}}:e:No(e,t)}bindTools(e,t){let n;return t?.strict!==void 0?n=t.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling),this.withConfig({tools:e.map(s=>Vn(s)||Et(s)?s:Uo(s)?s.extras.providerToolDefinition:this._convertChatOpenAIToolToCompletionsTool(s,{strict:n})),...t})}async stream(e,t){return super.stream(e,this._combineCallOptions(t))}async invoke(e,t){return super.invoke(e,this._combineCallOptions(t))}_combineLLMOutput(...e){return e.reduce((t,n)=>(n&&n.tokenUsage&&(t.tokenUsage.completionTokens+=n.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=n.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=n.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}async getNumTokensFromMessages(e){let t=0,n=0,s=0;this.model==="gpt-3.5-turbo-0301"?(n=4,s=-1):(n=3,s=1);const r=await Promise.all(e.map(async a=>{const[i,o]=await Promise.all([this.getNumTokens(a.content),this.getNumTokens(Qe(a))]),l=a.name!==void 0?s+await this.getNumTokens(a.name):0;let u=i+n+o+l;const m=a;if(m._getType()==="function"&&(u-=2),m.additional_kwargs?.function_call&&(u+=3),m?.additional_kwargs.function_call?.name&&(u+=await this.getNumTokens(m.additional_kwargs.function_call?.name)),m.additional_kwargs.function_call?.arguments)try{u+=await this.getNumTokens(JSON.stringify(JSON.parse(m.additional_kwargs.function_call?.arguments)))}catch(d){console.error("Error parsing function arguments",d,JSON.stringify(m.additional_kwargs.function_call)),u+=await this.getNumTokens(m.additional_kwargs.function_call?.arguments)}return t+=u,u}));return t+=3,{totalCount:t,countPerMessage:r}}async _getNumTokensFromGenerations(e){return(await Promise.all(e.map(async n=>n.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([n.message])).countPerMessage[0]:await this.getNumTokens(n.message.content)))).reduce((n,s)=>n+s,0)}async _getEstimatedTokenCountFromPrompt(e,t,n){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&n!=="auto"){const r=zo(t);s+=await this.getNumTokens(r),s+=9}return t&&e.find(r=>r._getType()==="system")&&(s-=4),n==="none"?s+=1:typeof n=="object"&&(s+=await this.getNumTokens(n.name)+4),s}async moderateContent(e,t){const n=this._getClientOptions(t?.options),s=t?.model??"omni-moderation-latest",r={input:e,model:s};return this.caller.call(async()=>{try{return await this.client.moderations.create(r,n)}catch(a){throw Re(a)}})}get profile(){return Ku[this.model]??{}}_getStructuredOutputMethod(e){const t={...e};if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"){if(t?.method===void 0)return"jsonSchema"}else t.method==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`);return t.method}withStructuredOutput(e,t){let n,s;const{schema:r,name:a,includeRaw:i}={...t,schema:e};if(t?.strict!==void 0&&t.method==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");const o=Lu(this.model,t?.method);if(o==="jsonMode"){et(r)?s=os.fromZodSchema(r):s=new us;const d=Me(r);n=this.withConfig({outputVersion:"v0",response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"json_mode"},schema:{title:a??"extract",...d}}})}else if(o==="jsonSchema"){const d={name:a??"extract",description:Ga(r),schema:r,strict:t?.strict},f=Me(d.schema);if(n=this.withConfig({outputVersion:"v0",response_format:{type:"json_schema",json_schema:d},ls_structured_output_format:{kwargs:{method:"json_schema"},schema:{title:d.name,description:d.description,...f}}}),et(r)){const c=os.fromZodSchema(r);s=Ya.from(w=>"parsed"in w.additional_kwargs?w.additional_kwargs.parsed:c)}else s=new us}else{let d=a??"extract";if(et(r)){const f=Me(r);n=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:{name:d,description:f.description,parameters:f}}],tool_choice:{type:"function",function:{name:d}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:d,...f}},...t?.strict!==void 0?{strict:t.strict}:{}}),s=new cs({returnSingle:!0,keyName:d,zodSchema:r})}else{let f;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(f=r,d=r.name):(d=r.title??d,f={name:d,description:r.description??"",parameters:r});const c=Me(r);n=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:f}],tool_choice:{type:"function",function:{name:d}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:d,...c}},...t?.strict!==void 0?{strict:t.strict}:{}}),s=new cs({returnSingle:!0,keyName:d})}}if(!i)return n.pipe(s);const l=ls.assign({parsed:(d,f)=>s.invoke(d.raw,f)}),u=ls.assign({parsed:()=>null}),m=l.withFallbacks({fallbacks:[u]});return Qa.from([{raw:n},m])}};const Ua={providerName:"ChatOpenAI",fromStandardTextBlock(e){return{type:"text",text:e.text}},fromStandardImageBlock(e){if(e.source_type==="url")return{type:"image_url",image_url:{url:e.url,...e.metadata?.detail?{detail:e.metadata.detail}:{}}};if(e.source_type==="base64")return{type:"image_url",image_url:{url:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.detail?{detail:e.metadata.detail}:{}}};throw new Error(`Image content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(e){if(e.source_type==="url"){const t=as({dataUrl:e.url});if(!t)throw new Error(`URL audio blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);const n=t.mime_type||e.mime_type||"";let s;try{s=is(n)}catch{throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if(s.type!=="audio"||s.subtype!=="wav"&&s.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:s.subtype,data:t.data}}}if(e.source_type==="base64"){let t;try{t=is(e.mime_type??"")}catch{throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if(t.type!=="audio"||t.subtype!=="wav"&&t.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:t.subtype,data:e.data}}}throw new Error(`Audio content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(e){if(e.source_type==="url"){const t=as({dataUrl:e.url}),n=Pt(e);if(!t)throw new Error(`URL file blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:e.url,...e.metadata?.filename||e.metadata?.name?{filename:n}:{}}}}if(e.source_type==="base64"){const t=Pt(e);return{type:"file",file:{file_data:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.filename||e.metadata?.name||e.metadata?.title?{filename:t}:{}}}}if(e.source_type==="id")return{type:"file",file:{file_id:e.id}};throw new Error(`File content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)}},qu=({message:e,rawResponse:t,includeRawResponse:n})=>{const s=e.tool_calls;switch(e.role){case"assistant":{const r=[],a=[];for(const u of s??[])try{r.push(Gs(u,{returnId:!0}))}catch(m){a.push(lt(u,m.message))}const i={function_call:e.function_call,tool_calls:s};n!==void 0&&(i.__raw_response=t);const o={model_provider:"openai",model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};e.audio&&(i.audio=e.audio);const l=Bu(e.content||"",t.choices?.[0]?.message);return new Ce({content:l,tool_calls:r,invalid_tool_calls:a,additional_kwargs:i,response_metadata:o,id:t.id})}default:return new Zs(e.content||"",e.role??"unknown")}},Wu=({delta:e,rawResponse:t,includeRawResponse:n,defaultRole:s})=>{const r=e.role??s,a=e.content??"";let i;e.function_call?i={function_call:e.function_call}:e.tool_calls?i={tool_calls:e.tool_calls}:i={},n&&(i.__raw_response=t),e.audio&&(i.audio={...e.audio,index:t.choices[0].index});const o={model_provider:"openai",usage:{...t.usage}};if(r==="user")return new ei({content:a,response_metadata:o});if(r==="assistant"){const l=[];if(Array.isArray(e.tool_calls))for(const u of e.tool_calls)l.push({name:u.function?.name,args:u.function?.arguments,id:u.id,index:u.index,type:"tool_call_chunk"});return new vn({content:a,tool_call_chunks:l,additional_kwargs:i,id:t.id,response_metadata:o})}else return r==="system"?new rs({content:a,response_metadata:o}):r==="developer"?new rs({content:a,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):r==="function"?new ti({content:a,additional_kwargs:i,name:e.name,response_metadata:o}):r==="tool"?new ni({content:a,additional_kwargs:i,tool_call_id:e.tool_call_id,response_metadata:o}):new si({content:a,role:r,response_metadata:o})},Zu=e=>{if(e.type==="image"){if(e.url)return{type:"image_url",image_url:{url:e.url}};if(e.data)return{type:"image_url",image_url:{url:`data:${e.mimeType};base64,${e.data}`}}}if(e.type==="audio"&&e.data){const t=ri(()=>{const[,n]=e.mimeType.split("/");return n==="wav"||n==="mp3"?n:"wav"});return{type:"input_audio",input_audio:{data:e.data.toString(),format:t}}}if(e.type==="file"){if(e.data){const t=Pt(e);return{type:"file",file:{file_data:`data:${e.mimeType};base64,${e.data}`,filename:t}}}if(e.fileId)return{type:"file",file:{file_id:e.fileId}}}},Ju=({message:e,model:t})=>{let n=Qe(e);if(n==="system"&&Ye(t)&&(n="developer"),n==="developer")return{role:"developer",content:e.contentBlocks.filter(r=>r.type==="text")};if(n==="system")return{role:"system",content:e.contentBlocks.filter(r=>r.type==="text")};if(n==="assistant")return{role:"assistant",content:e.contentBlocks.filter(r=>r.type==="text")};if(n==="tool"&&bt.isInstance(e))return{role:"tool",tool_call_id:e.tool_call_id,content:e.contentBlocks.filter(r=>r.type==="text")};if(n==="function")return{role:"function",name:e.name??"",content:e.contentBlocks.filter(r=>r.type==="text").join("")};function*s(r){for(const a of r){a.type==="text"&&(yield{type:"text",text:a.text});const i=Zu(a);i&&(yield i)}}return{role:"user",content:Array.from(s(e.contentBlocks))}},In=({messages:e,model:t})=>e.flatMap(n=>{if("output_version"in n.response_metadata&&n.response_metadata?.output_version==="v1")return Ju({message:n});let s=Qe(n);s==="system"&&Ye(t)&&(s="developer");const r=typeof n.content=="string"?n.content:n.content.map(i=>Js(i)?Hs(i,Ua):i),a={role:s,content:r};if(n.name!=null&&(a.name=n.name),n.additional_kwargs.function_call!=null&&(a.function_call=n.additional_kwargs.function_call),Ce.isInstance(n)&&n.tool_calls?.length?a.tool_calls=n.tool_calls.map(mi):(n.additional_kwargs.tool_calls!=null&&(a.tool_calls=n.additional_kwargs.tool_calls),bt.isInstance(n)&&n.tool_call_id!=null&&(a.tool_call_id=n.tool_call_id)),n.additional_kwargs.audio&&typeof n.additional_kwargs.audio=="object"&&"id"in n.additional_kwargs.audio){const i={role:"assistant",audio:{id:n.additional_kwargs.audio.id}};return[a,i]}return a});var La=class extends Xn{invocationParams(e,t){let n;e?.strict!==void 0?n=e.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling);let s={};e?.stream_options!==void 0?s={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(s={stream_options:{include_usage:!0}});const r={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(i=>this._convertChatOpenAIToolToCompletionsTool(i,{strict:n})):void 0,tool_choice:Ra(e?.tool_choice),response_format:this._getResponseFormat(e?.response_format),seed:e?.seed,...s,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs,prompt_cache_key:e?.promptCacheKey??this.promptCacheKey,prompt_cache_retention:e?.promptCacheRetention??this.promptCacheRetention,verbosity:e?.verbosity??this.verbosity};e?.prediction!==void 0&&(r.prediction=e.prediction),this.service_tier!==void 0&&(r.service_tier=this.service_tier),e?.service_tier!==void 0&&(r.service_tier=e.service_tier);const a=this._getReasoningParams(e);return a!==void 0&&a.effort!==void 0&&(r.reasoning_effort=a.effort),Ye(r.model)?r.max_completion_tokens=this.maxTokens===-1?void 0:this.maxTokens:r.max_tokens=this.maxTokens===-1?void 0:this.maxTokens,r}async _generate(e,t,n){t.signal?.throwIfAborted();const s={},r=this.invocationParams(t),a=In({messages:e,model:this.model});if(r.stream){const i=this._streamResponseChunks(e,t,n),o={};for await(const c of i){c.message.response_metadata={...c.generationInfo,...c.message.response_metadata};const w=c.generationInfo?.completion??0;o[w]===void 0?o[w]=c:o[w]=o[w].concat(c)}const l=Object.entries(o).sort(([c],[w])=>parseInt(c,10)-parseInt(w,10)).map(([c,w])=>w),{functions:u,function_call:m}=this.invocationParams(t),d=await this._getEstimatedTokenCountFromPrompt(e,u,m),f=await this._getNumTokensFromGenerations(l);return s.input_tokens=d,s.output_tokens=f,s.total_tokens=d+f,{generations:l,llmOutput:{estimatedTokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}else{const i=await this.completionWithRetry({...r,stream:!1,messages:a},{signal:t?.signal,...t?.options}),{completion_tokens:o,prompt_tokens:l,total_tokens:u,prompt_tokens_details:m,completion_tokens_details:d}=i?.usage??{};o&&(s.output_tokens=(s.output_tokens??0)+o),l&&(s.input_tokens=(s.input_tokens??0)+l),u&&(s.total_tokens=(s.total_tokens??0)+u),(m?.audio_tokens!==null||m?.cached_tokens!==null)&&(s.input_token_details={...m?.audio_tokens!==null&&{audio:m?.audio_tokens},...m?.cached_tokens!==null&&{cache_read:m?.cached_tokens}}),(d?.audio_tokens!==null||d?.reasoning_tokens!==null)&&(s.output_token_details={...d?.audio_tokens!==null&&{audio:d?.audio_tokens},...d?.reasoning_tokens!==null&&{reasoning:d?.reasoning_tokens}});const f=[];for(const c of i?.choices??[]){const b={text:c.message?.content??"",message:this._convertCompletionsMessageToBaseMessage(c.message??{role:"assistant"},i)};b.generationInfo={...c.finish_reason?{finish_reason:c.finish_reason}:{},...c.logprobs?{logprobs:c.logprobs}:{}},ai(b.message)&&(b.message.usage_metadata=s),b.message=new Ce(Object.fromEntries(Object.entries(b.message).filter(([C])=>!C.startsWith("lc_")))),f.push(b)}return{generations:f,llmOutput:{tokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}}async*_streamResponseChunks(e,t,n){const s=In({messages:e,model:this.model}),r={...this.invocationParams(t,{streaming:!0}),messages:s,stream:!0};let a;const i=await this.completionWithRetry(r,t);let o;for await(const l of i){if(t.signal?.aborted)return;const u=l?.choices?.[0];if(l.usage&&(o=l.usage),!u)continue;const{delta:m}=u;if(!m)continue;const d=this._convertCompletionsDeltaToBaseMessageChunk(m,l,a);a=m.role??a;const f={prompt:t.promptIndex??0,completion:u.index??0};if(typeof d.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const c={...f};u.finish_reason!=null&&(c.finish_reason=u.finish_reason,c.system_fingerprint=l.system_fingerprint,c.model_name=l.model,c.service_tier=l.service_tier),this.logprobs&&(c.logprobs=u.logprobs);const w=new sn({message:d,text:d.content,generationInfo:c});yield w,await n?.handleLLMNewToken(w.text??"",f,void 0,void 0,void 0,{chunk:w})}if(o){const l={...o.prompt_tokens_details?.audio_tokens!==null&&{audio:o.prompt_tokens_details?.audio_tokens},...o.prompt_tokens_details?.cached_tokens!==null&&{cache_read:o.prompt_tokens_details?.cached_tokens}},u={...o.completion_tokens_details?.audio_tokens!==null&&{audio:o.completion_tokens_details?.audio_tokens},...o.completion_tokens_details?.reasoning_tokens!==null&&{reasoning:o.completion_tokens_details?.reasoning_tokens}};yield new sn({message:new vn({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(l).length>0&&{input_token_details:l},...Object.keys(u).length>0&&{output_token_details:u}}}),text:""})}if(t.signal?.aborted)throw new Error("AbortError")}async completionWithRetry(e,t){const n=this._getClientOptions(t),s=e.response_format&&e.response_format.type==="json_schema";return this.caller.call(async()=>{try{return s&&!e.stream?await this.client.chat.completions.parse(e,n):await this.client.chat.completions.create(e,n)}catch(r){throw Re(r)}})}_convertCompletionsDeltaToBaseMessageChunk(e,t,n){return Wu({delta:e,rawResponse:t,includeRawResponse:this.__includeRawResponse,defaultRole:n})}_convertCompletionsMessageToBaseMessage(e,t){return qu({message:e,rawResponse:t,includeRawResponse:this.__includeRawResponse})}};const Gn={openAIApiKey:"openai_api_key",openAIApiVersion:"openai_api_version",openAIBasePath:"openai_api_base",deploymentName:"deployment_name",azureOpenAIEndpoint:"azure_endpoint",azureOpenAIApiVersion:"openai_api_version",azureOpenAIBasePath:"openai_api_base",azureOpenAIApiDeploymentName:"deployment_name"},Yn={azureOpenAIApiKey:"AZURE_OPENAI_API_KEY"},Qn=["azureOpenAIApiKey","azureOpenAIApiVersion","azureOpenAIBasePath","azureOpenAIEndpoint","azureOpenAIApiInstanceName","azureOpenAIApiDeploymentName","deploymentName","openAIApiKey","openAIApiVersion"];function es(e){if(this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(typeof e?.openAIApiKey=="string"?e?.openAIApiKey:void 0)??(typeof e?.apiKey=="string"?e?.apiKey:void 0)??R("AZURE_OPENAI_API_KEY"),this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??R("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??e?.deploymentName??R("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??e?.openAIApiVersion??R("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??R("AZURE_OPENAI_BASE_PATH"),this.azureOpenAIEndpoint=e?.azureOpenAIEndpoint??R("AZURE_OPENAI_ENDPOINT"),this.azureADTokenProvider=e?.azureADTokenProvider,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("Azure OpenAI API key or Token Provider not found")}function Da(e){if(!this.client){const n={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,azureADTokenProvider:this.azureADTokenProvider,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint},s=Ee(n),{apiKey:r,...a}=this.clientConfig,i={...a,baseURL:s,timeout:this.timeout,maxRetries:0};this.azureADTokenProvider||(i.apiKey=n.azureOpenAIApiKey),i.baseURL||delete i.baseURL,i.defaultHeaders=$e(i.defaultHeaders,!0,"2.0.0"),this.client=new Hn({apiVersion:this.azureOpenAIApiVersion,azureADTokenProvider:this.azureADTokenProvider,deployment:this.azureOpenAIApiDeploymentName,...i})}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}function ts(e){const t=e;function n(s){return typeof s=="object"&&s!=null}if(n(t)&&n(t.kwargs)){if(delete t.kwargs.azure_openai_base_path,delete t.kwargs.azure_openai_api_deployment_name,delete t.kwargs.azure_openai_api_key,delete t.kwargs.azure_openai_api_version,delete t.kwargs.azure_open_ai_base_path,!t.kwargs.azure_endpoint&&this.azureOpenAIEndpoint&&(t.kwargs.azure_endpoint=this.azureOpenAIEndpoint),!t.kwargs.azure_endpoint&&this.azureOpenAIBasePath){const s=this.azureOpenAIBasePath.split("/openai/deployments/");if(s.length===2&&s[0].startsWith("http")){const[r]=s;t.kwargs.azure_endpoint=r}}if(!t.kwargs.azure_endpoint&&this.azureOpenAIApiInstanceName&&(t.kwargs.azure_endpoint=`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/`),!t.kwargs.deployment_name&&this.azureOpenAIApiDeploymentName&&(t.kwargs.deployment_name=this.azureOpenAIApiDeploymentName),!t.kwargs.deployment_name&&this.azureOpenAIBasePath){const s=this.azureOpenAIBasePath.split("/openai/deployments/");if(s.length===2){const[,r]=s;t.kwargs.deployment_name=r}}t.kwargs.azure_endpoint&&t.kwargs.deployment_name&&t.kwargs.openai_api_base&&delete t.kwargs.openai_api_base,t.kwargs.azure_openai_api_instance_name&&t.kwargs.azure_endpoint&&delete t.kwargs.azure_openai_api_instance_name}return t}var Hu=class extends La{azureOpenAIApiVersion;azureOpenAIApiKey;azureADTokenProvider;azureOpenAIApiInstanceName;azureOpenAIApiDeploymentName;azureOpenAIBasePath;azureOpenAIEndpoint;_llmType(){return"azure_openai"}get lc_aliases(){return{...super.lc_aliases,...Gn}}get lc_secrets(){return{...super.lc_secrets,...Yn}}get lc_serializable_keys(){return[...super.lc_serializable_keys,...Qn]}getLsParams(e){const t=super.getLsParams(e);return t.ls_provider="azure",t}constructor(e){super(e),es.call(this,e)}_getClientOptions(e){return Da.call(this,e)}toJSON(){return ts.call(this,super.toJSON())}};const Nt="__openai_function_call_ids__";function ja(e){return e.type==="url_citation"?{type:"citation",source:"url_citation",url:e.url,title:e.title,startIndex:e.start_index,endIndex:e.end_index}:e.type==="file_citation"?{type:"citation",source:"file_citation",title:e.filename,startIndex:e.index,file_id:e.file_id}:e.type==="container_file_citation"?{type:"citation",source:"container_file_citation",title:e.filename,startIndex:e.start_index,endIndex:e.end_index,file_id:e.file_id,container_id:e.container_id}:e.type==="file_path"?{type:"citation",source:"file_path",startIndex:e.index,file_id:e.file_id}:{type:"non_standard",value:e}}const Ba=e=>{const t={...e?.input_tokens_details?.cached_tokens!=null&&{cache_read:e?.input_tokens_details?.cached_tokens}},n={...e?.output_tokens_details?.reasoning_tokens!=null&&{reasoning:e?.output_tokens_details?.reasoning_tokens}};return{input_tokens:e?.input_tokens??0,output_tokens:e?.output_tokens??0,total_tokens:e?.total_tokens??0,input_token_details:t,output_token_details:n}},Fa=e=>{if(e.error){const o=new Error(e.error.message);throw o.name=e.error.code,o}let t;const n=[],s=[],r=[],a={model_provider:"openai",model:e.model,created_at:e.created_at,id:e.id,incomplete_details:e.incomplete_details,metadata:e.metadata,object:e.object,status:e.status,user:e.user,service_tier:e.service_tier,model_name:e.model},i={};for(const o of e.output)if(o.type==="message")t=o.id,n.push(...o.content.flatMap(l=>l.type==="output_text"?("parsed"in l&&l.parsed!=null&&(i.parsed=l.parsed),{type:"text",text:l.text,annotations:l.annotations.map(ja)}):l.type==="refusal"?(i.refusal=l.refusal,[]):l));else if(o.type==="function_call"){const l={function:{name:o.name,arguments:o.arguments},id:o.call_id};try{s.push(Gs(l,{returnId:!0}))}catch(u){let m;typeof u=="object"&&u!=null&&"message"in u&&typeof u.message=="string"&&(m=u.message),r.push(lt(l,m))}i[Nt]??={},o.id&&(i[Nt][o.call_id]=o.id)}else if(o.type==="reasoning"){i.reasoning=o;const l=o.summary?.map(u=>u.text).filter(Boolean).join("");l&&n.push({type:"reasoning",reasoning:l})}else if(o.type==="custom_tool_call"){const l=Do(o);l?s.push(l):r.push(lt(o,"Malformed custom tool call"))}else if(o.type==="computer_call"){const l=jo(o);l?s.push(l):r.push(lt(o,"Malformed computer call"))}else o.type==="image_generation_call"?(o.result&&n.push({type:"image",mimeType:"image/png",data:o.result,id:o.id,metadata:{status:o.status}}),i.tool_outputs??=[],i.tool_outputs.push(o)):(i.tool_outputs??=[],i.tool_outputs.push(o));return new Ce({id:t,content:n,tool_calls:s,invalid_tool_calls:r,usage_metadata:Ba(e.usage),additional_kwargs:i,response_metadata:a})},Vu=e=>{const t=(e.summary.length>1?e.summary.reduce((n,s)=>{const r=n[n.length-1];return r.index===s.index?r.text+=s.text:n.push(s),n},[{...e.summary[0]}]):e.summary).map(n=>Object.fromEntries(Object.entries(n).filter(([s])=>s!=="index")));return{...e,summary:t}},Xu=e=>{const t=[];let n={},s;const r=[],a={model_provider:"openai"},i={};let o;if(e.type==="response.output_text.delta")t.push({type:"text",text:e.delta,index:e.content_index});else if(e.type==="response.output_text.annotation.added")t.push({type:"text",text:"",annotations:[ja(e.annotation)],index:e.content_index});else if(e.type==="response.output_item.added"&&e.item.type==="message")o=e.item.id;else if(e.type==="response.output_item.added"&&e.item.type==="function_call")r.push({type:"tool_call_chunk",name:e.item.name,args:e.item.arguments,id:e.item.call_id,index:e.output_index}),i[Nt]={[e.item.call_id]:e.item.id};else if(e.type==="response.output_item.done"&&e.item.type==="computer_call")r.push({type:"tool_call_chunk",name:"computer_use",args:JSON.stringify({action:e.item.action}),id:e.item.call_id,index:e.output_index}),i.tool_outputs=[e.item];else if(e.type==="response.output_item.done"&&e.item.type==="image_generation_call")e.item.result&&t.push({type:"image",mimeType:"image/png",data:e.item.result,id:e.item.id,metadata:{status:e.item.status}}),i.tool_outputs=[e.item];else if(e.type==="response.output_item.done"&&["web_search_call","file_search_call","code_interpreter_call","mcp_call","mcp_list_tools","mcp_approval_request","custom_tool_call"].includes(e.item.type))i.tool_outputs=[e.item];else if(e.type==="response.created")a.id=e.response.id,a.model_name=e.response.model,a.model=e.response.model;else if(e.type==="response.completed"){const l=Fa(e.response);s=Ba(e.response.usage),e.response.text?.format?.type==="json_schema"&&(i.parsed??=JSON.parse(l.text));for(const[u,m]of Object.entries(e.response))u!=="id"&&(a[u]=m)}else if(e.type==="response.function_call_arguments.delta"||e.type==="response.custom_tool_call_input.delta")r.push({type:"tool_call_chunk",args:e.delta,index:e.output_index});else if(e.type==="response.web_search_call.completed"||e.type==="response.file_search_call.completed")n={tool_outputs:{id:e.item_id,type:e.type.replace("response.","").replace(".completed",""),status:"completed"}};else if(e.type==="response.refusal.done")i.refusal=e.refusal;else if(e.type==="response.output_item.added"&&"item"in e&&e.item.type==="reasoning"){const l=e.item.summary?e.item.summary.map((m,d)=>({...m,index:d})):void 0;i.reasoning={id:e.item.id,type:e.item.type,...l?{summary:l}:{}};const u=e.item.summary?.map(m=>m.text).filter(Boolean).join("");u&&t.push({type:"reasoning",reasoning:u})}else if(e.type==="response.reasoning_summary_part.added")i.reasoning={type:"reasoning",summary:[{...e.part,index:e.summary_index}]},e.part.text&&t.push({type:"reasoning",reasoning:e.part.text});else if(e.type==="response.reasoning_summary_text.delta")i.reasoning={type:"reasoning",summary:[{text:e.delta,type:"summary_text",index:e.summary_index}]},e.delta&&t.push({type:"reasoning",reasoning:e.delta});else return e.type==="response.image_generation_call.partial_image",null;return new sn({text:t.map(l=>l.text).join(""),message:new vn({id:o,content:t,tool_call_chunks:r,usage_metadata:s,additional_kwargs:i,response_metadata:a}),generationInfo:n})},Gu=e=>{const t=Ce.isInstance(e)&&e.response_metadata?.model_provider==="openai";function*n(){const s=be(()=>{try{const h=Qe(e);return h==="system"||h==="developer"||h==="assistant"||h==="user"?h:"assistant"}catch{return"assistant"}});let r;const a=new Set,i=new Set,o=new Map,l=new Map;function*u(){if(!r)return;const h=r.content;(typeof h=="string"&&h.length>0||Array.isArray(h)&&h.length>0)&&(yield r),r=void 0}const m=h=>{r||(r={type:"message",role:s,content:[]}),typeof r.content=="string"?r.content=r.content.length>0?[{type:"input_text",text:r.content},...h]:[...h]:r.content.push(...h)},d=h=>{if(typeof h=="string")return h;try{return JSON.stringify(h??{})}catch{return"{}"}},f=h=>{const g=be(()=>{const k=h.metadata?.detail;return k==="low"||k==="high"||k==="auto"?k:"auto"});if(h.fileId)return{type:"input_image",detail:g,file_id:h.fileId};if(h.url)return{type:"input_image",detail:g,image_url:h.url};if(h.data){const k=typeof h.data=="string"?h.data:Buffer.from(h.data).toString("base64"),S=h.mimeType??"image/png";return{type:"input_image",detail:g,image_url:`data:${S};base64,${k}`}}},c=h=>{if(h.fileId){const g=Ds(h);return{type:"input_file",file_id:h.fileId,...g?{filename:g}:{}}}if(h.url){const g=Ds(h);return{...g?{filename:g}:{},type:"input_file",file_url:h.url}}if(h.data){const g=Pt(h),k=typeof h.data=="string"?h.data:Buffer.from(h.data).toString("base64");return{type:"input_file",file_data:`data:${h.mimeType??"application/octet-stream"};base64,${k}`,...g?{filename:g}:{}}}},w=h=>{const g=be(()=>{if(Array.isArray(h.summary)){const L=h.summary?.map(E=>E?.text).filter(E=>typeof E=="string")??[];if(L.length>0)return L}return h.reasoning?[h.reasoning]:[]}),k=g.length>0?g.map(J=>({type:"summary_text",text:J})):[{type:"summary_text",text:""}],S={type:"reasoning",id:h.id??"",summary:k};return h.reasoning&&(S.content=[{type:"reasoning_text",text:h.reasoning}]),S},b=h=>({type:"function_call",name:h.name??"",call_id:h.id??"",arguments:d(h.args)}),C=h=>{const g=d(h.output),k=h.status==="success"?"completed":h.status==="error"?"incomplete":void 0;return{type:"function_call_output",call_id:h.toolCallId??"",output:g,...k?{status:k}:{}}};for(const h of e.contentBlocks)if(h.type==="text")m([{type:"input_text",text:h.text}]);else if(h.type!=="invalid_tool_call"){if(h.type==="reasoning")yield*u(),yield w(h);else if(h.type==="tool_call"){yield*u();const g=h.id??"";g&&(a.add(g),o.delete(g)),yield b(h)}else if(h.type==="tool_call_chunk"){if(h.id){const g=o.get(h.id)??{name:h.name,args:[]};h.name&&(g.name=h.name),h.args&&g.args.push(h.args),o.set(h.id,g)}}else if(h.type==="server_tool_call"){yield*u();const g=h.id??"";g&&(i.add(g),l.delete(g)),yield b(h)}else if(h.type==="server_tool_call_chunk"){if(h.id){const g=l.get(h.id)??{name:h.name,args:[]};h.name&&(g.name=h.name),h.args&&g.args.push(h.args),l.set(h.id,g)}}else if(h.type==="server_tool_call_result")yield*u(),yield C(h);else if(h.type!=="audio")if(h.type==="file"){const g=c(h);g&&m([g])}else if(h.type==="image"){const g=f(h);g&&m([g])}else if(h.type==="video"){const g=c(h);g&&m([g])}else h.type==="text-plain"?h.text&&m([{type:"input_text",text:h.text}]):h.type==="non_standard"&&t&&(yield*u(),yield h.value)}yield*u();for(const[h,g]of o){if(!h||a.has(h))continue;const k=g.args.join("");!g.name&&!k||(yield{type:"function_call",call_id:h,name:g.name??"",arguments:k})}for(const[h,g]of l){if(!h||i.has(h))continue;const k=g.args.join("");!g.name&&!k||(yield{type:"function_call",call_id:h,name:g.name??"",arguments:k})}}return Array.from(n())},Ws=({messages:e,zdrEnabled:t,model:n})=>e.flatMap(s=>{const r=s.response_metadata;if(r?.output_version==="v1")return Gu(s);const a=s.additional_kwargs;let i=Qe(s);if(i==="system"&&Ye(n)&&(i="developer"),i==="function")throw new Error("Function messages are not supported in Responses API");if(i==="tool"){const o=s;if(a?.type==="computer_call_output")return{type:"computer_call_output",output:(()=>{if(typeof o.content=="string")return{type:"input_image",image_url:o.content};if(Array.isArray(o.content)){const m=o.content.find(c=>c.type==="input_image");if(m)return m;const d=o.content.find(c=>c.type==="computer_screenshot");if(d)return d;const f=o.content.find(c=>c.type==="image_url");if(f)return{type:"input_image",image_url:typeof f.image_url=="string"?f.image_url:f.image_url.url}}throw new Error("Invalid computer call output")})(),call_id:o.tool_call_id};if(o.additional_kwargs?.customTool)return{type:"custom_tool_call_output",call_id:o.tool_call_id,output:o.content};const l=Array.isArray(o.content)&&o.content.every(u=>typeof u=="object"&&u!==null&&"type"in u&&(u.type==="input_file"||u.type==="input_image"||u.type==="input_text"));return{type:"function_call_output",call_id:o.tool_call_id,id:o.id?.startsWith("fc_")?o.id:void 0,output:l?o.content:typeof o.content!="string"?JSON.stringify(o.content):o.content}}if(i==="assistant"){if(!t&&r?.output!=null&&Array.isArray(r?.output)&&r?.output.length>0&&r?.output.every(f=>"type"in f))return r?.output;const o=[];if(a?.reasoning&&!t){const f=Vu(a.reasoning);o.push(f)}let{content:l}=s;a?.refusal&&(typeof l=="string"&&(l=[{type:"output_text",text:l,annotations:[]}]),l=[...l,{type:"refusal",refusal:a.refusal}]),(typeof l=="string"||l.length>0)&&o.push({type:"message",role:"assistant",...s.id&&!t&&s.id.startsWith("msg_")?{id:s.id}:{},content:be(()=>typeof l=="string"?l:l.flatMap(f=>f.type==="text"?{type:"output_text",text:f.text,annotations:f.annotations??[]}:f.type==="output_text"||f.type==="refusal"?f:[]))});const u=a?.[Nt];Ce.isInstance(s)&&s.tool_calls?.length?o.push(...s.tool_calls.map(f=>Fo(f)?{type:"custom_tool_call",id:f.call_id,call_id:f.id??"",input:f.args.input,name:f.name}:Bo(f)?{type:"computer_call",id:f.call_id,call_id:f.id??"",action:f.args.action}:{type:"function_call",name:f.name,arguments:JSON.stringify(f.args),call_id:f.id,...t?{}:{id:u?.[f.id]}})):a?.tool_calls&&o.push(...a.tool_calls.map(f=>({type:"function_call",name:f.function.name,call_id:f.id,arguments:f.function.arguments,...t?{}:{id:u?.[f.id]}})));const m=r?.output?.length?r?.output:a.tool_outputs,d=["computer_call","mcp_call","code_interpreter_call","image_generation_call"];if(m!=null){const c=m?.filter(w=>d.includes(w.type));c.length>0&&o.push(...c)}return o}if(i==="user"||i==="system"||i==="developer"){if(typeof s.content=="string")return{type:"message",role:i,content:s.content};const o=[],l=s.content.flatMap(u=>{if(u.type==="mcp_approval_response"&&o.push({type:"mcp_approval_response",approval_request_id:u.approval_request_id,approve:u.approve}),Js(u))return Hs(u,Ua);if(u.type==="text")return{type:"input_text",text:u.text};if(u.type==="image_url"){const m=be(()=>{if(typeof u.image_url=="string")return u.image_url;if(typeof u.image_url=="object"&&u.image_url!==null&&"url"in u.image_url)return u.image_url.url}),d=be(()=>{if(typeof u.image_url=="string")return"auto";if(typeof u.image_url=="object"&&u.image_url!==null&&"detail"in u.image_url)return u.image_url.detail});return{type:"input_image",image_url:m,detail:d}}return u.type==="input_text"||u.type==="input_image"||u.type==="input_file"?u:[]});return l.length>0&&o.push({type:"message",role:i,content:l}),o}return console.warn(`Unsupported role found when converting to OpenAI Responses API: ${i}`),[]});var Ka=class extends Xn{invocationParams(e){let t;e?.strict!==void 0&&(t=e.strict),t===void 0&&this.supportsStrictToolCalling!==void 0&&(t=this.supportsStrictToolCalling);const n={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e?.previous_response_id,truncation:e?.truncation,include:e?.include,tools:e?.tools?.length?this._reduceChatOpenAITools(e.tools,{stream:this.streaming,strict:t}):void 0,tool_choice:Lo(e?.tool_choice)?e?.tool_choice:(()=>{const r=Ra(e?.tool_choice);if(typeof r=="object"&&"type"in r){if(r.type==="function")return{type:"function",name:r.function.name};if(r.type==="allowed_tools")return{type:"allowed_tools",mode:r.allowed_tools.mode,tools:r.allowed_tools.tools};if(r.type==="custom")return{type:"custom",name:r.custom.name}}})(),text:(()=>{if(e?.text)return e.text;const r=this._getResponseFormat(e?.response_format);return r?.type==="json_schema"?r.json_schema.schema!=null?{format:{type:"json_schema",schema:r.json_schema.schema,description:r.json_schema.description,name:r.json_schema.name,strict:r.json_schema.strict},verbosity:e?.verbosity}:void 0:{format:r,verbosity:e?.verbosity}})(),parallel_tool_calls:e?.parallel_tool_calls,max_output_tokens:this.maxTokens===-1?void 0:this.maxTokens,prompt_cache_key:e?.promptCacheKey??this.promptCacheKey,prompt_cache_retention:e?.promptCacheRetention??this.promptCacheRetention,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs},s=this._getReasoningParams(e);return s!==void 0&&(n.reasoning=s),n}async _generate(e,t,n){t.signal?.throwIfAborted();const s=this.invocationParams(t);if(s.stream){const r=this._streamResponseChunks(e,t,n);let a;for await(const i of r)i.message.response_metadata={...i.generationInfo,...i.message.response_metadata},a=a?.concat(i)??i;return{generations:a?[a]:[],llmOutput:{estimatedTokenUsage:a?.message?.usage_metadata}}}else{const r=await this.completionWithRetry({input:Ws({messages:e,zdrEnabled:this.zdrEnabled??!1,model:this.model}),...s,stream:!1},{signal:t?.signal,...t?.options});return{generations:[{text:r.output_text,message:Fa(r)}],llmOutput:{id:r.id,estimatedTokenUsage:r.usage?{promptTokens:r.usage.input_tokens,completionTokens:r.usage.output_tokens,totalTokens:r.usage.total_tokens}:void 0}}}}async*_streamResponseChunks(e,t,n){const s=await this.completionWithRetry({...this.invocationParams(t),input:Ws({messages:e,zdrEnabled:this.zdrEnabled??!1,model:this.model}),stream:!0},t);for await(const r of s){if(t.signal?.aborted)return;const a=Xu(r);a!=null&&(yield a,await n?.handleLLMNewToken(a.text||"",{prompt:t.promptIndex??0,completion:0},void 0,void 0,void 0,{chunk:a}))}}async completionWithRetry(e,t){return this.caller.call(async()=>{const n=this._getClientOptions(t);try{return e.text?.format?.type==="json_schema"&&!e.stream?await this.client.responses.parse(e,n):await this.client.responses.create(e,n)}catch(s){throw Re(s)}})}_reduceChatOpenAITools(e,t){const n=[];for(const s of e)if(Vn(s))s.type==="image_generation"&&t?.stream&&(s.partial_images=1),n.push(s);else if(Et(s)){const r=s.metadata.customTool;n.push({type:"custom",name:r.name,description:r.description,format:r.format})}else Xs(s)?n.push({type:"function",name:s.function.name,parameters:s.function.parameters,description:s.function.description,strict:t?.strict??null}):Ea(s)&&n.push(Ko(s));return n}},Yu=class extends Ka{azureOpenAIApiVersion;azureOpenAIApiKey;azureADTokenProvider;azureOpenAIApiInstanceName;azureOpenAIApiDeploymentName;azureOpenAIBasePath;azureOpenAIEndpoint;_llmType(){return"azure_openai"}get lc_aliases(){return{...super.lc_aliases,...Gn}}get lc_secrets(){return{...super.lc_secrets,...Yn}}get lc_serializable_keys(){return[...super.lc_serializable_keys,...Qn]}getLsParams(e){const t=super.getLsParams(e);return t.ls_provider="azure",t}constructor(e){super(e),es.call(this,e)}_getClientOptions(e){return Da.call(this,e)}toJSON(){return ts.call(this,super.toJSON())}},Qu=class qa extends Xn{useResponsesApi=!1;responses;completions;get lc_serializable_keys(){return[...super.lc_serializable_keys,"useResponsesApi"]}get callKeys(){return[...super.callKeys,"useResponsesApi"]}constructor(t){super(t),this.fields=t,this.useResponsesApi=t?.useResponsesApi??!1,this.responses=t?.responses??new Ka(t),this.completions=t?.completions??new La(t)}_useResponsesApi(t){const n=t?.tools?.some(Vn),s=t?.previous_response_id!=null||t?.text!=null||t?.truncation!=null||t?.include!=null||t?.reasoning?.summary!=null||this.reasoning?.summary!=null,r=t?.tools?.some(Ea)||t?.tools?.some(Et);return this.useResponsesApi||n||s||r||Ro(this.model)}getLsParams(t){const n=this._combineCallOptions(t);return this._useResponsesApi(t)?this.responses.getLsParams(n):this.completions.getLsParams(n)}invocationParams(t){const n=this._combineCallOptions(t);return this._useResponsesApi(t)?this.responses.invocationParams(n):this.completions.invocationParams(n)}async _generate(t,n,s){return this._useResponsesApi(n)?this.responses._generate(t,n,s):this.completions._generate(t,n,s)}async*_streamResponseChunks(t,n,s){if(this._useResponsesApi(n)){yield*this.responses._streamResponseChunks(t,this._combineCallOptions(n),s);return}yield*this.completions._streamResponseChunks(t,this._combineCallOptions(n),s)}withConfig(t){const n=new qa(this.fields);return n.defaultOptions={...this.defaultOptions,...t},n}},Ql=class extends Qu{azureOpenAIApiVersion;azureOpenAIApiKey;azureADTokenProvider;azureOpenAIApiInstanceName;azureOpenAIApiDeploymentName;azureOpenAIBasePath;azureOpenAIEndpoint;_llmType(){return"azure_openai"}get lc_aliases(){return{...super.lc_aliases,...Gn}}get lc_secrets(){return{...super.lc_secrets,...Yn}}get lc_serializable_keys(){return[...super.lc_serializable_keys,...Qn]}getLsParams(e){const t=super.getLsParams(e);return t.ls_provider="azure",t}constructor(e){super({...e,completions:new Hu(e),responses:new Yu(e)}),es.call(this,e)}_getStructuredOutputMethod(e){const t={...e};return this.model.startsWith("gpt-4o")&&t?.method===void 0?"functionCalling":super._getStructuredOutputMethod(t)}toJSON(){return ts.call(this,super.toJSON())}},el=class extends gi{static lc_name(){return"OpenAI"}get callKeys(){return[...super.callKeys,"options"]}lc_serializable=!0;get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}temperature;maxTokens;topP;frequencyPenalty;presencePenalty;n=1;bestOf;logitBias;model="gpt-3.5-turbo-instruct";modelName;modelKwargs;batchSize=20;timeout;stop;stopSequences;user;streaming=!1;openAIApiKey;apiKey;organization;client;clientConfig;constructor(e){if(super(e??{}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??R("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=e?.configuration?.organization??R("OPENAI_ORGANIZATION"),this.model=e?.model??e?.modelName??this.model,(this.model?.startsWith("gpt-3.5-turbo")||this.model?.startsWith("gpt-4")||this.model?.startsWith("o1"))&&!this.model?.includes("-instruct"))throw new Error([`Your chosen OpenAI model, "${this.model}", is a chat model and not a text-in/text-out LLM.`,'Passing it into the "OpenAI" class is no longer supported.','Please use the "ChatOpenAI" class instead.',"","See this page for more information:","|","> https://js.langchain.com/docs/integrations/chat/openai"].join(`
`));if(this.modelName=this.model,this.modelKwargs=e?.modelKwargs??{},this.batchSize=e?.batchSize??this.batchSize,this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.maxTokens=e?.maxTokens??this.maxTokens,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.bestOf=e?.bestOf??this.bestOf,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.streaming&&this.bestOf&&this.bestOf>1)throw new Error("Cannot stream results when bestOf > 1");this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e?.configuration}}invocationParams(e){return{model:this.model,temperature:this.temperature,max_tokens:this.maxTokens,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,best_of:this.bestOf,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){const s=rn(e,this.batchSize),r=[],a={},i=this.invocationParams(t);if(i.max_tokens===-1){if(e.length!==1)throw new Error("max_tokens set to -1 not supported for multiple inputs");i.max_tokens=await fi({prompt:e[0],modelName:this.model})}for(let l=0;l<s.length;l+=1){const u=i.stream?await(async()=>{const c=[];let w;const b=await this.completionWithRetry({...i,stream:!0,prompt:s[l]},t);for await(const C of b){w||(w={id:C.id,object:C.object,created:C.created,model:C.model});for(const h of C.choices){if(!c[h.index])c[h.index]=h;else{const g=c[h.index];g.text+=h.text,g.finish_reason=h.finish_reason,g.logprobs=h.logprobs}n?.handleLLMNewToken(h.text,{prompt:Math.floor(h.index/this.n),completion:h.index%this.n})}}if(t.signal?.aborted)throw new Error("AbortError");return{...w,choices:c}})():await this.completionWithRetry({...i,stream:!1,prompt:s[l]},{signal:t.signal,...t.options});r.push(...u.choices);const{completion_tokens:m,prompt_tokens:d,total_tokens:f}=u.usage?u.usage:{completion_tokens:void 0,prompt_tokens:void 0,total_tokens:void 0};m&&(a.completionTokens=(a.completionTokens??0)+m),d&&(a.promptTokens=(a.promptTokens??0)+d),f&&(a.totalTokens=(a.totalTokens??0)+f)}return{generations:rn(r,this.n).map(l=>l.map(u=>({text:u.text??"",generationInfo:{finishReason:u.finish_reason,logprobs:u.logprobs}}))),llmOutput:{tokenUsage:a}}}async*_streamResponseChunks(e,t,n){const s={...this.invocationParams(t),prompt:e,stream:!0},r=await this.completionWithRetry(s,t);for await(const a of r){const i=a?.choices[0];if(!i)continue;const o=new ii({text:i.text,generationInfo:{finishReason:i.finish_reason}});yield o,n?.handleLLMNewToken(o.text??"")}if(t.signal?.aborted)throw new Error("AbortError")}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.completions.create(e,n)}catch(s){throw Re(s)}})}_getClientOptions(e){if(!this.client){const n={baseURL:this.clientConfig.baseURL},s=Ee(n),r={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};r.baseURL||delete r.baseURL,r.defaultHeaders=$e(r.defaultHeaders),this.client=new v(r)}return{...this.clientConfig,...e}}_llmType(){return"openai"}},ec=class extends el{azureOpenAIApiVersion;azureOpenAIApiKey;azureADTokenProvider;azureOpenAIApiInstanceName;azureOpenAIApiDeploymentName;azureOpenAIBasePath;azureOpenAIEndpoint;get lc_aliases(){return{...super.lc_aliases,openAIApiKey:"openai_api_key",openAIApiVersion:"openai_api_version",openAIBasePath:"openai_api_base",deploymentName:"deployment_name",azureOpenAIEndpoint:"azure_endpoint",azureOpenAIApiVersion:"openai_api_version",azureOpenAIBasePath:"openai_api_base",azureOpenAIApiDeploymentName:"deployment_name"}}get lc_secrets(){return{...super.lc_secrets,azureOpenAIApiKey:"AZURE_OPENAI_API_KEY"}}constructor(e){if(super(e),this.azureOpenAIApiDeploymentName=(e?.azureOpenAIApiCompletionsDeploymentName||e?.azureOpenAIApiDeploymentName)??(R("AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME")||R("AZURE_OPENAI_API_DEPLOYMENT_NAME")),this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(typeof e?.openAIApiKey=="string"?e?.openAIApiKey:void 0)??(typeof e?.apiKey=="string"?e?.apiKey:void 0)??R("AZURE_OPENAI_API_KEY"),this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??R("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??e?.openAIApiVersion??R("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??R("AZURE_OPENAI_BASE_PATH"),this.azureOpenAIEndpoint=e?.azureOpenAIEndpoint??R("AZURE_OPENAI_ENDPOINT"),this.azureADTokenProvider=e?.azureADTokenProvider,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("Azure OpenAI API key or Token Provider not found")}_getClientOptions(e){if(!this.client){const n={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,azureADTokenProvider:this.azureADTokenProvider,baseURL:this.clientConfig.baseURL},s=Ee(n),{apiKey:r,...a}=this.clientConfig,i={...a,baseURL:s,timeout:this.timeout,maxRetries:0};this.azureADTokenProvider||(i.apiKey=n.azureOpenAIApiKey),i.baseURL||delete i.baseURL,i.defaultHeaders=$e(i.defaultHeaders,!0,"2.0.0"),this.client=new Hn({apiVersion:this.azureOpenAIApiVersion,azureADTokenProvider:this.azureADTokenProvider,...i})}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}toJSON(){const e=super.toJSON();function t(n){return typeof n=="object"&&n!=null}return t(e)&&t(e.kwargs)&&(delete e.kwargs.azure_openai_base_path,delete e.kwargs.azure_openai_api_deployment_name,delete e.kwargs.azure_openai_api_key,delete e.kwargs.azure_openai_api_version,delete e.kwargs.azure_open_ai_base_path),e}},tl=class extends _i{model="text-embedding-ada-002";modelName;batchSize=512;stripNewLines=!0;dimensions;timeout;organization;encodingFormat;client;clientConfig;apiKey;constructor(e){const t={maxConcurrency:2,...e};super(t);const n=t?.apiKey??t?.openAIApiKey??R("OPENAI_API_KEY");this.organization=t?.configuration?.organization??R("OPENAI_ORGANIZATION"),this.model=t?.model??t?.modelName??this.model,this.modelName=this.model,this.batchSize=t?.batchSize??this.batchSize,this.stripNewLines=t?.stripNewLines??this.stripNewLines,this.timeout=t?.timeout,this.dimensions=t?.dimensions,this.encodingFormat=t?.encodingFormat,this.clientConfig={apiKey:n,organization:this.organization,dangerouslyAllowBrowser:!0,...e?.configuration}}async embedDocuments(e){const t=rn(this.stripNewLines?e.map(a=>a.replace(/\n/g," ")):e,this.batchSize),n=t.map(a=>{const i={model:this.model,input:a};return this.dimensions&&(i.dimensions=this.dimensions),this.encodingFormat&&(i.encoding_format=this.encodingFormat),this.embeddingWithRetry(i)}),s=await Promise.all(n),r=[];for(let a=0;a<s.length;a+=1){const i=t[a],{data:o}=s[a];for(let l=0;l<i.length;l+=1)r.push(o[l].embedding)}return r}async embedQuery(e){const t={model:this.model,input:this.stripNewLines?e.replace(/\n/g," "):e};this.dimensions&&(t.dimensions=this.dimensions),this.encodingFormat&&(t.encoding_format=this.encodingFormat);const{data:n}=await this.embeddingWithRetry(t);return n[0].embedding}async embeddingWithRetry(e){if(!this.client){const n={baseURL:this.clientConfig.baseURL},s=Ee(n),r={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};r.baseURL||delete r.baseURL,r.defaultHeaders=$e(r.defaultHeaders),this.client=new v(r)}const t={};return this.caller.call(async()=>{try{return await this.client.embeddings.create(e,t)}catch(n){throw Re(n)}})}},tc=class extends tl{azureOpenAIApiVersion;azureOpenAIApiKey;azureADTokenProvider;azureOpenAIApiInstanceName;azureOpenAIApiDeploymentName;azureOpenAIBasePath;constructor(e){super(e),this.batchSize=e?.batchSize??1,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(typeof e?.apiKey=="string"?e?.apiKey:void 0)??R("AZURE_OPENAI_API_KEY"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??e?.openAIApiVersion??R("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??R("AZURE_OPENAI_BASE_PATH"),this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??R("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e?.azureOpenAIApiEmbeddingsDeploymentName||e?.azureOpenAIApiDeploymentName)??(R("AZURE_OPENAI_API_EMBEDDINGS_DEPLOYMENT_NAME")||R("AZURE_OPENAI_API_DEPLOYMENT_NAME")),this.azureADTokenProvider=e?.azureADTokenProvider}async embeddingWithRetry(e){if(!this.client){const n={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,azureADTokenProvider:this.azureADTokenProvider,baseURL:this.clientConfig.baseURL},s=Ee(n),{apiKey:r,...a}=this.clientConfig,i={...a,baseURL:s,timeout:this.timeout,maxRetries:0};this.azureADTokenProvider||(i.apiKey=n.azureOpenAIApiKey),i.baseURL||delete i.baseURL,i.defaultHeaders=$e(i.defaultHeaders,!0,"2.0.0"),this.client=new Hn({apiVersion:this.azureOpenAIApiVersion,azureADTokenProvider:this.azureADTokenProvider,deployment:this.azureOpenAIApiDeploymentName,...i})}const t={};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),this.caller.call(async()=>{try{return await this.client.embeddings.create(e,t)}catch(n){throw Re(n)}})}},nc=class extends yi{static lc_name(){return"DallEAPIWrapper"}name="dalle_api_wrapper";description="A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description.";client;static toolName="dalle_api_wrapper";model="dall-e-3";style="vivid";quality="standard";n=1;size="1024x1024";dallEResponseFormat="url";user;constructor(e){e?.responseFormat!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e);const t=e?.apiKey??e?.openAIApiKey??R("OPENAI_API_KEY"),n=e?.organization??R("OPENAI_ORGANIZATION"),s={apiKey:t,organization:n,dangerouslyAllowBrowser:!0,baseURL:e?.baseUrl};this.client=new v(s),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return this.dallEResponseFormat==="url"?e.flatMap(t=>t.data?.flatMap(s=>s.url?{type:"image_url",image_url:s.url}:[]).filter(s=>s!==void 0&&s.type==="image_url"&&typeof s.image_url=="string"&&s.image_url!==void 0)??[]):e.flatMap(t=>t.data?.flatMap(s=>s.b64_json?{type:"image_url",image_url:{url:s.b64_json}}:[]).filter(s=>s!==void 0&&s.type==="image_url"&&typeof s.image_url=="object"&&"url"in s.image_url&&typeof s.image_url.url=="string"&&s.image_url.url!==void 0)??[])}async _call(e){const t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){const r=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(r)}const n=await this.client.images.generate(t);let s="";return this.dallEResponseFormat==="url"?[s]=n.data?.map(r=>r.url).filter(r=>r!=="undefined")??[]:[s]=n.data?.map(r=>r.b64_json).filter(r=>r!=="undefined")??[],s}};function nl(e){return{type:"web_search",filters:e?.filters?.allowedDomains?{allowed_domains:e.filters.allowedDomains}:void 0,user_location:e?.userLocation,search_context_size:e?.search_context_size}}function On(e){return{tool_names:e.toolNames,read_only:e.readOnly}}function sl(e){if(e)return Array.isArray(e)?e:On(e)}function rl(e){if(e)return typeof e=="string"?e:{always:e.always?On(e.always):void 0,never:e.never?On(e.never):void 0}}function al(e){const t={type:"mcp",server_label:e.serverLabel,allowed_tools:sl(e.allowedTools),authorization:e.authorization,headers:e.headers,require_approval:rl(e.requireApproval),server_description:e.serverDescription};return"serverUrl"in e?{...t,server_url:e.serverUrl}:{...t,connector_id:e.connectorId}}function il(e){return typeof e=="string"?e:{type:"auto",file_ids:e?.fileIds,memory_limit:e?.memoryLimit}}function ol(e){return{type:"code_interpreter",container:il(e?.container)}}function ul(e){if(e)return{ranker:e.ranker,score_threshold:e.scoreThreshold,hybrid_search:e.hybridSearch?{embedding_weight:e.hybridSearch.embeddingWeight,text_weight:e.hybridSearch.textWeight}:void 0}}function ll(e){return{type:"file_search",vector_store_ids:e.vectorStoreIds,max_num_results:e.maxNumResults,filters:e.filters,ranking_options:ul(e.rankingOptions)}}function cl(e){if(e)return{image_url:e.imageUrl,file_id:e.fileId}}function pl(e){return{type:"image_generation",background:e?.background,input_fidelity:e?.inputFidelity,input_image_mask:cl(e?.inputImageMask),model:e?.model,moderation:e?.moderation,output_compression:e?.outputCompression,output_format:e?.outputFormat,partial_images:e?.partialImages,quality:e?.quality,size:e?.size}}const dl=Z({type:te("screenshot")}),hl=Z({type:te("click"),x:W(),y:W(),button:Vs(["left","right","wheel","back","forward"]).default("left")}),fl=Z({type:te("double_click"),x:W(),y:W(),button:Vs(["left","right","wheel","back","forward"]).default("left")}),ml=Z({type:te("drag"),path:Mt(Z({x:W(),y:W()}))}),gl=Z({type:te("keypress"),keys:Mt(Q())}),_l=Z({type:te("move"),x:W(),y:W()}),yl=Z({type:te("scroll"),x:W(),y:W(),scroll_x:W(),scroll_y:W()}),wl=Z({type:te("type"),text:Q()}),bl=Z({type:te("wait"),duration:W().optional()}),Al=xn("type",[dl,hl,fl,ml,gl,_l,yl,wl,bl]),Il=Z({action:Al}),Ol="computer_use";function vl(e){const t=zt(async(n,s)=>{const i=s.state?.messages.at(-1)?.tool_calls?.find(l=>l.name==="computer_use")?.id;if(!i)throw new Error("Computer use call id not found");const o=await e.execute(n.action,s);return typeof o=="string"?new bt({content:o,tool_call_id:i,additional_kwargs:{type:"computer_call_output"}}):new bt({...o,tool_call_id:i,additional_kwargs:{type:"computer_call_output",...o.additional_kwargs}})},{name:Ol,description:"Control a computer interface by executing mouse clicks, keyboard input, scrolling, and other actions.",schema:Il});return t.extras={...t.extras??{},providerToolDefinition:{type:"computer_use_preview",display_width:e.displayWidth,display_height:e.displayHeight,environment:e.environment}},t}const xl=Z({type:te("exec"),command:Mt(Q()),env:oi(Q(),Q()).optional(),working_directory:Q().optional(),timeout_ms:W().optional(),user:Q().optional()}),kl=xn("type",[xl]),Tl="local_shell";function Cl(e){const t=zt(e.execute,{name:Tl,description:"Execute shell commands locally on the machine. Commands are provided as argv tokens.",schema:kl});return t.extras={...t.extras??{},providerToolDefinition:{type:"local_shell"}},t}const Sl=Z({commands:Mt(Q()).describe("Array of shell commands to execute"),timeout_ms:W().optional().describe("Optional timeout in milliseconds for the commands"),max_output_length:W().optional().describe("Optional maximum number of characters to return from each command")}),Pl="shell";function Rl(e){const n=zt(async s=>{const r=await e.execute(s);return JSON.stringify({output:r.output,max_output_length:r.maxOutputLength})},{name:Pl,description:"Execute shell commands in a managed environment. Commands can be run concurrently.",schema:Sl});return n.extras={...n.extras??{},providerToolDefinition:{type:"shell"}},n}const El=Z({type:te("create_file"),path:Q(),diff:Q()}),$l=Z({type:te("update_file"),path:Q(),diff:Q()}),Nl=Z({type:te("delete_file"),path:Q()}),Ml=xn("type",[El,$l,Nl]),zl="apply_patch";function Ul(e){const t=zt(e.execute,{name:zl,description:"Apply structured diffs to create, update, or delete files in the codebase.",schema:Ml});return t.extras={...t.extras??{},providerToolDefinition:{type:"apply_patch"}},t}const sc={webSearch:nl,mcp:al,codeInterpreter:ol,fileSearch:ll,imageGeneration:pl,computerUse:vl,localShell:Cl,shell:Rl,applyPatch:Ul};function rc(e,t){return new wi({...t,description:"",metadata:{customTool:t},func:async(n,s,r)=>new Promise((a,i)=>{const o=ui(r,{callbacks:s?.getChild()});li.runWithConfig(ci(o),async()=>{try{a(e(n,o))}catch(l){i(l)}})})})}function ac(e){const t=e.toChatMessages();return{messages:In({messages:t})}}export{Ql as AzureChatOpenAI,Hu as AzureChatOpenAICompletions,Yu as AzureChatOpenAIResponses,ec as AzureOpenAI,tc as AzureOpenAIEmbeddings,Xn as BaseChatOpenAI,Qu as ChatOpenAI,La as ChatOpenAICompletions,Ka as ChatOpenAIResponses,nc as DallEAPIWrapper,el as OpenAI,v as OpenAIClient,tl as OpenAIEmbeddings,Ua as completionsApiContentBlockConverter,Wu as convertCompletionsDeltaToBaseMessageChunk,qu as convertCompletionsMessageToBaseMessage,In as convertMessagesToCompletionsMessageParams,Ws as convertMessagesToResponsesInput,ac as convertPromptToOpenAI,Vu as convertReasoningSummaryToResponsesReasoningItem,Xu as convertResponsesDeltaToChatGenerationChunk,Fa as convertResponsesMessageToAIMessage,Ba as convertResponsesUsageToUsageMetadata,Zu as convertStandardContentBlockToCompletionsContentPart,Ju as convertStandardContentMessageToCompletionsMessage,Gu as convertStandardContentMessageToResponsesInput,rc as customTool,Ee as getEndpoint,$o as getFormattedEnv,$e as getHeadersWithUserAgent,js as isHeaders,Qe as messageToOpenAIRole,Eo as normalizeHeaders,Qi as toFile,sc as tools,Re as wrapOpenAIClientError};
