import{a3 as H,r as oe,a4 as ie,E as ce,t as J,K as S,a5 as ae,a6 as ue}from"./index-B9xgKKTO.js";import{p as le,f as he}from"./client-t4HcGl6d.js";import"./langfuse-U2OEF7K7-Bke0aacP.js";import"./index-DtYddBwZ.js";import"./index-D8-Z6Ssp.js";import"./embeddings-CxF6I3vU.js";import"./llms-DYitwP9m.js";const fe={},de="browser",pe="v18.0.0",me={node:"18.0.0"},ve=()=>"/",we=(c,...e)=>queueMicrotask(()=>c(...e)),_e=!0,N={env:fe,platform:de,version:pe,versions:me,cwd:ve,nextTick:we,browser:_e};var y={exports:{}};function X(){throw new Error("child_process.spawn is not available in browser environment")}function V(){throw new Error("child_process.exec is not available in browser environment")}function Y(){throw new Error("child_process.execFile is not available in browser environment")}function Q(){throw new Error("child_process.fork is not available in browser environment")}function Z(){throw new Error("child_process.execSync is not available in browser environment")}function ee(){throw new Error("child_process.spawnSync is not available in browser environment")}function te(){throw new Error("child_process.execFileSync is not available in browser environment")}const ge={spawn:X,exec:V,execFile:Y,fork:Q,execSync:Z,spawnSync:ee,execFileSync:te},Ee=Object.freeze(Object.defineProperty({__proto__:null,default:ge,exec:V,execFile:Y,execFileSync:te,execSync:Z,fork:Q,spawn:X,spawnSync:ee},Symbol.toStringTag,{value:"Module"})),ye=H(Ee),re=H(le),ne=H(he);var M,F;function xe(){if(F)return M;F=1;var c={};M=o,o.sync=s;var e=ne;function n(r,l){var a=l.pathExt!==void 0?l.pathExt:c.PATHEXT;if(!a||(a=a.split(";"),a.indexOf("")!==-1))return!0;for(var i=0;i<a.length;i++){var u=a[i].toLowerCase();if(u&&r.substr(-u.length).toLowerCase()===u)return!0}return!1}function t(r,l,a){return!r.isSymbolicLink()&&!r.isFile()?!1:n(l,a)}function o(r,l,a){e.stat(r,function(i,u){a(i,i?!1:t(u,r,l))})}function s(r,l){return t(e.statSync(r),r,l)}return M}var R,B;function Se(){if(B)return R;B=1,R=e,e.sync=n;var c=ne;function e(s,r,l){c.stat(s,function(a,i){l(a,a?!1:t(i,r))})}function n(s,r){return t(c.statSync(s),r)}function t(s,r){return s.isFile()&&o(s,r)}function o(s,r){var l=s.mode,a=s.uid,i=s.gid,u=r.uid!==void 0?r.uid:process.getuid&&process.getuid(),f=r.gid!==void 0?r.gid:process.getgid&&process.getgid(),h=parseInt("100",8),p=parseInt("010",8),m=parseInt("001",8),w=h|p,_=l&m||l&p&&i===f||l&h&&a===u||l&w&&u===0;return _}return R}var q,L;function be(){if(L)return q;L=1;var c;globalThis.TESTING_WINDOWS?c=xe():c=Se(),q=e,e.sync=n;function e(t,o,s){if(typeof o=="function"&&(s=o,o={}),!s){if(typeof Promise!="function")throw new TypeError("callback not provided");return new Promise(function(r,l){e(t,o||{},function(a,i){a?l(a):r(i)})})}c(t,o||{},function(r,l){r&&(r.code==="EACCES"||o&&o.ignoreErrors)&&(r=null,l=!1),s(r,l)})}function n(t,o){try{return c.sync(t,o||{})}catch(s){if(o&&o.ignoreErrors||s.code==="EACCES")return!1;throw s}}return q}var I,W;function Ce(){if(W)return I;W=1;var c={};const e=c.OSTYPE==="cygwin"||c.OSTYPE==="msys",n=re,t=e?";":":",o=be(),s=i=>Object.assign(new Error(`not found: ${i}`),{code:"ENOENT"}),r=(i,u)=>{const f=u.colon||t,h=i.match(/\//)||e&&i.match(/\\/)?[""]:[...e?[process.cwd()]:[],...(u.path||c.PATH||"").split(f)],p=e?u.pathExt||c.PATHEXT||".EXE;.CMD;.BAT;.COM":"",m=e?p.split(f):[""];return e&&i.indexOf(".")!==-1&&m[0]!==""&&m.unshift(""),{pathEnv:h,pathExt:m,pathExtExe:p}},l=(i,u,f)=>{typeof u=="function"&&(f=u,u={}),u||(u={});const{pathEnv:h,pathExt:p,pathExtExe:m}=r(i,u),w=[],_=d=>new Promise((E,g)=>{if(d===h.length)return u.all&&w.length?E(w):g(s(i));const v=h[d],T=/^".*"$/.test(v)?v.slice(1,-1):v,x=n.join(T,i),$=!T&&/^\.[\\\/]/.test(i)?i.slice(0,2)+x:x;E(P($,d,0))}),P=(d,E,g)=>new Promise((v,T)=>{if(g===p.length)return v(_(E+1));const x=p[g];o(d+x,{pathExt:m},($,se)=>{if(!$&&se)if(u.all)w.push(d+x);else return v(d+x);return v(P(d,E,g+1))})});return f?_(0).then(d=>f(null,d),f):_(0)},a=(i,u)=>{u=u||{};const{pathEnv:f,pathExt:h,pathExtExe:p}=r(i,u),m=[];for(let w=0;w<f.length;w++){const _=f[w],P=/^".*"$/.test(_)?_.slice(1,-1):_,d=n.join(P,i),E=!P&&/^\.[\\\/]/.test(i)?i.slice(0,2)+d:d;for(let g=0;g<h.length;g++){const v=E+h[g];try{if(o.sync(v,{pathExt:p}))if(u.all)m.push(v);else return v}catch{}}}if(u.all&&m.length)return m;if(u.nothrow)return null;throw s(i)};return I=l,l.sync=a,I}var O={exports:{}},K;function Pe(){if(K)return O.exports;K=1;var c={};const e=(n={})=>{const t=n.env||c;return(n.platform||"browser")!=="win32"?"PATH":Object.keys(t).reverse().find(s=>s.toUpperCase()==="PATH")||"Path"};return O.exports=e,O.exports.default=e,O.exports}var k,D;function Te(){if(D)return k;D=1;var c={};const e=re,n=Ce(),t=Pe();function o(r,l){const a=r.options.env||c,i=process.cwd(),u=r.options.cwd!=null,f=u&&process.chdir!==void 0&&!process.chdir.disabled;if(f)try{process.chdir(r.options.cwd)}catch{}let h;try{h=n.sync(r.command,{path:a[t({env:a})],pathExt:l?e.delimiter:void 0})}catch{}finally{f&&process.chdir(i)}return h&&(h=e.resolve(u?r.options.cwd:"",h)),h}function s(r){return o(r)||o(r,!0)}return k=s,k}var A,G;function Oe(){if(G)return A;G=1,Te();function c(n){return n}function e(n,t,o){t&&!Array.isArray(t)&&(o=t,t=null),t=t?t.slice(0):[],o=Object.assign({},o);const s={command:n,args:t,options:o,file:void 0,original:{command:n,args:t}};return o.shell?s:s}return A=e,A}var j,U;function Ne(){if(U)return j;U=1;function c(o,s){return Object.assign(new Error(`${s} ${o.command} ENOENT`),{code:"ENOENT",errno:"ENOENT",syscall:`${s} ${o.command}`,path:o.command,spawnargs:o.args})}function e(o,s){}function n(o,s){return null}function t(o,s){return null}return j={hookChildProcess:e,verifyENOENT:n,verifyENOENTSync:t,notFoundError:c},j}var z;function $e(){if(z)return y.exports;z=1;const c=ye,e=Oe(),n=Ne();function t(s,r,l){const a=e(s,r,l),i=c.spawn(a.command,a.args,a.options);return n.hookChildProcess(i,a),i}function o(s,r,l){const a=e(s,r,l),i=c.spawnSync(a.command,a.args,a.options);return i.error=i.error||n.verifyENOENTSync(i.status,a),i}return y.exports=t,y.exports.spawn=t,y.exports.sync=o,y.exports._parse=e,y.exports._enoent=n,y.exports}var Me=$e();const Re=oe(Me);class qe{constructor(){console.warn("PassThrough stream is not available in browser environment")}}class Ie{append(e){this._buffer=this._buffer?Buffer.concat([this._buffer,e]):e}readMessage(){if(!this._buffer)return null;const e=this._buffer.indexOf(`
`);if(e===-1)return null;const n=this._buffer.toString("utf8",0,e).replace(/\r$/,"");return this._buffer=this._buffer.subarray(e+1),ke(n)}clear(){this._buffer=void 0}}function ke(c){return ie.parse(JSON.parse(c))}function Ae(c){return JSON.stringify(c)+`
`}const je=["HOME","LOGNAME","PATH","SHELL","TERM","USER"];function He(){const c={};for(const e of je){const n=N.env[e];n!==void 0&&(n.startsWith("()")||(c[e]=n))}return c}class Fe{constructor(e){this._readBuffer=new Ie,this._stderrStream=null,this._serverParams=e,(e.stderr==="pipe"||e.stderr==="overlapped")&&(this._stderrStream=new qe)}async start(){if(this._process)throw new Error("StdioClientTransport already started! If using Client class, note that connect() calls start() automatically.");return new Promise((e,n)=>{this._process=Re(this._serverParams.command,this._serverParams.args??[],{env:{...He(),...this._serverParams.env},stdio:["pipe","pipe",this._serverParams.stderr??"inherit"],shell:!1,windowsHide:N.platform==="win32",cwd:this._serverParams.cwd}),this._process.on("error",t=>{n(t),this.onerror?.(t)}),this._process.on("spawn",()=>{e()}),this._process.on("close",t=>{this._process=void 0,this.onclose?.()}),this._process.stdin?.on("error",t=>{this.onerror?.(t)}),this._process.stdout?.on("data",t=>{this._readBuffer.append(t),this.processReadBuffer()}),this._process.stdout?.on("error",t=>{this.onerror?.(t)}),this._stderrStream&&this._process.stderr&&this._process.stderr.pipe(this._stderrStream)})}get stderr(){return this._stderrStream?this._stderrStream:this._process?.stderr??null}get pid(){return this._process?.pid??null}processReadBuffer(){for(;;)try{const e=this._readBuffer.readMessage();if(e===null)break;this.onmessage?.(e)}catch(e){this.onerror?.(e)}}async close(){if(this._process){const e=this._process;this._process=void 0;const n=new Promise(t=>{e.once("close",()=>{t()})});try{e.stdin?.end()}catch{}if(await Promise.race([n,new Promise(t=>setTimeout(t,2e3).unref())]),e.exitCode===null){try{e.kill("SIGTERM")}catch{}await Promise.race([n,new Promise(t=>setTimeout(t,2e3).unref())])}if(e.exitCode===null)try{e.kill("SIGKILL")}catch{}}this._readBuffer.clear()}send(e){return new Promise(n=>{if(!this._process?.stdin)throw new Error("Not connected");const t=Ae(e);this._process.stdin.write(t)?n():this._process.stdin.once("drain",n)})}}var b,Be=(b=class extends ue{serverParams;errlog;_transport=null;constructor(e,n=process.stderr){super(),this.serverParams=e,this.errlog=n}async establishConnection(){return this._transport=new Fe(this.serverParams),this._transport.stderr&&typeof this._transport.stderr.pipe=="function"&&this._transport.stderr.pipe(this.errlog),S.debug(`${this.constructor.name} connected successfully`),this._transport}async closeConnection(e){if(this._transport)try{await this._transport.close()}catch(n){S.warn(`Error closing stdio transport: ${n}`)}finally{this._transport=null}}},J(b,"StdioConnectionManager"),b),C,Je=(C=class extends ce{command;args;env;errlog;clientInfo;constructor({command:e="npx",args:n=[],env:t,errlog:o=N.stderr,...s}={}){super(s),this.command=e,this.args=n,this.env=t,this.errlog=o,this.clientInfo=s.clientInfo??{name:"stdio-connector",version:"1.0.0"}}async connect(){if(this.connected){S.debug("Already connected to MCP implementation");return}S.debug(`Connecting to MCP implementation via stdio: ${this.command}`);try{let e;if(this.env){e={};for(const[s,r]of Object.entries(N.env))r!==void 0&&(e[s]=r);Object.assign(e,this.env)}const n={command:this.command,args:this.args,env:e};this.connectionManager=new Be(n,this.errlog);const t=await this.connectionManager.start(),o={...this.opts.clientOptions||{},capabilities:{...this.opts.clientOptions?.capabilities||{},roots:{listChanged:!0},...this.opts.onSampling??this.opts.samplingCallback?{sampling:{}}:{},...this.opts.onElicitation??this.opts.elicitationCallback?{elicitation:{form:{},url:{}}}:{}}};this.client=new ae(this.clientInfo,o),await this.client.connect(t),this.connected=!0,this.setupNotificationHandler(),this.setupRootsHandler(),this.setupSamplingHandler(),this.setupElicitationHandler(),S.debug(`Successfully connected to MCP implementation: ${this.command}`),this.trackConnectorInit({serverCommand:this.command,serverArgs:this.args,publicIdentifier:`${this.command} ${this.args.join(" ")}`})}catch(e){throw S.error(`Failed to connect to MCP implementation: ${e}`),await this.cleanupResources(),e}}get publicIdentifier(){return{type:"stdio","command&args":`${this.command} ${this.args.join(" ")}`}}},J(C,"StdioConnector"),C);export{Je as StdioConnector};
